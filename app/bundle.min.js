!function r(e,n,t){function o(i,f){if(!n[i]){if(!e[i]){var c="function"==typeof require&&require;if(!f&&c)return c(i,!0);if(u)return u(i,!0);var a=new Error("Cannot find module '"+i+"'");throw a.code="MODULE_NOT_FOUND",a}var p=n[i]={exports:{}};e[i][0].call(p.exports,(function(r){return o(e[i][1][r]||r)}),p,p.exports,r,e,n,t)}return n[i].exports}for(var u="function"==typeof require&&require,i=0;i<t.length;i++)o(t[i]);return o}({1:[function(require,module,exports){const{valueScope:valueScope}=require("./scope.js"),{tracker:tracker}=require("../parsing/errors.js"),{Expression:Expression,AssignExpression:AssignExpression,CallExpression:CallExpression,NameExpression:NameExpression,NumberExpression:NumberExpression,OperatorExpression:OperatorExpression,PrefixExpression:PrefixExpression}=require("../parsing/pratt/expressions.js"),{TokenType:TokenType}=require("../parsing/pratt/tokentype.js"),{complex:complex,Complex:Complex}=require("../math/complex.js");class Evaluatable{constructor(ast,args=null){this.ast=ast,this.args=null===args?[]:args}call(args){for(const arg of this.args)if(void 0===args[arg])return tracker.error(`function requires argument ${arg}`),null;try{return this._call(this.ast,args)}catch(error){return tracker.error(`An unrecognized error has occurred: ${error.message}`),null}}_call(ast,args=null){if(args=null===args?{}:args,ast instanceof OperatorExpression){const arg1=this._call(ast.mLeft,args),arg2=this._call(ast.mRight,args);switch(ast.mOperator){case TokenType.PLUS:return Complex.add(arg1,arg2);case TokenType.MINUS:return Complex.sub(arg1,arg2);case TokenType.ASTERISK:return Complex.mult(arg1,arg2);case TokenType.SLASH:return Complex.div(arg1,arg2);case TokenType.CARET:return Complex.pow(arg1,arg2);default:return tracker.error("unexpected operator encountered"),null}}else if(ast instanceof PrefixExpression){const arg1=this._call(ast.mRight,args);if(ast.mOperator===TokenType.MINUS)return arg1.scale(-1);tracker.error("unexpected prefix operator encountered")}else if(ast instanceof CallExpression){const functionArgs=ast.mArgs.map((arg=>this._call(arg,args)));if(void 0!==valueScope[ast.mFunction]){const func=valueScope[ast.mFunction];if(func instanceof Evaluatable){const argMap={};return func.args.forEach(((key,index)=>argMap[key]=functionArgs[index])),func.call(argMap)}return func(...functionArgs)}tracker.error(`could not resolve function ${ast.mFunction}. Note: higher order functions are not yet supported`)}else{if(ast instanceof NameExpression){if(void 0!==args[ast.mName])return args[ast.mName];if(void 0!==valueScope[ast.mName]){let value=valueScope[ast.mName];return value instanceof Evaluatable&&(value=value.call()),value}return tracker.error(`could not resolve variable ${ast.mName}`),null}if(ast instanceof NumberExpression)return complex(ast.mNumber,0);tracker.error("what is even going on")}}}module.exports={evaluate:function(ast){if(ast instanceof AssignExpression){const left=ast.mLeft;return left instanceof CallExpression?valueScope[left.mFunction.mName]=new Evaluatable(ast.mRight,left.mArgs.map((arg=>arg instanceof OperatorExpression?arg.mLeft.mName:arg.mName))):valueScope[left.mName]=new Evaluatable(ast.mRight),null}return new Evaluatable(ast)},Evaluatable:Evaluatable}},{"../math/complex.js":7,"../parsing/errors.js":15,"../parsing/pratt/expressions.js":18,"../parsing/pratt/tokentype.js":24,"./scope.js":4}],2:[function(require,module,exports){const{valueScope:valueScope,scope:scope}=require("./scope.js"),{tracker:tracker}=require("../parsing/errors.js"),{Expression:Expression,AssignExpression:AssignExpression,CallExpression:CallExpression,NameExpression:NameExpression,NumberExpression:NumberExpression,OperatorExpression:OperatorExpression,PrefixExpression:PrefixExpression}=require("../parsing/pratt/expressions.js"),{TokenType:TokenType}=require("../parsing/pratt/tokentype.js"),{Lexer:Lexer}=require("../parsing/pratt/lexer.js"),{complex:complex,Complex:Complex}=require("../math/complex.js"),{FunctionDefinition:FunctionDefinition,VariableDefinition:VariableDefinition,EvaluatableLine:EvaluatableLine}=require("./input_expressions.js"),{cleanLatex:cleanLatex}=require("../parsing/latex_convert.js");module.exports={classifyInput:function(fields){tracker.setCallback(((message,target)=>console.log(message)));const lexer=new Lexer(null,!0);lexer.setScope(scope);const inputExpressions={functions:[],variables:[],evaluatables:[]};for(const id in fields){const field=fields[id],latex=cleanLatex(field.field.latex());lexer.setText(latex),lexer.tokenize();const tokens=lexer.getTokens();latex.includes("=")?tokens[1]?.mtype===TokenType.LEFT_PAREN?inputExpressions.functions.push(new FunctionDefinition(tokens,id)):inputExpressions.variables.push(new VariableDefinition(tokens,id)):inputExpressions.evaluatables.push(new EvaluatableLine(tokens,id))}return console.log(inputExpressions),inputExpressions},validateLines:function(){}}},{"../math/complex.js":7,"../parsing/errors.js":15,"../parsing/latex_convert.js":16,"../parsing/pratt/expressions.js":18,"../parsing/pratt/lexer.js":19,"../parsing/pratt/tokentype.js":24,"./input_expressions.js":3,"./scope.js":4}],3:[function(require,module,exports){const{tracker:tracker}=require("../parsing/errors.js"),{Token:Token}=require("../parsing/pratt/token"),{TokenType:TokenType}=require("../parsing/pratt/tokentype.js"),{scope:scope}=require("./scope.js");class InputExpression{constructor(tokens,id){this.tokens=tokens,this.id=id,this.findRequirements(),this.readTokens()}findRequirements(){this.requirements=[]}readTokens(){}}module.exports={FunctionDefinition:class extends InputExpression{constructor(tokens,id){super(tokens,id)}findRequirements(){if(this.requirements=[],this.locals=[],this.tokens[0]?.mtype!==TokenType.NAME)return void tracker.error("Function definition does not begin with valid identifier");this.name=this.tokens[0].text;let assignmentEncountered=!1;for(const token of this.tokens.slice(1,this.tokens.length))token.mtype!==TokenType.ASSIGN?token.mtype===TokenType.NAME&&(assignmentEncountered?scope.builtin[token.text]||this.locals.includes(token.text)||this.requirements.push(token.text):scope.builtin[token.text]?.isType||this.locals.push(token.text)):assignmentEncountered=!0}readTokens(){this.arguments={arg1:"type1"},this.definition=null}},VariableDefinition:class extends InputExpression{constructor(tokens,id){super(tokens,id)}findRequirements(){this.tokens[0]?.mtype===TokenType.NAME?(this.name=this.tokens[0].text,this.requirements=this.tokens.slice(2,this.tokens.length).filter((token=>token.mtype===TokenType.NAME&&!scope.builtin[token.text])).map((token=>token.text))):tracker.error("Variable definition does not begin with valid identifier")}readTokens(){this.name=null,this.definition=null,this.sliderable=!1,this.type="type"}},EvaluatableLine:class extends InputExpression{constructor(tokens,id){super(tokens,id)}findRequirements(){this.requirements=this.tokens.filter((token=>token.mtype===TokenType.NAME&&!scope.builtin[token.text])).map((token=>token.text))}readTokens(){this.type=null,this.plottableType=null}}}},{"../parsing/errors.js":15,"../parsing/pratt/token":23,"../parsing/pratt/tokentype.js":24,"./scope.js":4}],4:[function(require,module,exports){const{complex:complex,Complex:Complex}=require("../math/complex.js"),defaultValueScope={z:complex(1,0),norm:z=>complex(z.norm(),0),normSq:z=>complex(z.normSq(),0),arg:z=>complex(z.arg(),0),inv:Complex.inv,exp:Complex.exp,ln:Complex.ln,sqrt:Complex.sqrt,sin:Complex.sin,cos:Complex.cos,tan:Complex.tan,acos:Complex.acos,asin:Complex.asin,atan:Complex.atan,sinh:Complex.sinh,cosh:Complex.cosh,tanh:Complex.tanh,re:z=>complex(z.re,0),im:z=>complex(z.im,0),Gamma:Complex.gamma,beta:Complex.beta,min:Complex.min,max:Complex.max,lerp:(z1,z2,t)=>Complex.mult(complex(1,0).sub(t),z1).add(z2.mult(t)),conj:z=>z.conj(),clamp:(z,min,max)=>Complex.clamp(z,min.norm(),max.norm()),frac:Complex.frac,i:complex(0,1),pi:complex(Math.PI,0),tau:complex(2*Math.PI,0),e:complex(Math.E,0),realBounds:complex(0,0),imagBounds:complex(0,0)};module.exports={scope:{builtin:{z:{isFunction:!1,shaderAlias:"z"},norm:{isFunction:!0,shaderAlias:"normC"},normSq:{isFunction:!0,shaderAlias:"normSqC"},arg:{isFunction:!0,shaderAlias:"argC"},inv:{isFunction:!0,shaderAlias:"invC"},exp:{isFunction:!0,shaderAlias:"expC"},ln:{isFunction:!0,shaderAlias:"lnC"},sqrt:{isFunction:!0,shaderAlias:"sqrtC"},sin:{isFunction:!0,shaderAlias:"sinC"},cos:{isFunction:!0,shaderAlias:"cosC"},tan:{isFunction:!0,shaderAlias:"tanC"},asin:{isFunction:!0,shaderAlias:"asinC"},acos:{isFunction:!0,shaderAlias:"acosC"},atan:{isFunction:!0,shaderAlias:"atanC"},sinh:{isFunction:!0,shaderAlias:"sinhC"},cosh:{isFunction:!0,shaderAlias:"coshC"},tanh:{isFunction:!0,shaderAlias:"tanhC"},re:{isFunction:!0,shaderAlias:"reC"},im:{isFunction:!0,shaderAlias:"imC"},Gamma:{isFunction:!0,shaderAlias:"GammaC"},beta:{isFunction:!0,shaderAlias:"betaC"},min:{isFunction:!0,shaderAlias:"minC"},max:{isFunction:!0,shaderAlias:"maxC"},lerp:{isFunction:!0,shaderAlias:"lerpC"},conj:{isFunction:!0,shaderAlias:"conjC"},clamp:{isFunction:!0,shaderAlias:"clampC"},frac:{isFunction:!0,shaderAlias:"fracC"},i:{isFunction:!1,shaderAlias:"i"},pi:{isFunction:!1,shaderAlias:"piC"},tau:{isFunction:!1,shaderAlias:"tpiC"},e:{isFunction:!1,shaderAlias:"e"},realBounds:{isFunction:!1,shaderAlias:"xBounds"},imagBounds:{isFunction:!1,shaderAlias:"yBounds"},complex:{isFunction:!1,isType:!0},array:{isFunction:!1,isType:!0},matrix:{isFunction:!1,isType:!0},function:{isFunction:!1,isType:!0}},userGlobal:{}},defaultValueScope:defaultValueScope,valueScope:{}}},{"../math/complex.js":7}],5:[function(require,module,exports){const{cleanLatex:cleanLatex}=require("../parsing/latex_convert.js"),{tracker:tracker}=require("../parsing/errors.js"),{TokenType:TokenType}=require("../parsing/pratt/tokentype.js"),{Expression:Expression,AssignExpression:AssignExpression,CallExpression:CallExpression,NameExpression:NameExpression,NumberExpression:NumberExpression,OperatorExpression:OperatorExpression,PrefixExpression:PrefixExpression}=require("../parsing/pratt/expressions.js"),{Lexer:Lexer}=require("../parsing/pratt/lexer.js"),{ExpressionParser:ExpressionParser}=require("../parsing/pratt/expression_parser.js"),{Complex:Complex,complex:complex}=require("../math/complex.js"),{Matrix:Matrix,matrix:matrix}=require("../math/matrix.js"),{Euclid:Euclid,Poincare:Poincare}=require("../math/geometry.js"),{parameterizePoints:parameterizePoints,fourierCoefficients:fourierCoefficients,fourierSeries:fourierSeries}=require("../math/fourier.js"),{sscale:sscale,ssub:ssub,icosphere:icosphere,icosphere_flat:icosphere_flat,icosphere_flat_lopsided:icosphere_flat_lopsided}=require("../math/icosphere.js"),{stereographic:stereographic,inverseStereoProject:inverseStereoProject,perspectiveProject:perspectiveProject}=require("../math/projection.js"),{rvec:rvec}=require("../math/rvector.js"),{scope:scope,defaultValueScope:defaultValueScope,valueScope:valueScope}=require("./scope.js"),{evaluate:evaluate}=require("./evaluator.js"),{translateToGLSL:translateToGLSL}=require("./translator.js"),{classifyInput:classifyInput}=require("./expression_processor.js");p5.disableFriendlyErrors=!0,window.plot=void 0,window.lastMouseX=void 0,window.lastMouseY=void 0,window.mouseIsDown=!1;let RENDERER="WebGL";const pValueArray=[.9999999999998099,676.5203681218851,-1259.1392167224028,771.3234287776531,-176.6150291621406,12.507343278686905,-.13857109526572012,9984369578019572e-21,1.5056327351493116e-7],MQ=MathQuill.getInterface(2),opsString=Object.keys(scope.builtin).filter((x=>x.length>1)).join(" "),fields={},menuHTML=(id,error=null)=>{let imageSrc,displayText;return null===error?(imageSrc="http://localhost:8000/data/settings_transparent.png",displayText="Settings"):(imageSrc="http://localhost:8000/data/error_transparent.png",displayText=error),`<div>${id}</div>\n    <div style="display:flex;">\n        <img src="${imageSrc}" style="width:25px;height:25px;" onclick="displayOverlayMenu(${id});" title="${displayText}"></img>\n    </div>`};function addField(parent=null){const newDiv=document.createElement("div");newDiv.setAttribute("class","math-input-div");const newSpan=document.createElement("span");newSpan.setAttribute("class","math-input");const newField=MQ.MathField(newSpan,{});newDiv.setAttribute("id",`math-input-div-${newField.id}`);const newMenu=document.createElement("div");if(newMenu.setAttribute("class","math-input-side-menu"),newMenu.setAttribute("id",`math-input-side-menu-${newField.id}`),newMenu.innerHTML=menuHTML(newField.id),newDiv.appendChild(newMenu),newDiv.appendChild(newSpan),null===parent){document.querySelector("#math-input-container").appendChild(newDiv),fields[newField.id]={id:newField.id,field:newField,last:null,next:null,container:newDiv}}else{document.querySelector(`#math-input-div-${parent.id}`).after(newDiv),fields[newField.id]={id:newField.id,field:newField,last:parent.field,next:parent.next,container:newDiv},fields[parent.field.id].next=newField,advance(parent.field.id,1)}return newField.id}function deleteField(id,preserve=!0){if(preserve&&1===Object.keys(fields).length)return;const entry=fields[id];null!==entry.next?null!==entry.last?(fields[entry.next.id].last=entry.last,fields[entry.last.id].next=entry.next):fields[entry.next.id].last=null:null!==entry.last&&(fields[entry.last.id].next=null),preserve&&advance(id,null===entry.last?1:-1),entry.container.parentNode.removeChild(entry.container),delete fields[id]}function advance(id,direction){const entry=fields[id];-1===direction&&null!==entry.last?(entry.last.focus(),entry.last.moveToRightEnd()):1===direction&&(null!==entry.next?(entry.next.focus(),entry.next.moveToRightEnd()):addField(entry))}function debounceWrapper(func,interval){let timer;return function(){const context=this,args=arguments;clearTimeout(timer),timer=setTimeout((()=>func.apply(context,args)),interval)}}document.addEventListener("mousedown",(event=>{const overlay=document.querySelector("#overlay-menu-container");overlay.contains(event.target)||(overlay.style.display="none")}));const firstField=addField();fields[firstField].field.focus(),MQ.config({autoCommands:"pi sqrt tau alpha beta Gamma",supSubsRequireOperand:!0,charsThatBreakOutOfSupSub:"",autoOperatorNames:opsString,handlers:{enter:mathField=>{advance(mathField.id,1)},downOutOf:mathField=>{advance(mathField.id,1)},upOutOf:mathField=>{advance(mathField.id,-1)},deleteOutOf:(direction,mathField)=>{direction===MQ.L&&deleteField(mathField.id)},edit:debounceWrapper((function(mathField){classifyInput(fields)}),500)}});class Plot{static modes={PLANE:1,SPHERE:2,CUBE:3};constructor(displayWidth,displayHeight,bounds=null,mode=null,displayWindowInfo,reglInstance=null,shaders=null){this.gridlineSpacing=1,this.boundsChangedSinceLastDraw=!1,this.displayWindowInfo=displayWindowInfo,this.configureWindow(displayWidth,displayHeight,bounds,null===bounds),this.plottables=[],this.polygons=[],this.reglInstance=reglInstance,this.shaders=shaders,this.needsUpdate=!0,this.mode=null===mode?Plot.modes.PLANE:mode,this.camera={alpha:1,beta:0,pitch:.786,roll:0,yaw:.672},this.calculateRotationMatrix(),this.planeMesh=this.generatePlaneMesh(100),this.sphereMesh=icosphere_flat(5)}configureWindow(newWidth=null,newHeight=null,bounds=null){let widthRatio,heightRatio;null===newWidth?(widthRatio=1,heightRatio=1,newWidth=this.dimensions.re,newHeight=this.dimensions.im):void 0===this.dimensions?(widthRatio=1,heightRatio=1):(widthRatio=this.dimensions.re/newWidth,heightRatio=this.dimensions.im/newHeight),this.dimensions=complex(newWidth,newHeight),this.aspect=newHeight/newWidth,this.halfDimensions=this.dimensions.scale(.5);let fitToSquare=!1;if(null===bounds)if(void 0===this.bounds)bounds={xMin:-4,xMax:4,yMin:-4,yMax:4},fitToSquare=!0;else{const centerX=(this.bounds.xMin+this.bounds.xMax)/2,centerY=(this.bounds.yMin+this.bounds.yMax)/2,halfRangeX=this.units.re*heightRatio/2,halfRangeY=this.units.im*widthRatio/2;bounds={xMin:centerX-halfRangeX,xMax:centerX+halfRangeX,yMin:centerY-halfRangeY,yMax:centerY+halfRangeY}}this.bounds=bounds,this.offset=complex((this.bounds.xMax+this.bounds.xMin)/2,(this.bounds.yMax+this.bounds.yMin)/2),this.units=complex(this.bounds.xMax-this.bounds.xMin,this.bounds.yMax-this.bounds.yMin),this.pixelsPerUnit=complex(this.dimensions.re/this.units.re,this.dimensions.im/this.units.im),this.gridlineCount=complex(this.units.re/this.gridlineSpacing,this.units.im/this.gridlineSpacing),fitToSquare&&this.fitBoundsToSquare(),valueScope.realBounds=complex(this.bounds.xMin,this.bounds.xMax),valueScope.imagBounds=complex(this.bounds.yMin,this.bounds.yMax),this.needsUpdate=!0,this.boundsChangedSinceLastDraw=!0,this.displayWindowInfo&&(console.log("Window configuration"),console.log("window bounds",this.bounds),console.log("offset",this.offset),console.log("window size",this.dimensions),console.log("gridline count",this.gridlineCount))}fitBoundsToSquare(){const centerY=(this.bounds.yMin+this.bounds.yMax)/2,halfRangeY=this.units.re*this.aspect/2;this.configureWindow(this.dimensions.re,this.dimensions.im,{xMin:this.bounds.xMin,xMax:this.bounds.xMax,yMin:centerY-halfRangeY,yMax:centerY+halfRangeY})}setCamera(camera){this.camera.alpha=void 0===camera.alpha?this.camera.alpha:camera.alpha,this.camera.beta=void 0===camera.beta?this.camera.beta:camera.beta,this.camera.pitch=void 0===camera.pitch?this.camera.pitch:camera.pitch,this.camera.yaw=void 0===camera.yaw?this.camera.yaw:camera.yaw,this.camera.roll=void 0===camera.roll?this.camera.roll:camera.roll,this.needsUpdate=!0}pan(offset){this.mode===Plot.modes.PLANE?this.configureWindow(null,null,{xMin:this.bounds.xMin+offset.re,xMax:this.bounds.xMax+offset.re,yMin:this.bounds.yMin+offset.im,yMax:this.bounds.yMax+offset.im}):this.setCamera({pitch:Math.max(Math.min(this.camera.pitch+offset.im,.5*Math.PI),-.5*Math.PI),yaw:Math.max(Math.min(this.camera.yaw-offset.re,Math.PI),-Math.PI)})}zoom(factor){const newHalfUnits=this.units.scale(factor/2),center=complex((this.bounds.xMin+this.bounds.xMax)/2,(this.bounds.yMin+this.bounds.yMax)/2);this.configureWindow(null,null,{xMin:center.re-newHalfUnits.re,xMax:center.re+newHalfUnits.re,yMin:center.im-newHalfUnits.im,yMax:center.im+newHalfUnits.im})}state(){const latex=[];for(const id of Object.keys(fields))fields[id].latex&&latex.push(fields[id].latex);return JSON.stringify({camera:this.camera,bounds:this.bounds,expressions:latex,mode:this.mode},null,4)}loadState(state){state=JSON.parse(state),this.setCamera(state.camera),this.configureWindow(null,null,state.bounds),tabSwitch(state.mode-1);for(const id of Object.keys(fields))deleteField(id,!1);for(const expr of state.expressions){const newField=addField(null);fields[newField].field.latex(expr)}}downloadState(){const state=encodeURIComponent(this.state()),tempEl=document.createElement("a");tempEl.setAttribute("href",`data:text/json;charset=utf-8,${state}`),tempEl.setAttribute("download","plot.json"),document.body.appendChild(tempEl),tempEl.click(),tempEl.remove()}uploadState(){const tempEl=document.createElement("input");tempEl.setAttribute("type","file"),tempEl.setAttribute("accept",".json"),tempEl.setAttribute("id","file-selector"),document.body.appendChild(tempEl),tempEl.click(),tempEl.onchange=()=>{const selector=document.querySelector("#file-selector"),files=selector.files;if(files.length<=0)return;const reader=new FileReader;reader.onload=event=>{this.loadState(event.target.result)},reader.readAsText(files.item(0)),selector.parentNode.removeChild(selector)}}unitsToPixels(z){return complex((z.re-this.offset.re)*this.pixelsPerUnit.re+this.halfDimensions.re,-(z.im-this.offset.im)*this.pixelsPerUnit.im+this.halfDimensions.im)}applyCamera(z){return this.mode===Plot.modes.SPHERE?(z=z instanceof Complex?inverseStereoProject(z):matrix(z).transpose(),Matrix.multiply(this.rotationMatrix,z)):this.mode===Plot.modes.CUBE?(z=z instanceof Complex?matrix([z.re,z.im,0]).transpose():matrix(z).transpose(),Matrix.multiply(this.rotationMatrix,z)):z}coordinateTransform(z){return this.mode!==Plot.modes.PLANE&&(z=perspectiveProject(z,this.camera.alpha,this.camera.beta)),this.unitsToPixels(z)}spaceToScreen(z){return this.coordinateTransform(this.applyCamera(z))}pixelsToUnits(z){return complex(z.re/this.pixelsPerUnit.re,-z.im/this.pixelsPerUnit.im)}setMode(mode){const previousMode=this.mode;this.mode=mode,mode===Plot.modes.PLANE?void 0!==this.savedBounds&&this.configureWindow(null,null,this.savedBounds):(previousMode===Plot.modes.PLANE&&(this.savedBounds=this.bounds),this.configureWindow(null,null,{xMin:-2.5,xMax:2.5,yMin:-1.5,yMax:1.5}),this.fitBoundsToSquare()),this.boundsChangedSinceLastDraw=!0,this.needsUpdate=!0}calculateRotationMatrix(){this.rotationMatrix=Matrix.rotationMatrix3D(this.camera.pitch,this.camera.roll,this.camera.yaw)}clear(){this.plottables=[],this.needsUpdate=!0}addPlottable(plottable){this.plottables.push(plottable),this.needsUpdate=!0}drawAxes(){if(this.mode===Plot.modes.PLANE){const xAxisStart=this.spaceToScreen(complex(this.bounds.xMin,0)),xAxisStop=this.spaceToScreen(complex(this.bounds.xMax,0)),yAxisStart=this.spaceToScreen(complex(0,this.bounds.yMin)),yAxisStop=this.spaceToScreen(complex(0,this.bounds.yMax));push(),stroke(0),strokeWeight(1),line(xAxisStart.re,xAxisStart.im,xAxisStop.re,xAxisStop.im),line(yAxisStart.re,yAxisStart.im,yAxisStop.re,yAxisStop.im),pop()}}drawGridlines(){const minBound=x=>floor(x/this.gridlineSpacing)*this.gridlineSpacing,minBoundX=minBound(this.bounds.xMin),minBoundY=minBound(this.bounds.yMin);push(),stroke(200),strokeWeight(1);for(let i=0;i<this.gridlineCount.im+1;i++){const y=minBoundY+i*this.gridlineSpacing,start=this.unitsToPixels(complex(this.bounds.xMin,y)),end=this.unitsToPixels(complex(this.bounds.xMax,y));line(start.re,start.im,end.re,end.im)}for(let i=0;i<this.gridlineCount.re+1;i++){const x=minBoundX+i*this.gridlineSpacing,start=this.unitsToPixels(complex(x,this.bounds.yMin)),end=this.unitsToPixels(complex(x,this.bounds.yMax));line(start.re,start.im,end.re,end.im)}pop()}draw(){background(255),this.drawGridlines(),this.drawAxes(),this.polygons=[];for(let plottable of this.plottables)plottable.update(),this.polygons=this.polygons.concat(plottable.getPolygons());this.mode!==Plot.modes.PLANE&&this.polygons.sort(((poly1,poly2)=>this.applyCamera(poly2.centroid).get(1,0)-this.applyCamera(poly1.centroid).get(1,0))),push();for(let poly of this.polygons)if(1===poly.vertices.length){fill(0),noStroke();const point=this.coordinateTransform(this.applyCamera(poly.vertices[0]));circle(point.re,point.im,1)}else if(2===poly.vertices.length){stroke(0);const point1=this.coordinateTransform(this.applyCamera(poly.vertices[0])),point2=this.coordinateTransform(this.applyCamera(poly.vertices[1]));line(point1.re,point1.im,point2.re,point2.im)}else{poly.outline?stroke(0):noStroke(),fill(poly.fillColor),beginShape();for(let vert of poly.vertices){const point=this.coordinateTransform(this.applyCamera(vert));vertex(point.re,point.im)}endShape(CLOSE)}pop(),this.boundsChangedSinceLastDraw=!1}generatePlaneMesh(count){let x=-1,y=-1;const step=2/count,verts=[],sqrt2=Math.sqrt(2);for(let i=0;i<count;i++){for(let j=0;j<count;j++){const nextX=x+step,nextY=y+step;verts.push([x/sqrt2,y/sqrt2,0]),verts.push([nextX/sqrt2,y/sqrt2,0]),verts.push([x/sqrt2,nextY/sqrt2,0]),verts.push([nextX/sqrt2,y/sqrt2,0]),verts.push([nextX/sqrt2,nextY/sqrt2,0]),verts.push([x/sqrt2,nextY/sqrt2,0]),x+=step}x=-1,y+=step}return verts}drawFnPlane(){const emittedGLSL=translateToGLSL(fields);let frag=this.shaders["complexmos.frag"];return emittedGLSL.valid&&(frag=frag.replace(/\/\/REPLACE_BEGIN.*\/\/REPLACE_END/ms,emittedGLSL.glsl)),this.reglInstance({frag:frag,vert:this.shaders["complexmos.vert"],attributes:{position:[[-1,-1],[1,1],[-1,1],[-1,-1],[1,1],[1,-1]]},uniforms:{width:this.reglInstance.context("viewportWidth"),height:this.reglInstance.context("viewportHeight"),xBounds:[this.bounds.xMin,this.bounds.xMax],yBounds:[this.bounds.yMin,this.bounds.yMax],pValues:pValueArray,texture:this.reglInstance.texture(this.shaders["sample texture"])},count:6})}drawFnSphere(){const mesh=this.sphereMesh,vertexCount=mesh.length,emittedGLSL=translateToGLSL(fields);let frag=this.shaders["complexmos_sphere.frag"];return emittedGLSL.valid&&(frag=frag.replace(/\/\/REPLACE_BEGIN.*\/\/REPLACE_END/ms,emittedGLSL.glsl)),this.reglInstance({frag:frag,vert:this.shaders["complexmos_sphere.vert"],attributes:{position:mesh},uniforms:{width:this.reglInstance.context("viewportWidth"),height:this.reglInstance.context("viewportHeight"),xBounds:[this.bounds.xMin,this.bounds.xMax],yBounds:[this.bounds.yMin,this.bounds.yMax],pValues:pValueArray,alpha:this.camera.alpha,beta:this.camera.beta,row1:this.rotationMatrix.getRow(0),row2:this.rotationMatrix.getRow(1),row3:this.rotationMatrix.getRow(2)},count:vertexCount,cull:{enable:!0,face:"back"},frontFace:"cw"})}drawFn3D(){const mesh=this.planeMesh,vertexCount=mesh.length;console.log(vertexCount/3);const emittedGLSL=translateToGLSL(fields);let frag=this.shaders["complexmos_cube.frag"],vert=this.shaders["complexmos_cube.vert"];return emittedGLSL.valid&&(frag=frag.replace(/\/\/REPLACE_BEGIN.*\/\/REPLACE_END/ms,emittedGLSL.glsl),vert=vert.replace(/\/\/REPLACE_BEGIN.*\/\/REPLACE_END/ms,emittedGLSL.glsl)),this.reglInstance({frag:frag,vert:vert,attributes:{position:mesh},uniforms:{width:this.reglInstance.context("viewportWidth"),height:this.reglInstance.context("viewportHeight"),xBounds:[this.bounds.xMin,this.bounds.xMax],yBounds:[this.bounds.yMin,this.bounds.yMax],pValues:pValueArray,alpha:this.camera.alpha,beta:this.camera.beta,row1:this.rotationMatrix.getRow(0),row2:this.rotationMatrix.getRow(1),row3:this.rotationMatrix.getRow(2)},cull:{enable:!1},frontFace:"ccw",count:vertexCount})}update(){if(this.needsUpdate){if(this.mode!==Plot.modes.PLANE&&this.calculateRotationMatrix(),"p5"===RENDERER)this.draw();else{let drawFn;drawFn=this.mode===Plot.modes.PLANE?this.drawFnPlane():this.mode===Plot.modes.SPHERE?this.drawFnSphere():this.drawFn3D(),drawFn()}this.needsUpdate=!1}}}let cImage;async function loadImage(src){return new Promise(((resolve,reject)=>{let image=new Image;image.src=src,image.onerror=reject,image.onload=resolve(image)}))}function setupP5(){const canvasDiv=document.querySelector("#canvas-div");canvasDiv.innerHTML="";createCanvas(canvasDiv.offsetWidth,canvasDiv.offsetHeight).parent("canvas-div"),canvasDiv.onwheel=wheelHandler,plot=new Plot(width,height,null,Plot.modes.PLANE,!1),tabSwitch(plot.mode-1)}function setupWebGL(){(async function(){const frag=await fetch("http://localhost:8000/shaders/complexmos.frag"),vert=await fetch("http://localhost:8000/shaders/complexmos.vert"),fragSphere=await fetch("http://localhost:8000/shaders/complexmos_sphere.frag"),vertSphere=await fetch("http://localhost:8000/shaders/complexmos_sphere.vert"),fragCube=await fetch("http://localhost:8000/shaders/complexmos_cube.frag"),vertCube=await fetch("http://localhost:8000/shaders/complexmos_cube.vert"),complexLib=await fetch("http://localhost:8000/shaders/complex.frag"),sampleImage=await loadImage("http://localhost:8000/data/cat.jpg"),complexLibSource=await complexLib.text().then((text=>text)),importLib=fileContents=>fileContents.replace(/\/\/IMPORT_COMPLEX/,complexLibSource),fragShaderSource=await frag.text().then(importLib),vertShaderSource=await vert.text().then((text=>text)),fragCubeShaderSource=await fragCube.text().then(importLib),vertCubeShaderSource=await vertCube.text().then(importLib);return{"complexmos.frag":fragShaderSource,"complexmos.vert":vertShaderSource,"complexmos_sphere.frag":await fragSphere.text().then(importLib),"complexmos_sphere.vert":await vertSphere.text().then((text=>text)),"complexmos_cube.frag":fragCubeShaderSource,"complexmos_cube.vert":vertCubeShaderSource,"sample texture":sampleImage}})().then((shaders=>{document.querySelector("#canvas-div").innerHTML="",require("regl")({container:"#canvas-div",onDone:(err,regl)=>{if(err)return console.warn(`Could not load WebGL! Maybe your browser doesn't support it? Using vanilla canvas instead. Specific error: ${err}`),RENDERER="p5",void setupP5();console.log("regl loaded!");const canvasDiv=document.querySelector("#canvas-div");plot=new Plot(canvasDiv.offsetWidth,canvasDiv.offsetHeight,null,Plot.modes.SPHERE,!1,regl,shaders),tabSwitch(plot.mode-1)}})}))}function wheelHandler(event){event.preventDefault();const factor=1+Math.tanh(event.deltaY/100)/4;plot.zoom(factor)}function mouseDragged(event){if(mouseIsDown){const rect=event.target.getBoundingClientRect(),mouseX=event.clientX-rect.left,mouseY=event.clientY-rect.top,canvasDiv=document.querySelector("#canvas-div");if(0<=mouseX&&mouseX<=canvasDiv.offsetWidth&&0<=mouseY&&mouseY<=canvasDiv.offsetHeight){const diff=complex(lastMouseX-mouseX,lastMouseY-mouseY);plot.mode===Plot.modes.PLANE?plot.pan(plot.pixelsToUnits(diff)):plot.pan(diff.eMult(complex(3/canvasDiv.clientWidth,-3/canvasDiv.clientHeight))),lastMouseX=mouseX,lastMouseY=mouseY}}}function mousePressed(event){const rect=event.target.getBoundingClientRect(),mouseX=event.clientX-rect.left,mouseY=event.clientY-rect.top;lastMouseX=mouseX,lastMouseY=mouseY,mouseIsDown=!0}function mouseReleased(event){lastMouseX=0,lastMouseY=0,mouseIsDown=!1}function tabSwitch(tab){const plane=document.querySelector("#ui-header-plane"),sphere=document.querySelector("#ui-header-sphere"),cube=document.querySelector("#ui-header-cube");0===tab?(plane.style.backgroundColor="white",sphere.style.backgroundColor="lightgray",cube.style.backgroundColor="lightgray",plot.setMode(Plot.modes.PLANE)):1===tab?(plane.style.backgroundColor="lightgray",sphere.style.backgroundColor="white",cube.style.backgroundColor="lightgray",plot.setMode(Plot.modes.SPHERE)):(plane.style.backgroundColor="lightgray",sphere.style.backgroundColor="lightgray",cube.style.backgroundColor="white",plot.setMode(Plot.modes.CUBE))}window.preload=function(){cImage=loadImage("http://localhost:8000/data/grid_3.png")},window.setup=function(){"p5"===RENDERER?setupP5():setupWebGL(),function(){const canvasDiv=document.querySelector("#canvas-div");canvasDiv.addEventListener("wheel",wheelHandler),canvasDiv.addEventListener("mousemove",mouseDragged),canvasDiv.addEventListener("touchmove",mouseDragged),document.addEventListener("mousedown",mousePressed),document.addEventListener("touchstart",mousePressed),document.addEventListener("mouseup",mouseReleased),document.addEventListener("touchend",mouseReleased)}()},window.displayOverlayMenu=function(id){const overlay=document.querySelector("#overlay-menu-container");overlay.style.display="block",overlay.innerHTML=`\n    Settings for expression ${id}\n    <hr>\n    `},window.tabSwitch=tabSwitch,window.draw=function(){plot&&plot.update()},window.addEventListener("resize",debounceWrapper((function(){const canvasDiv=document.querySelector("#canvas-div");plot.configureWindow(canvasDiv.offsetWidth,canvasDiv.offsetHeight)}),100)),window.toggleSettingsPopup=function(){const popup=document.querySelector("#settings-popup");"flex"!==popup.style.display?popup.style.display="flex":popup.style.display="none"},window.setRenderer=function(){const renderer=document.querySelector("#webgl-toggle").checked;"WebGL"!==RENDERER||renderer?"p5"===RENDERER&&renderer&&(RENDERER="WebGL",setupWebGL()):(RENDERER="p5",setupP5())}},{"../math/complex.js":7,"../math/fourier.js":8,"../math/geometry.js":9,"../math/icosphere.js":10,"../math/matrix.js":11,"../math/projection.js":12,"../math/rvector.js":13,"../parsing/errors.js":15,"../parsing/latex_convert.js":16,"../parsing/pratt/expression_parser.js":17,"../parsing/pratt/expressions.js":18,"../parsing/pratt/lexer.js":19,"../parsing/pratt/tokentype.js":24,"./evaluator.js":1,"./expression_processor.js":2,"./scope.js":4,"./translator.js":6,regl:14}],6:[function(require,module,exports){const{Lexer:Lexer}=require("../parsing/pratt/lexer.js"),{ExpressionParser:ExpressionParser}=require("../parsing/pratt/expression_parser.js"),{scope:scope}=require("./scope.js"),{tracker:tracker}=require("../parsing/errors.js"),{cleanLatex:cleanLatex}=require("../parsing/latex_convert.js"),{TokenType:TokenType}=require("../parsing/pratt/tokentype.js"),{Expression:Expression,AssignExpression:AssignExpression,CallExpression:CallExpression,NameExpression:NameExpression,NumberExpression:NumberExpression,OperatorExpression:OperatorExpression,PrefixExpression:PrefixExpression}=require("../parsing/pratt/expressions.js");let newVars=[];function astToGLSL(ast){if(ast instanceof OperatorExpression){const arg1=ast.mLeft,arg2=ast.mRight;switch(ast.mOperator){case TokenType.PLUS:return`addC(${astToGLSL(arg1)}, ${astToGLSL(arg2)})`;case TokenType.MINUS:return`subC(${astToGLSL(arg1)}, ${astToGLSL(arg2)})`;case TokenType.ASTERISK:return`multC(${astToGLSL(arg1)}, ${astToGLSL(arg2)})`;case TokenType.SLASH:return`divC(${astToGLSL(arg1)}, ${astToGLSL(arg2)})`;case TokenType.CARET:return`powC(${astToGLSL(arg1)}, ${astToGLSL(arg2)})`}}else{if(ast instanceof PrefixExpression)return`-${astToGLSL(ast.mRight)}`;if(ast instanceof CallExpression)return`${ast.mFunction}(${ast.mArgs.map(astToGLSL).join(",")})`;if(ast instanceof NameExpression)return"udf_"===ast.mName.slice(0,4)&&newVars.includes(ast.mName)?`${ast.mName}()`:ast.mName;if(ast instanceof NumberExpression)return`vec2(${ast.toString()}, 0.)`}}module.exports={translateToGLSL:function(fields){newVars=[];const expressions=[];scope.userGlobal={},tracker.clear(),tracker.setCallback(((message,target)=>console.log(message)));for(const id of Object.keys(fields)){const latex=cleanLatex(fields[id].field.latex());latex.includes("=")&&expressions.push(latex)}let tokenArrays=[];const lexer=new Lexer(null,!0);lexer.setScope(scope);for(const expr of expressions){lexer.setText(expr),lexer.tokenize();const tokens=lexer.getTokens(),originalName=tokens[0].text;for(const token of tokens)token.mtype===TokenType.NAME&&(scope.builtin[token.text]?.shaderAlias?token.text=scope.builtin[token.text].shaderAlias:token.text="udf_"+token.text);tokenArrays.push({name:tokens[0].text,tokens:tokens,dependencies:(L=tokens.filter((token=>token.mtype===TokenType.NAME)),L.slice(1,L.length)).map((token=>token.text))}),newVars.push(tokens[0].text),scope.userGlobal[originalName]={isFunction:"("===tokens[1].text}}var L;lexer.setAllowUnboundIdentifiers(!1),lexer.setScope(scope);for(const expr of expressions)lexer.setText(expr),lexer.tokenize();if(tracker.hasError&&tracker.message.includes("Undefined"))return{glsl:"",valid:!1};tracker.clear(),tokenArrays=tokenArrays.sort(((a,b)=>{const aDependsOnB=a.dependencies.includes(b.name),bDependsOnA=b.dependencies.includes(a.name);if(!aDependsOnB||!bDependsOnA)return aDependsOnB?1:bDependsOnA?-1:0;tracker.error("circular definitions")}));let glslString="";for(const tokenArray of tokenArrays){const parser=new ExpressionParser(tokenArray.tokens);if(tokenArray.ast=parser.parseExpression(),tracker.hasError)return{glsl:"",valid:!1};if(tokenArray.ast.mLeft instanceof CallExpression){const args=[];for(const arg of tokenArray.ast.mLeft.mArgs)arg instanceof OperatorExpression?args.push("vec2 "+arg.mLeft.mName):args.push("vec2 "+arg.mName);const functionBody=astToGLSL(tokenArray.ast.mRight);glslString+=`vec2 ${tokenArray.ast.mLeft.mFunction}(${args.join(",")}) {\n\treturn ${functionBody};\n}\n\n`}else{const definitionBody=astToGLSL(tokenArray.ast.mRight);glslString+=`vec2 ${tokenArray.ast.mLeft.mName}() {\n\treturn ${definitionBody};\n}\n\n`}}return tokenArrays.some((tokenArr=>{const left=tokenArr.ast.mLeft;if(!(left instanceof CallExpression))return!1;if("udf_f"!==left.mFunction.mName)return!1;if(1!==left.mArgs.length)return!1;const arg=left.mArgs[0];return arg instanceof OperatorExpression?"z"===arg.mLeft.mName:"z"===arg.mName}))&&!tracker.hasError?{glsl:glslString,valid:!0}:{glsl:"",valid:!1}}}},{"../parsing/errors.js":15,"../parsing/latex_convert.js":16,"../parsing/pratt/expression_parser.js":17,"../parsing/pratt/expressions.js":18,"../parsing/pratt/lexer.js":19,"../parsing/pratt/tokentype.js":24,"./scope.js":4}],7:[function(require,module,exports){const pValues=[.9999999999998099,676.5203681218851,-1259.1392167224028,771.3234287776531,-176.6150291621406,12.507343278686905,-.13857109526572012,9984369578019572e-21,1.5056327351493116e-7],frac=x=>x-(x>0?Math.floor(x):Math.ceil(x));class Complex{constructor(real,imaginary){this.re=real,this.im=imaginary}conj(){return new Complex(this.re,-this.im)}norm(){return Math.sqrt(this.re*this.re+this.im*this.im)}normSq(){return this.re*this.re+this.im*this.im}arg(){return(Math.atan2(this.im,this.re)+2*Math.PI)%(2*Math.PI)}unit(){return this.scale(1/this.norm())}scale(k){return new Complex(this.re*k,this.im*k)}add(z){return new Complex(this.re+z.re,this.im+z.im)}sub(z){return new Complex(this.re-z.re,this.im-z.im)}mult(z){return new Complex(this.re*z.re-this.im*z.im,this.re*z.im+this.im*z.re)}eMult(z){return new Complex(this.re*z.re,this.im*z.im)}inv(){return this.conj().scale(1/this.normSq())}div(z){return this.mult(z.inv())}perp(){return new Complex(-this.im,this.re)}sqrt(){const normSqrt=Math.sqrt(this.norm()),halfArg=.5*this.arg();return new Complex(normSqrt*Math.cos(halfArg),normSqrt*Math.sin(halfArg))}square(){return new Complex(this.re*this.re-this.im*this.im,2*this.re*this.im)}exp(){const mag=Math.exp(this.re);return new Complex(mag*Math.cos(this.im),mag*Math.sin(this.im))}ln(){return new Complex(Math.log(this.norm()),this.arg())}acos(){return this.add(this.square().sub(new Complex(1,0)).sqrt()).ln().div(complex(0,1))}asin(){const i=complex(0,1);return this.mult(i).add(complex(1,0).sub(this.square()).sqrt()).ln().div(i)}atan(){const i=complex(0,1);return Complex.div(Complex.div(i.sub(this),i.add(this)).ln(),i.scale(2))}rotate(angle){return this.mult(new Complex(0,angle).exp())}dot(z){return this.re*z.re+this.im*z.im}angleTo(z){return Math.acos(this.dot(z)/(this.norm()*z.norm()))}toString(){return`(${this.re},${this.im})`}toLatex(){return`\\left(${roundTo(this.re,3)},${roundTo(this.im,3)}\\right)`}equals(z){return this.re==z.re&&this.im==z.im}equalsEps(z){return Math.abs(this.re-z.re)<1e-6&&Math.abs(this.im-z.im)<1e-6}mobius(a,b,c,d){if(Complex.infinite(this))return 0!==c?Complex.div(a,c):new Complex(1/0,1/0);{const denominator=Complex.add(Complex.mult(c,this),d);if(0===denominator)return new Complex(1/0,1/0);{const numerator=Complex.add(Complex.mult(a,this),b);return Complex.div(numerator,denominator)}}}sin(){const i=complex(0,1),rotated=this.mult(i);return rotated.exp().sub(rotated.scale(-1).exp()).div(i.scale(2))}cos(){const i=complex(0,1),rotated=this.mult(i);return rotated.exp().add(rotated.scale(-1).exp()).scale(.5)}tan(){return this.sin().div(this.cos())}sinh(){return this.exp().sub(this.scale(-1).exp()).scale(.5)}cosh(){return this.exp().add(this.scale(-1).exp()).scale(.5)}tanh(){return this.sinh().div(this.cosh())}pow(z){if(this.equalsEps(complex(0,0)))return z.equalsEps(complex(1,0))?complex(1,0):complex(0,0);const subAng=Math.atan2(this.im,this.re),normSq=this.normSq(),ang=.5*z.im*Math.log(normSq)+z.re*subAng,norm=Math.exp(-z.im*subAng)*Math.pow(normSq,.5*z.re);return complex(norm*Math.cos(ang),norm*Math.sin(ang))}clamp(min,max){const norm=z.norm();return min<=norm&&norm<=max?this:this.scale(((x,min,max)=>Math.min(max,Math.max(min,x)))(norm)/norm)}frac(){return complex(frac(this.re),frac(this.im))}static norm(z){return z.norm()}static normSq(z){return z.normSq()}static inv(z){return z.conj().scale(1/z.normSq())}static scale(z,k){return z.scale(k)}static add(z1,z2){return z1.add(z2)}static sub(z1,z2){return z1.sub(z2)}static mult(z1,z2){return z1.mult(z2)}static div(z1,z2){return z1.div(z2)}static pow(z1,z2){return z1.pow(z2)}static exp(z){return z.exp()}static ln(z){return z.ln()}static sqrt(z){return z.sqrt()}static sin(z){return z.sin()}static cos(z){return z.cos()}static tan(z){return z.tan()}static asin(z){return z.asin()}static acos(z){return z.acos()}static atan(z){return z.atan()}static sinh(z){return z.sinh()}static cosh(z){return z.cosh()}static tanh(z){return z.tanh()}static infinite(z){const norm=z.norm();return z.re===1/0||z.re===-1/0||z.im===1/0||z.im===-1/0||norm===1/0}static nan(z){return isNaN(z.re)||isNaN(z.im)}static gamma(z){if(z.re<.5)return Complex.div(complex(Math.PI,0),Complex.mult(z.scale(Math.PI).sin(),Complex.gamma(complex(1-z.re,-z.im))));{z=Complex.sub(z,complex(1,0));let x=complex(pValues[0],0);for(let i=1;i<pValues.length;i++)x=Complex.add(x,Complex.div(complex(pValues[i],0),Complex.add(z,complex(i,0))));const t=Complex.add(z,complex(7.5,0));return Complex.pow(t,z.add(complex(.5,0))).mult(t.scale(-1).exp()).mult(x).scale(Math.sqrt(2*Math.PI))}}static beta(z1,z2){return Complex.div(Complex.mult(Complex.gamma(z1),Complex.gamma(z2)),Complex.gamma(z1.add(z2)))}static max(z1,z2){return z1.normSq()<z2.normSq()?z2:z1}static min(z1,z2){return z1.normSq()>z2.normSq()?z2:z1}static clamp(z,min,max){return z.clamp(min,max)}static frac(){return z.frac()}iadd(z){this.re+=z.re,this.im+=z.im}isub(z){this.re-=z.re,this.im-=z.im}}function complex(real,imaginary){return new Complex(real,imaginary)}class Vector{constructor(values){this.values=values,this.dimension=values.length}get(index){return this.values[index]}scale(z){const result=[];for(let i=0;i<this.dimension;i++)result.push(Complex.mult(this.get(i),z));return vector(result)}realScale(k){const result=[];for(let i=0;i<this.dimension;i++)result.push(this.get(i).scale(k));return vector(result)}add(Z){const result=[];for(let i=0;i<this.dimension;i++)result.push(Complex.add(this.get(i),Z.get(i)));return vector(result)}dot(Z){const result=complex(0,0);for(let i=0;i<this.dimension;i++)result.iadd(Complex.mult(this.get(i),Z.get(i).conj()));return result}norm(){return Math.sqrt(this.dot(this).re)}angleTo(Z){return Math.acos(this.dot(Z).re/(this.norm()*Z.norm()))}static lerp(Z1,Z2,t){return Z1.realScale(1-t).add(Z2.scale(t))}}function vector(...values){return values[0]instanceof Complex?new Vector(values):new Vector(values[0])}module.exports={Complex:Complex,complex:complex,integrateOverComplexVariable:function(f,z0,z1,samples=100){const step=Complex.sub(z1,z0).scale(1/samples),stepNorm=step.norm();let z=Complex.add(z0,step.scale(.5)),result=complex(0,0);for(let i=0;i<samples;i++)result.iadd(f(z).scale(stepNorm)),z.iadd(step);return result},integrateOverParameter:function(f,a=0,b=1,samples=100){const step=(b-a)/samples;let t=a+step/2,result=complex(0,0);for(let i=0;i<samples;i++)result.iadd(f(t).scale(step)),t+=step;return result},Vector:Vector,vector:vector}},{}],8:[function(require,module,exports){const{Euclid:Euclid}=require("./geometry.js"),{complex:complex,Complex:Complex,integrateOverParameter:integrateOverParameter}=require("./complex.js");function fourierCoefficients(f,N){const coefs=[];for(let n=-N;n<=N;n++){const F=t=>Complex.mult(f(t),Complex.exp(complex(0,-2*Math.PI*n*t)));coefs.push(integrateOverParameter(F,0,1))}return coefs}module.exports={parameterizePoints:function(points){const N=points.length,segmentLength=1/(N-1);return t=>{if(1===t)return points[N-1];{const index=Math.floor(t/segmentLength);return Euclid.lerp(points[index],points[index+1],t/segmentLength-Math.floor(t/segmentLength))}}},fourierCoefficients:fourierCoefficients,fourierSeries:function(f,N){const coefs=fourierCoefficients(f,N);return t=>{const result=complex(0,0);for(let n=-N;n<=N;n++){const coef=coefs[n+N];result.iadd(Complex.mult(coef,Complex.exp(complex(0,2*Math.PI*n*t))))}return result}}}},{"./complex.js":7,"./geometry.js":9}],9:[function(require,module,exports){const{Complex:Complex,complex:complex}=require("./complex.js");class Euclid{static lineIntersection(p1,v1,p2,v2){const x1=p1.re,y1=p1.im,x2=p1.re+v1.re,y2=p1.im+v1.im,x3=p2.re,y3=p2.im,x4=p2.re+v2.re,y4=p2.im+v2.im,denom=(x1-x2)*(y3-y4)-(y1-y2)*(x3-x4);if(0==denom)return null;const t=((x1-x3)*(y3-y4)-(y1-y3)*(x3-x4))/denom;return p1.add(v1.scale(t))}static midpoint(p1,p2){return p1.add(p2).scale(.5)}static lerp(p1,p2,t){return Complex.add(p1.scale(1-t),p2.scale(t))}static circleCenter(p1,p2,p3){return Euclid.lineIntersection(Euclid.midpoint(p1,p2),p2.sub(p1).perp(),Euclid.midpoint(p2,p3),p3.sub(p2).perp())}static centroid(P){let xTotal=0,yTotal=0;for(let point of P)xTotal+=point.re,yTotal+=point.im;return complex(xTotal/P.length,yTotal/P.length)}static distance(p1,p2){return p2.sub(p1).norm()}static project(p1,p2){return p2.scale(p1.dot(p2)/p2.normSq())}}class Poincare{static translatePToOrigin(z,P){return z.sub(P).div(complex(1,0).sub(P.conj().mult(z)))}static translateOriginToP(z,P){return z.add(P).div(complex(1,0).add(P.conj().mult(z)))}static segment(t,A,B){return Poincare.translateOriginToP(Poincare.translatePToOrigin(B,A).scale(t),A)}static line(t,A,B){return Poincare.translateOriginToP(Poincare.translatePToOrigin(B,A).unit().scale(2*t-1),A)}static regPolyDist(p,q){if((p-2)*(q-2)<=4)return void console.error(`Error: cannot compute regular polygon distance for p=${p}, q=${q}`);const tan1=Math.tan(Math.PI/2-Math.PI/q),tan2=Math.tan(Math.PI/p);return Math.sqrt((tan1-tan2)/(tan1+tan2))}static polygon(N,verts){verts.length<2&&console.error("Error: can't draw polygon with less than 2 points");const result=[],nPerSide=Math.ceil(N/verts.length);(verts=verts.slice()).push(verts[0]);for(let i=0;i<verts.length-1;i++){const space=linspace(0,1,nPerSide);for(let value of space)result.push(Poincare.segment(value,verts[i],verts[i+1]))}return result}static rotate(z,P,angle){return Poincare.translateOriginToP(Poincare.translatePToOrigin(z,P,!0).rotate(angle),P,!0)}static rotateMultiple(Z,P,angle){const result=[];for(let vert of Z)result.push(this.rotate(vert,P,angle));return result}static unitCircleInvert(z){return z.conj().inv()}static circleInvert(z,r,P){return P.add(complex(r*r,0).div(z.sub(P).conj()))}static reflect(z,p1,p2){const center=Euclid.circleCenter(p1,p2,Poincare.unitCircleInvert(p1));return null==center||center.norm()>1e3||isNaN(center.re)||isNaN(center.im)?p1.add(Euclid.project(z.sub(p1),p2.sub(p1))).scale(2).sub(z):Poincare.circleInvert(z,Euclid.distance(p1,center),center)}static reflectMultiple(Z,p1,p2){const result=[];for(let vert of Z)result.push(this.reflect(vert,p1,p2));return result}static inverseCayley(z){const one=complex(1,0);return one.add(z).div(one.sub(z)).mult(complex(0,1))}static toKleinDisk(z){const denom=.5*(1+z.normSq());return complex(z.re/denom,z.im/denom)}static hypDistance(z1,z2){const euclideanDistanceToOrigin=z1.sub(z2).norm();return Math.log((1+euclideanDistanceToOrigin)/(1-euclideanDistanceToOrigin))}}module.exports={Euclid:Euclid,Poincare:Poincare}},{"./complex.js":7}],10:[function(require,module,exports){function snormal(X){const norm=Math.sqrt(X[0]*X[0]+X[1]*X[1]+X[2]*X[2]);return[X[0]/norm,X[1]/norm,X[2]/norm]}function ssub(s,X,Y){return[X[0]+s*Y[0],X[1]+s*Y[1],X[2]+s*Y[2]]}function sdot(X,Y){return X[0]*Y[0]+X[1]*Y[1]+X[2]*Y[2]}function scross(X,Y){return[X[1]*Y[2]-X[2]*Y[1],X[2]*Y[0]-X[0]*Y[2],X[0]*Y[1]-X[1]*Y[0]]}function scenter(points){let xTotal=0,yTotal=0,zTotal=0;for(let i=0;i<points.length;i++)xTotal+=points[i][0],yTotal+=points[i][1],zTotal+=points[i][2];return xTotal/=points.length,yTotal/=points.length,zTotal/=points.length,[xTotal,yTotal,zTotal]}function sortClockwise(points){const mid=scenter(points);return sdot(scross(ssub(1,points[0],mid),ssub(1,points[1],mid)),mid)>0?points:[points[0],points[2],points[1]]}function icosphere(subdivisions=0){const scale=1/(2*Math.sin(2*Math.PI/5)),phi=scale*(1+Math.sqrt(5))/2,vertices=[[-scale,phi,0],[scale,phi,0],[-scale,-phi,0],[scale,-phi,0],[0,-scale,phi],[0,scale,phi],[0,-scale,-phi],[0,scale,-phi],[phi,0,-scale],[phi,0,scale],[-phi,0,-scale],[-phi,0,scale]],triangleIndices=[[0,11,5],[0,5,1],[0,1,7],[0,7,10],[0,10,11],[11,10,2],[5,11,4],[1,5,9],[7,1,8],[10,7,6],[3,9,4],[3,4,2],[3,2,6],[3,6,8],[3,8,9],[9,8,1],[4,9,5],[2,4,11],[6,2,10],[8,6,7]];let triangles=[];for(let index of triangleIndices)triangles.push([vertices[index[0]],vertices[index[1]],vertices[index[2]]]);const baryCoefs=[[0,0],[.5,0],[1,0],[0,.5],[.5,.5],[0,1]],trindices=[[0,1,3],[1,2,4],[1,3,4],[3,4,5]];for(let i=0;i<subdivisions;i++){const newTriangles=[];for(let tri of triangles){let newVertices=[];const u=[tri[1][0]-tri[0][0],tri[1][1]-tri[0][1],tri[1][2]-tri[0][2]],v=[tri[2][0]-tri[0][0],tri[2][1]-tri[0][1],tri[2][2]-tri[0][2]];for(let coef of baryCoefs)newVertices.push(ssub(coef[1],ssub(coef[0],tri[0],u),v));for(let trindex of trindices)newTriangles.push([newVertices[trindex[0]],newVertices[trindex[1]],newVertices[trindex[2]]])}triangles=newTriangles.slice()}for(let i=0;i<triangles.length;i++)triangles[i][0]=snormal(triangles[i][0]),triangles[i][1]=snormal(triangles[i][1]),triangles[i][2]=snormal(triangles[i][2]);for(let i=0;i<triangles.length;i++)triangles[i]=sortClockwise(triangles[i]);return triangles}function flatten(triangles){const verts=[];for(const tri of triangles)for(const vert of tri)verts.push(vert);return verts}module.exports={snormal:snormal,ssub:ssub,sscale:function(s,X){return[s*X[0],s*X[1],s*X[2]]},icosphere:icosphere,icosphere_flat:function(subdivisions=0){return flatten(icosphere(subdivisions))},icosphere_flat_lopsided:function(subdivisions_top=0,subdivisions_bottom=0){const top=icosphere(subdivisions_top).filter((face=>scenter(face)[2]<0)),bottom=icosphere(subdivisions_bottom).filter((face=>scenter(face)[2]>=0));return flatten(Array.prototype.concat(top,bottom))}}},{}],11:[function(require,module,exports){const config_EPSILON=1e-8;class Matrix{constructor(arr){if("number"==typeof arr[0]&&(arr=[arr]),this.mat=arr,this.cols=this.mat[0].length,this.rows=this.mat.length,0===this.rows||0===this.cols)throw new Error(`Invalid matrix dimensions ${this.rows} x ${this.cols}.`);this.isSquare=this.rows===this.cols}static randomMatrix(m,n){let arr=[];for(let i=0;i<m;i++){arr[i]=[];for(let j=0;j<n;j++)arr[i][j]=Math.random()}return new Matrix(arr)}static randomIntegerMatrix(m,n,lower=0,upper=100){lower=Math.floor(lower);let arr=[],range=(upper=Math.floor(upper+1))-lower;for(let i=0;i<m;i++){arr[i]=[];for(let j=0;j<n;j++)arr[i][j]=lower+Math.floor(Math.random()*range)}return new Matrix(arr)}static emptyMatrix(m,n){return Matrix.fillMatrix(m,n,0)}static fillMatrix(m,n,v){const arr=[];for(let i=0;i<m;i++){arr[i]=[];for(let j=0;j<n;j++)arr[i][j]=v}return new Matrix(arr)}static identity(n){const arr=[];for(let i=0;i<n;i++){arr[i]=[];for(let j=0;j<n;j++)arr[i][j]=i===j?1:0}return new Matrix(arr)}static determinant2x2(a,b,c,d){return a*d-b*c}static rotationMatrix2D(angle){return new Matrix([[Math.cos(angle),-Math.sin(angle)],[Math.sin(angle),Math.cos(angle)]])}static rotationMatrix3D(angleX,angleY,angleZ){const sinX=Math.sin(angleX),cosX=Math.cos(angleX),sinY=Math.sin(angleY),cosY=Math.cos(angleY),sinZ=Math.sin(angleZ),cosZ=Math.cos(angleZ),rotX=new Matrix([[1,0,0],[0,cosX,-sinX],[0,sinX,cosX]]),rotY=new Matrix([[cosY,0,sinY],[0,1,0],[-sinY,0,cosY]]),rotZ=new Matrix([[cosZ,-sinZ,0],[sinZ,cosZ,0],[0,0,1]]);return Matrix.multiply(Matrix.multiply(rotX,rotY),rotZ)}static multiply(mat1,mat2){if(mat1.cols!==mat2.rows)throw new Error("Incompatible matrix dimensions. must be m x r and r x n");const res=[];for(let i=0;i<mat1.rows;i++){const row=[];for(let j=0;j<mat1.cols;j++){let dot=0;for(let k=0;k<mat2.rows;k++)dot+=mat1.mat[i][k]*mat2.mat[k][j];row.push(dot)}res.push(row)}return new Matrix(res)}static scale(mat,k){let newMat=mat.copy();return newMat.scale(k),newMat}static add(mat1,mat2){let newMat=mat1.copy();return newMat.add(mat2),newMat}static sub(mat1,mat2){let newMat=mat1.copy();return newMat.sub(mat2),newMat}static detCofactorExpansion(mat){if(mat.isSquare){if(mat.rows>10)throw new Error("For larger matrices, use Matrix.det (cofactor expansion is inefficient and computation time grows with the factorial of matrix dimension).");if(2===mat.rows&&2===mat.cols)return Matrix.determinant2x2(mat.mat[0][0],mat.mat[0][1],mat.mat[1][0],mat.mat[1][1]);{let sign=1,bottom=mat.withoutRow(0),res=0;for(let j=0;j<mat.rows;j++)res+=sign*mat.mat[0][j]*Matrix.detCofactorExpansion(bottom.withoutColumn(j)),sign=-sign;return res}}throw new Error("The determinant is only defined for square matrices.")}static det(mat){let prod=null;if(mat.isSquare){let newMat=Matrix.LUDecomposition(mat).U;for(let d=0;d<newMat.rows&&(null===prod?prod=newMat.mat[d][d]:prod*=newMat.mat[d][d],0!==prod);d++);return prod}throw new Error("The determinant is only defined for square matrices.")}static ref(mat){let newMat=mat.copy();return newMat.ref(),newMat}static rref(mat){let newMat=mat.copy();return newMat.rref(),Matrix.cheapMatrixRound(newMat)}static columnNorm(mat,j){let squaredTotal=0;for(let i=0;i<mat.rows;i++)squaredTotal+=mat.get(i,j)*mat.get(i,j);return Math.sqrt(squaredTotal)}static householderReflection(mat){if(1!==mat.cols)throw new Error("Can only compute Householder matrix for column vectors");const alpha=mat.get(0,0);let scale=1===mat.rows?0:Matrix.columnNorm(mat.submatrix(1,mat.rows,0,1),0);scale*=scale;let tau,v=mat.copy();if(0===scale)tau=0;else{const t=Math.sqrt(alpha*alpha+scale);v.mat[0][0]=alpha<=0?alpha-t:-scale/(alpha+t),tau=2*v.get(0,0)*v.get(0,0)/(scale+v.get(0,0)*v.get(0,0)),v=Matrix.scale(v,1/v.get(0,0))}return Matrix.sub(Matrix.identity(mat.rows),Matrix.scale(Matrix.multiply(v,Matrix.transpose(v)),tau))}static QRDecomposition(mat){let R=mat.copy(),Q=Matrix.identity(mat.rows);for(let j=0;j<mat.cols;j++){const reflect=Matrix.householderReflection(R.submatrix(j,mat.rows,j,j+1)),H=Matrix.identity(mat.rows);for(let a=j;a<mat.rows;a++)for(let b=j;b<mat.rows;b++)H.mat[a][b]=reflect.get(a-j,b-j);R=Matrix.multiply(H,R),Q=Matrix.multiply(H,Q)}return{Q:Matrix.transpose(Q.submatrix(0,mat.cols,0,mat.cols)),R:R.submatrix(0,mat.cols,0,mat.cols)}}static eigenvalues(mat){if(!mat.isSquare)throw new Error("can't compute eigenvalues of non-square matrix");let A=mat.copy();for(let i=0;i<10;i++){const decomposition=Matrix.QRDecomposition(A);A=Matrix.multiply(decomposition.R,decomposition.Q)}const result=[];for(let i=0;i<mat.rows;i++)result.push(A.get(i,i));return result}static eigenpairs(mat){}static exp(mat){}static log(mat){}static pow(mat){}static LUDecomposition(mat){if(mat.isSquare){let L,U;L=Matrix.emptyMatrix(mat.rows,mat.cols),U=Matrix.emptyMatrix(mat.rows,mat.cols);for(let i=0;i<mat.rows;i++){for(let k=i;k<mat.rows;k++){let sum=0;for(let j=0;j<i;j++)sum+=L.mat[i][j]*U.mat[j][k];U.mat[i][k]=mat.mat[i][k]-sum}for(let k=i;k<mat.rows;k++)if(i===k)L.mat[i][i]=1;else{let sum=0;for(let j=0;j<i;j++)sum+=L.mat[k][j]*U.mat[j][i];L.mat[k][i]=(mat.mat[k][i]-sum)/U.mat[i][i]}}return{L:L,U:U}}throw new Error("The LU-decomposition can only be found for a square matrix.")}static minors(mat){return mat.minors()}static cofactors(mat){return mat.cofactors()}static adjugate(mat){return mat.adjugate()}static inverse(mat){return mat.inverse()}static transpose(mat){return mat.transpose()}static toLatex(mat){return mat.toLatex()}static cheapMatrixRound(mat){let newMat=mat.copy();return newMat.applyIndexFunction(((v,i,j)=>(x=>{let u=Math.ceil(x),l=Math.floor(x);return Math.abs(x-u)<config_EPSILON?u:Math.abs(x-l)<config_EPSILON?l:x})(v))),newMat}copy(){const newMatrix=Matrix.emptyMatrix(this.rows,this.cols);for(let i=0;i<this.rows;i++)for(let j=0;j<this.cols;j++)newMatrix.mat[i][j]=this.mat[i][j];return newMatrix}scale(k){for(let i=0;i<this.rows;i++)for(let j=0;j<this.cols;j++)this.mat[i][j]*=k}add(mat){if(this.rows!==mat.rows||this.cols!=mat.cols)throw new Error("Invalid matrix dimensions (both matrices should be the same size).");for(let i=0;i<this.rows;i++)for(let j=0;j<this.cols;j++)this.mat[i][j]+=mat.mat[i][j]}sub(mat){let matCopy=mat.copy();matCopy.scale(-1),this.add(matCopy)}applyIndexFunction(f){for(let i=0;i<this.rows;i++)for(let j=0;j<this.cols;j++)this.mat[i][j]=f(this.mat[i][j],i,j)}minors(){let res=Matrix.emptyMatrix(this.rows,this.cols);for(let i=0;i<this.rows;i++)for(let j=0;j<this.cols;j++)res.mat[i][j]=this.withoutRow(i).withoutColumn(j).determinant();return Matrix.cheapMatrixRound(res)}cofactors(){let minors=this.minors();return minors.applyIndexFunction(((v,i,j)=>(i+j)%2==0?v:-v)),minors}adjugate(){return this.cofactors().transpose()}inverse(){let det=this.determinant();if(0===det)throw new Error("Matrix is singular.");return Matrix.cheapMatrixRound(Matrix.scale(this.adjugate(),1/det))}transpose(){let mat=Matrix.emptyMatrix(this.cols,this.rows);for(let i=0;i<this.rows;i++)for(let j=0;j<this.cols;j++)mat.mat[j][i]=this.mat[i][j];return mat}getColumn(i){let col=[];for(let j=0;j<this.mat.length;j++)col.push(this.mat[j][i]);return col}getRow(i){return this.mat[i]}get(i,j){return this.mat[i][j]}rowSwap(i1,i2){if(i1<this.rows&&i2<this.rows){let temp;return temp=this.mat[i1].slice(),this.mat[i1]=this.mat[i2].slice(),void(this.mat[i2]=temp)}throw new Error("Row is invalid.")}columnSwap(j1,j2){if(j1<this.cols&&j2<this.cols){let mat=this.transpose();return mat.rowSwap(j1,j2),void(this.mat=mat.transpose().mat)}throw new Error("Column is invalid.")}submatrix(i1,i2,j1,j2){if(!(0<=i1&&i1<=this.rows&&0<=j1&&j1<=this.cols))throw new Error("submatrix index out of range");if(i1>i2||j1>j2)throw new Error("invalid submatrix indices");const result=[];for(let i=i1;i<i2;i++){const row=[];for(let j=j1;j<j2;j++)row.push(this.mat[i][j]);result.push(row)}return new Matrix(result)}withoutRow(i){if(i>=this.rows)throw new Error("Row is invalid.");let mat=this.copy().mat;return mat.splice(i,1),new Matrix(mat)}withoutColumn(j){if(j>=this.cols)throw new Error("Column is invalid.");return this.transpose().withoutRow(j).transpose()}scaleRow(i,k){if(!(i<this.rows))throw new Error("Invalid row.");for(let j=0;j<this.cols;j++)this.mat[i][j]*=k}subtractScaledRow(row,rowToBeSubtracted,scale){rowToBeSubtracted=this.mat[rowToBeSubtracted];for(let j=0;j<this.cols;j++)this.mat[row][j]-=scale*rowToBeSubtracted[j]}rowHasLeadingOne(i){if(i<this.rows)for(let j=0;j<this.cols;j++){if(1===this.mat[i][j])return!0;if(0!==this.mat[i][j])return!1}throw new Error("Invalid row.")}columnOfFirstNonzero(i){if(i<this.rows){for(let j=0;j<this.cols;j++)if(0!==this.mat[i][j])return j;return-1}throw new Error("Invalid row.")}ref(){}rref(){let i,lead=0;for(let r=0;r<this.rows&&!(this.cols<=lead);r++){for(i=r;0===this.mat[i][lead]&&(i++,this.rows!==i||(i=r,lead++,this.cols!==lead)););for(this.rowSwap(i,r),0!==this.mat[r][lead]&&this.scaleRow(r,1/this.mat[r][lead]),i=0;i<this.rows;i++)i!==r&&this.subtractScaledRow(i,r,this.mat[i][lead]);lead++}}determinant(){return Matrix.det(this)}trace(){if(this.isSquare){let total=0;for(let i=0;i<this.rows;i++)total+=this.mat[i][i];return total}throw new Error("Trace is only defined for square matrices.")}rowSum(i){return this.getRow(i).reduce(((x,y)=>x+y),0)}columnSum(j){return this.getColumn(j).reduce(((x,y)=>x+y),0)}rowAbsoluteSum(i){return this.getRow(i).reduce(((x,y)=>Math.abs(x)+Math.abs(y)),0)}columnAbsoluteSum(j){return this.getColumn(j).reduce(((x,y)=>Math.abs(x)+Math.abs(y)),0)}rowSums(){const totals=[];for(let i=0;i<this.rows;i++)totals.push(this.rowSum(i));return totals}columnSums(){const totals=[];for(let j=0;j<this.cols;j++)totals.push(this.columnSum(j));return totals}rowAbsoluteSums(){const totals=[];for(let i=0;i<this.rows;i++)totals.push(this.rowAbsoluteSum(i));return totals}columnAbsoluteSums(){const totals=[];for(let j=0;j<this.cols;j++)totals.push(this.columnAbsoluteSum(j));return totals}norm(){return Math.max(...this.columnAbsoluteSums())}toString(){let seg,str="";for(let i=0;i<this.rows;i++){str+="|  ";for(let j=0;j<this.cols;j++)seg=""+Math.floor(100*this.mat[i][j])/100,seg+=" ".repeat(5-seg.length),str+=seg,j<this.cols-1&&(str+="   ");str+="  |\n"}return str=" _"+" ".repeat(3*(this.cols-1)+5*this.cols+2)+"_\n"+str,str+=" -"+" ".repeat(3*(this.cols-1)+5*this.cols+2)+"- ",str}toLatex(openDelim="$$",closeDelim="$$"){let str=openDelim+"\\begin{pmatrix}";for(let i=0;i<this.rows;i++){for(let j=0;j<this.cols;j++)j+1<this.cols?str+=this.mat[i][j]+"&":str+=""+this.mat[i][j];i!==this.rows-1&&(str+="\\\\")}return str+="\\end{pmatrix}"+closeDelim,str}show(){let str=this.toString();console.log(str)}}module.exports={Matrix:Matrix,matrix:function(arr){return new Matrix(arr)}}},{}],12:[function(require,module,exports){const{matrix:matrix}=require("./matrix.js"),{complex:complex}=require("./complex.js");module.exports={stereographic:function(z){return complex(z[0]/(1-z[2]),z[1]/(1-z[2]))},inverseStereoProject:function(z){const normSq=z.normSq();return matrix([2*z.re/(1+normSq),2*z.im/(1+normSq),(normSq-1)/(1+normSq)]).transpose()},perspectiveProject:function(Z,orbit,fov){const values=Z.getColumn(0),x=values[0],y=values[1],z=values[2],denom=orbit+fov*y;return complex(x/denom,z/denom)}}},{"./complex.js":7,"./matrix.js":11}],13:[function(require,module,exports){class rVector{constructor(x,y){this.x=x,this.y=y}dot(v){return this.x*v.x+this.y*v.y}magSq(){return this.x*this.x+this.y*this.y}mag(){return Math.sqrt(this.magSq())}scale(k){return new rVector(this.x*k,this.y*k)}proj(v){return v.scale(this.dot(v)/v.magSq())}unit(){return this.scale(1/this.mag())}angleBetween(v){return Math.acos(this.dot(v).scale(this.mag()*v.mag()))}perp(){return new rVector(-this.y,this.x)}reflect(pointOnMirror,mirrorNormal){return pointOnMirror.add(this.sub(pointOnMirror).proj(mirrorNormal)).scale(2).sub(this)}add(v){return new rVector(this.x+v.x,this.y+v.y)}sub(v){return new rVector(this.x-v.x,this.y-v.y)}}module.exports={rVector:rVector,rvec:function(x,y){return new rVector(x,y)}}},{}],14:[function(require,module,exports){var global,factory;global=this,factory=function(){"use strict";var isTypedArray=function(x){return x instanceof Uint8Array||x instanceof Uint16Array||x instanceof Uint32Array||x instanceof Int8Array||x instanceof Int16Array||x instanceof Int32Array||x instanceof Float32Array||x instanceof Float64Array||x instanceof Uint8ClampedArray},extend=function(base,opts){for(var keys=Object.keys(opts),i=0;i<keys.length;++i)base[keys[i]]=opts[keys[i]];return base};function raise(message){var error=new Error("(regl) "+message);throw console.error(error),error}function check(pred,message){pred||raise(message)}function encolon(message){return message?": "+message:""}function standardTypeEh(value,type){switch(type){case"number":return"number"==typeof value;case"object":return"object"==typeof value;case"string":return"string"==typeof value;case"boolean":return"boolean"==typeof value;case"function":return"function"==typeof value;case"undefined":return void 0===value;case"symbol":return"symbol"==typeof value}}function checkOneOf(value,list,message){list.indexOf(value)<0&&raise("invalid value"+encolon(message)+". must be one of: "+list)}var constructorKeys=["gl","canvas","container","attributes","pixelRatio","extensions","optionalExtensions","profile","onDone"];function leftPad(str,n){for(str+="";str.length<n;)str=" "+str;return str}function ShaderFile(){this.name="unknown",this.lines=[],this.index={},this.hasErrors=!1}function ShaderLine(number,line){this.number=number,this.line=line,this.errors=[]}function ShaderError(fileNumber,lineNumber,message){this.file=fileNumber,this.line=lineNumber,this.message=message}function guessCommand(){var error=new Error,stack=(error.stack||error).toString(),pat=/compileProcedure.*\n\s*at.*\((.*)\)/.exec(stack);if(pat)return pat[1];var pat2=/compileProcedure.*\n\s*at\s+(.*)(\n|$)/.exec(stack);return pat2?pat2[1]:"unknown"}function guessCallSite(){var error=new Error,stack=(error.stack||error).toString(),pat=/at REGLCommand.*\n\s+at.*\((.*)\)/.exec(stack);if(pat)return pat[1];var pat2=/at REGLCommand.*\n\s+at\s+(.*)\n/.exec(stack);return pat2?pat2[1]:"unknown"}function parseSource(source,command){var str,lines=source.split("\n"),lineNumber=1,fileNumber=0,files={unknown:new ShaderFile,0:new ShaderFile};files.unknown.name=files[0].name=command||guessCommand(),files.unknown.lines.push(new ShaderLine(0,""));for(var i=0;i<lines.length;++i){var line=lines[i],parts=/^\s*#\s*(\w+)\s+(.+)\s*$/.exec(line);if(parts)switch(parts[1]){case"line":var lineNumberInfo=/(\d+)(\s+\d+)?/.exec(parts[2]);lineNumberInfo&&(lineNumber=0|lineNumberInfo[1],lineNumberInfo[2]&&((fileNumber=0|lineNumberInfo[2])in files||(files[fileNumber]=new ShaderFile)));break;case"define":var nameInfo=/SHADER_NAME(_B64)?\s+(.*)$/.exec(parts[2]);nameInfo&&(files[fileNumber].name=nameInfo[1]?(str=nameInfo[2],"undefined"!=typeof atob?atob(str):"base64:"+str):nameInfo[2])}files[fileNumber].lines.push(new ShaderLine(lineNumber++,line))}return Object.keys(files).forEach((function(fileNumber){var file=files[fileNumber];file.lines.forEach((function(line){file.index[line.number]=line}))})),files}function saveCommandRef(object){object._commandRef=guessCommand()}function commandRaise(message,command){var callSite=guessCallSite();raise(message+" in command "+(command||guessCommand())+("unknown"===callSite?"":" called from "+callSite))}function checkCommandType(value,type,message,command){standardTypeEh(value,type)||commandRaise("invalid parameter type"+encolon(message)+". expected "+type+", got "+typeof value,command||guessCommand())}var GL_UNSIGNED_SHORT_4_4_4_4=32819,GL_UNSIGNED_SHORT_5_5_5_1=32820,GL_UNSIGNED_SHORT_5_6_5=33635,GL_UNSIGNED_INT_24_8_WEBGL=34042,TYPE_SIZE={};function pixelSize(type,channels){return type===GL_UNSIGNED_SHORT_5_5_5_1||type===GL_UNSIGNED_SHORT_4_4_4_4||type===GL_UNSIGNED_SHORT_5_6_5?2:type===GL_UNSIGNED_INT_24_8_WEBGL?4:TYPE_SIZE[type]*channels}function isPow2(v){return!(v&v-1||!v)}TYPE_SIZE[5120]=TYPE_SIZE[5121]=1,TYPE_SIZE[5122]=TYPE_SIZE[5123]=TYPE_SIZE[36193]=TYPE_SIZE[GL_UNSIGNED_SHORT_5_6_5]=TYPE_SIZE[GL_UNSIGNED_SHORT_4_4_4_4]=TYPE_SIZE[GL_UNSIGNED_SHORT_5_5_5_1]=2,TYPE_SIZE[5124]=TYPE_SIZE[5125]=TYPE_SIZE[5126]=TYPE_SIZE[GL_UNSIGNED_INT_24_8_WEBGL]=4;var check$1=extend(check,{optional:function(block){block()},raise:raise,commandRaise:commandRaise,command:function(pred,message,command){pred||commandRaise(message,command||guessCommand())},parameter:function(param,possibilities,message){param in possibilities||raise("unknown parameter ("+param+")"+encolon(message)+". possible values: "+Object.keys(possibilities).join())},commandParameter:function(param,possibilities,message,command){param in possibilities||commandRaise("unknown parameter ("+param+")"+encolon(message)+". possible values: "+Object.keys(possibilities).join(),command||guessCommand())},constructor:function(obj){Object.keys(obj).forEach((function(key){constructorKeys.indexOf(key)<0&&raise('invalid regl constructor argument "'+key+'". must be one of '+constructorKeys)}))},type:function(value,type,message){standardTypeEh(value,type)||raise("invalid parameter type"+encolon(message)+". expected "+type+", got "+typeof value)},commandType:checkCommandType,isTypedArray:function(data,message){isTypedArray(data)||raise("invalid parameter type"+encolon(message)+". must be a typed array")},nni:function(value,message){value>=0&&(0|value)===value||raise("invalid parameter type, ("+value+")"+encolon(message)+". must be a nonnegative integer")},oneOf:checkOneOf,shaderError:function(gl,shader,source,type,command){if(!gl.getShaderParameter(shader,gl.COMPILE_STATUS)){var errLog=gl.getShaderInfoLog(shader),typeName=type===gl.FRAGMENT_SHADER?"fragment":"vertex";checkCommandType(source,"string",typeName+" shader source must be a string",command);var files=parseSource(source,command),errors=function(errLog){var result=[];return errLog.split("\n").forEach((function(errMsg){if(!(errMsg.length<5)){var parts=/^ERROR:\s+(\d+):(\d+):\s*(.*)$/.exec(errMsg);parts?result.push(new ShaderError(0|parts[1],0|parts[2],parts[3].trim())):errMsg.length>0&&result.push(new ShaderError("unknown",0,errMsg))}})),result}(errLog);!function(files,errors){errors.forEach((function(error){var file=files[error.file];if(file){var line=file.index[error.line];if(line)return line.errors.push(error),void(file.hasErrors=!0)}files.unknown.hasErrors=!0,files.unknown.lines[0].errors.push(error)}))}(files,errors),Object.keys(files).forEach((function(fileNumber){var file=files[fileNumber];if(file.hasErrors){var strings=[""],styles=[""];push("file number "+fileNumber+": "+file.name+"\n","color:red;text-decoration:underline;font-weight:bold"),file.lines.forEach((function(line){if(line.errors.length>0){push(leftPad(line.number,4)+"|  ","background-color:yellow; font-weight:bold"),push(line.line+"\n","color:red; background-color:yellow; font-weight:bold");var offset=0;line.errors.forEach((function(error){var message=error.message,token=/^\s*'(.*)'\s*:\s*(.*)$/.exec(message);if(token){var tokenPat=token[1];message=token[2],"assign"===tokenPat&&(tokenPat="="),offset=Math.max(line.line.indexOf(tokenPat,offset),0)}else offset=0;push(leftPad("| ",6)),push(leftPad("^^^",offset+3)+"\n","font-weight:bold"),push(leftPad("| ",6)),push(message+"\n","font-weight:bold")})),push(leftPad("| ",6)+"\n")}else push(leftPad(line.number,4)+"|  "),push(line.line+"\n","color:red")})),"undefined"==typeof document||window.chrome?console.log(strings.join("")):(styles[0]=strings.join("%c"),console.log.apply(console,styles))}function push(str,style){strings.push(str),styles.push(style||"")}})),check.raise("Error compiling "+typeName+" shader, "+files[0].name)}},linkError:function(gl,program,fragShader,vertShader,command){if(!gl.getProgramParameter(program,gl.LINK_STATUS)){var errLog=gl.getProgramInfoLog(program),fragParse=parseSource(fragShader,command),header='Error linking program with vertex shader, "'+parseSource(vertShader,command)[0].name+'", and fragment shader "'+fragParse[0].name+'"';"undefined"!=typeof document?console.log("%c"+header+"\n%c"+errLog,"color:red;text-decoration:underline;font-weight:bold","color:red"):console.log(header+"\n"+errLog),check.raise(header)}},callSite:guessCallSite,saveCommandRef:saveCommandRef,saveDrawInfo:function(opts,uniforms,attributes,stringStore){function id(str){return str?stringStore.id(str):0}function addProps(dict,set){Object.keys(set).forEach((function(u){dict[stringStore.id(u)]=!0}))}saveCommandRef(opts),opts._fragId=id(opts.static.frag),opts._vertId=id(opts.static.vert);var uniformSet=opts._uniformSet={};addProps(uniformSet,uniforms.static),addProps(uniformSet,uniforms.dynamic);var attributeSet=opts._attributeSet={};addProps(attributeSet,attributes.static),addProps(attributeSet,attributes.dynamic),opts._hasCount="count"in opts.static||"count"in opts.dynamic||"elements"in opts.static||"elements"in opts.dynamic},framebufferFormat:function(attachment,texFormats,rbFormats){attachment.texture?checkOneOf(attachment.texture._texture.internalformat,texFormats,"unsupported texture format for attachment"):checkOneOf(attachment.renderbuffer._renderbuffer.format,rbFormats,"unsupported renderbuffer format for attachment")},guessCommand:guessCommand,texture2D:function(info,mipData,limits){var i,w=mipData.width,h=mipData.height,c=mipData.channels;check(w>0&&w<=limits.maxTextureSize&&h>0&&h<=limits.maxTextureSize,"invalid texture shape"),33071===info.wrapS&&33071===info.wrapT||check(isPow2(w)&&isPow2(h),"incompatible wrap mode for texture, both width and height must be power of 2"),1===mipData.mipmask?1!==w&&1!==h&&check(9984!==info.minFilter&&9986!==info.minFilter&&9985!==info.minFilter&&9987!==info.minFilter,"min filter requires mipmap"):(check(isPow2(w)&&isPow2(h),"texture must be a square power of 2 to support mipmapping"),check(mipData.mipmask===(w<<1)-1,"missing or incomplete mipmap data")),5126===mipData.type&&(limits.extensions.indexOf("oes_texture_float_linear")<0&&check(9728===info.minFilter&&9728===info.magFilter,"filter not supported, must enable oes_texture_float_linear"),check(!info.genMipmaps,"mipmap generation not supported with float textures"));var mipimages=mipData.images;for(i=0;i<16;++i)if(mipimages[i]){var mw=w>>i,mh=h>>i;check(mipData.mipmask&1<<i,"missing mipmap data");var img=mipimages[i];if(check(img.width===mw&&img.height===mh,"invalid shape for mip images"),check(img.format===mipData.format&&img.internalformat===mipData.internalformat&&img.type===mipData.type,"incompatible type for mip image"),img.compressed);else if(img.data){var rowSize=Math.ceil(pixelSize(img.type,c)*mw/img.unpackAlignment)*img.unpackAlignment;check(img.data.byteLength===rowSize*mh,"invalid data for image, buffer size is inconsistent with image format")}else img.element||img.copy}else info.genMipmaps||check(!(mipData.mipmask&1<<i),"extra mipmap data");mipData.compressed&&check(!info.genMipmaps,"mipmap generation for compressed images not supported")},textureCube:function(texture,info,faces,limits){var w=texture.width,h=texture.height,c=texture.channels;check(w>0&&w<=limits.maxTextureSize&&h>0&&h<=limits.maxTextureSize,"invalid texture shape"),check(w===h,"cube map must be square"),check(33071===info.wrapS&&33071===info.wrapT,"wrap mode not supported by cube map");for(var i=0;i<faces.length;++i){var face=faces[i];check(face.width===w&&face.height===h,"inconsistent cube map face shape"),info.genMipmaps&&(check(!face.compressed,"can not generate mipmap for compressed textures"),check(1===face.mipmask,"can not specify mipmaps and generate mipmaps"));for(var mipmaps=face.images,j=0;j<16;++j){var img=mipmaps[j];if(img){var mw=w>>j,mh=h>>j;check(face.mipmask&1<<j,"missing mipmap data"),check(img.width===mw&&img.height===mh,"invalid shape for mip images"),check(img.format===texture.format&&img.internalformat===texture.internalformat&&img.type===texture.type,"incompatible type for mip image"),img.compressed||(img.data?check(img.data.byteLength===mw*mh*Math.max(pixelSize(img.type,c),img.unpackAlignment),"invalid data for image, buffer size is inconsistent with image format"):img.element||img.copy)}}}}}),VARIABLE_COUNTER=0;function DynamicVariable(type,data){this.id=VARIABLE_COUNTER++,this.type=type,this.data=data}function escapeStr(str){return str.replace(/\\/g,"\\\\").replace(/"/g,'\\"')}function splitParts(str){if(0===str.length)return[];var firstChar=str.charAt(0),lastChar=str.charAt(str.length-1);if(str.length>1&&firstChar===lastChar&&('"'===firstChar||"'"===firstChar))return['"'+escapeStr(str.substr(1,str.length-2))+'"'];var parts=/\[(false|true|null|\d+|'[^']*'|"[^"]*")\]/.exec(str);if(parts)return splitParts(str.substr(0,parts.index)).concat(splitParts(parts[1])).concat(splitParts(str.substr(parts.index+parts[0].length)));var subparts=str.split(".");if(1===subparts.length)return['"'+escapeStr(str)+'"'];for(var result=[],i=0;i<subparts.length;++i)result=result.concat(splitParts(subparts[i]));return result}function toAccessorString(str){return"["+splitParts(str).join("][")+"]"}var dynamic={DynamicVariable:DynamicVariable,define:function(type,data){return new DynamicVariable(type,toAccessorString(data+""))},isDynamic:function(x){return"function"==typeof x&&!x._reglType||x instanceof DynamicVariable},unbox:function unbox(x,path){return"function"==typeof x?new DynamicVariable(0,x):"number"==typeof x||"boolean"==typeof x?new DynamicVariable(5,x):Array.isArray(x)?new DynamicVariable(6,x.map((function(y,i){return unbox(y,path+"["+i+"]")}))):x instanceof DynamicVariable?x:void check$1(!1,"invalid option type in uniform "+path)},accessor:toAccessorString},raf={next:"function"==typeof requestAnimationFrame?function(cb){return requestAnimationFrame(cb)}:function(cb){return setTimeout(cb,16)},cancel:"function"==typeof cancelAnimationFrame?function(raf){return cancelAnimationFrame(raf)}:clearTimeout},clock="undefined"!=typeof performance&&performance.now?function(){return performance.now()}:function(){return+new Date};function parseExtensions(input){return"string"==typeof input?input.split():(check$1(Array.isArray(input),"invalid extension array"),input)}function getElement(desc){return"string"==typeof desc?(check$1("undefined"!=typeof document,"not supported outside of DOM"),document.querySelector(desc)):desc}function parseArgs(args_){var element,container,canvas,gl,obj,args=args_||{},contextAttributes={},extensions=[],optionalExtensions=[],pixelRatio="undefined"==typeof window?1:window.devicePixelRatio,profile=!1,onDone=function(err){err&&check$1.raise(err)},onDestroy=function(){};if("string"==typeof args?(check$1("undefined"!=typeof document,"selector queries only supported in DOM enviroments"),element=document.querySelector(args),check$1(element,"invalid query string for element")):"object"==typeof args?"string"==typeof(obj=args).nodeName&&"function"==typeof obj.appendChild&&"function"==typeof obj.getBoundingClientRect?element=args:function(obj){return"function"==typeof obj.drawArrays||"function"==typeof obj.drawElements}(args)?canvas=(gl=args).canvas:(check$1.constructor(args),"gl"in args?gl=args.gl:"canvas"in args?canvas=getElement(args.canvas):"container"in args&&(container=getElement(args.container)),"attributes"in args&&(contextAttributes=args.attributes,check$1.type(contextAttributes,"object","invalid context attributes")),"extensions"in args&&(extensions=parseExtensions(args.extensions)),"optionalExtensions"in args&&(optionalExtensions=parseExtensions(args.optionalExtensions)),"onDone"in args&&(check$1.type(args.onDone,"function","invalid or missing onDone callback"),onDone=args.onDone),"profile"in args&&(profile=!!args.profile),"pixelRatio"in args&&(pixelRatio=+args.pixelRatio,check$1(pixelRatio>0,"invalid pixel ratio"))):check$1.raise("invalid arguments to regl"),element&&("canvas"===element.nodeName.toLowerCase()?canvas=element:container=element),!gl){if(!canvas){check$1("undefined"!=typeof document,"must manually specify webgl context outside of DOM environments");var result=function(element,onDone,pixelRatio){var resizeObserver,canvas=document.createElement("canvas");function resize(){var w=window.innerWidth,h=window.innerHeight;if(element!==document.body){var bounds=canvas.getBoundingClientRect();w=bounds.right-bounds.left,h=bounds.bottom-bounds.top}canvas.width=pixelRatio*w,canvas.height=pixelRatio*h}return extend(canvas.style,{border:0,margin:0,padding:0,top:0,left:0,width:"100%",height:"100%"}),element.appendChild(canvas),element===document.body&&(canvas.style.position="absolute",extend(element.style,{margin:0,padding:0})),element!==document.body&&"function"==typeof ResizeObserver?(resizeObserver=new ResizeObserver((function(){setTimeout(resize)}))).observe(element):window.addEventListener("resize",resize,!1),resize(),{canvas:canvas,onDestroy:function(){resizeObserver?resizeObserver.disconnect():window.removeEventListener("resize",resize),element.removeChild(canvas)}}}(container||document.body,0,pixelRatio);if(!result)return null;canvas=result.canvas,onDestroy=result.onDestroy}void 0===contextAttributes.premultipliedAlpha&&(contextAttributes.premultipliedAlpha=!0),gl=function(canvas,contextAttributes){function get(name){try{return canvas.getContext(name,contextAttributes)}catch(e){return null}}return get("webgl")||get("experimental-webgl")||get("webgl-experimental")}(canvas,contextAttributes)}return gl?{gl:gl,canvas:canvas,container:container,extensions:extensions,optionalExtensions:optionalExtensions,pixelRatio:pixelRatio,profile:profile,onDone:onDone,onDestroy:onDestroy}:(onDestroy(),onDone("webgl not supported, try upgrading your browser or graphics drivers http://get.webgl.org"),null)}function loop(n,f){for(var result=Array(n),i=0;i<n;++i)result[i]=f(i);return result}function log2(v){var r,shift;return r=(v>65535)<<4,r|=shift=((v>>>=r)>255)<<3,r|=shift=((v>>>=shift)>15)<<2,(r|=shift=((v>>>=shift)>3)<<1)|(v>>>=shift)>>1}function createPool(){var bufferPool=loop(8,(function(){return[]}));function alloc(n){var sz=function(v){for(var i=16;i<=1<<28;i*=16)if(v<=i)return i;return 0}(n),bin=bufferPool[log2(sz)>>2];return bin.length>0?bin.pop():new ArrayBuffer(sz)}function free(buf){bufferPool[log2(buf.byteLength)>>2].push(buf)}return{alloc:alloc,free:free,allocType:function(type,n){var result=null;switch(type){case 5120:result=new Int8Array(alloc(n),0,n);break;case 5121:result=new Uint8Array(alloc(n),0,n);break;case 5122:result=new Int16Array(alloc(2*n),0,n);break;case 5123:result=new Uint16Array(alloc(2*n),0,n);break;case 5124:result=new Int32Array(alloc(4*n),0,n);break;case 5125:result=new Uint32Array(alloc(4*n),0,n);break;case 5126:result=new Float32Array(alloc(4*n),0,n);break;default:return null}return result.length!==n?result.subarray(0,n):result},freeType:function(array){free(array.buffer)}}}var pool=createPool();function isNDArrayLike(obj){return!!obj&&"object"==typeof obj&&Array.isArray(obj.shape)&&Array.isArray(obj.stride)&&"number"==typeof obj.offset&&obj.shape.length===obj.stride.length&&(Array.isArray(obj.data)||isTypedArray(obj.data))}pool.zero=createPool();var values=function(obj){return Object.keys(obj).map((function(key){return obj[key]}))},flattenUtils={shape:function(array_){for(var shape=[],array=array_;array.length;array=array[0])shape.push(array.length);return shape},flatten:function(array,shape,type,out_){var sz=1;if(shape.length)for(var i=0;i<shape.length;++i)sz*=shape[i];else sz=0;var out=out_||pool.allocType(type,sz);switch(shape.length){case 0:break;case 1:!function(array,nx,out){for(var i=0;i<nx;++i)out[i]=array[i]}(array,shape[0],out);break;case 2:!function(array,nx,ny,out){for(var ptr=0,i=0;i<nx;++i)for(var row=array[i],j=0;j<ny;++j)out[ptr++]=row[j]}(array,shape[0],shape[1],out);break;case 3:flatten3D(array,shape[0],shape[1],shape[2],out,0);break;default:flattenRec(array,shape,0,out,0)}return out}};function flatten3D(array,nx,ny,nz,out,ptr_){for(var ptr=ptr_,i=0;i<nx;++i)for(var row=array[i],j=0;j<ny;++j)for(var col=row[j],k=0;k<nz;++k)out[ptr++]=col[k]}function flattenRec(array,shape,level,out,ptr){for(var stride=1,i=level+1;i<shape.length;++i)stride*=shape[i];var n=shape[level];if(shape.length-level==4){var nx=shape[level+1],ny=shape[level+2],nz=shape[level+3];for(i=0;i<n;++i)flatten3D(array[i],nx,ny,nz,out,ptr),ptr+=stride}else for(i=0;i<n;++i)flattenRec(array[i],shape,level+1,out,ptr),ptr+=stride}var arrayTypes={"[object Int8Array]":5120,"[object Int16Array]":5122,"[object Int32Array]":5124,"[object Uint8Array]":5121,"[object Uint8ClampedArray]":5121,"[object Uint16Array]":5123,"[object Uint32Array]":5125,"[object Float32Array]":5126,"[object Float64Array]":5121,"[object ArrayBuffer]":5121},glTypes={int8:5120,int16:5122,int32:5124,uint8:5121,uint16:5123,uint32:5125,float:5126,float32:5126},usageTypes={dynamic:35048,stream:35040,static:35044},arrayFlatten=flattenUtils.flatten,arrayShape=flattenUtils.shape,GL_STATIC_DRAW=35044,GL_STREAM_DRAW=35040,GL_UNSIGNED_BYTE$3=5121,GL_FLOAT$3=5126,DTYPES_SIZES=[];function typedArrayCode(data){return 0|arrayTypes[Object.prototype.toString.call(data)]}function copyArray(out,inp){for(var i=0;i<inp.length;++i)out[i]=inp[i]}function transpose(result,data,shapeX,shapeY,strideX,strideY,offset){for(var ptr=0,i=0;i<shapeX;++i)for(var j=0;j<shapeY;++j)result[ptr++]=data[strideX*i+strideY*j+offset]}DTYPES_SIZES[5120]=1,DTYPES_SIZES[5122]=2,DTYPES_SIZES[5124]=4,DTYPES_SIZES[5121]=1,DTYPES_SIZES[5123]=2,DTYPES_SIZES[5125]=4,DTYPES_SIZES[5126]=4;var primTypes={points:0,point:0,lines:1,line:1,triangles:4,triangle:4,"line loop":2,"line strip":3,"triangle strip":5,"triangle fan":6},GL_POINTS=0,GL_LINES=1,GL_TRIANGLES=4,GL_BYTE$2=5120,GL_UNSIGNED_BYTE$4=5121,GL_SHORT$2=5122,GL_UNSIGNED_SHORT$2=5123,GL_INT$2=5124,GL_UNSIGNED_INT$2=5125,GL_ELEMENT_ARRAY_BUFFER=34963,GL_STREAM_DRAW$1=35040,GL_STATIC_DRAW$1=35044,FLOAT=new Float32Array(1),INT=new Uint32Array(FLOAT.buffer),GL_UNSIGNED_SHORT$4=5123;function convertToHalfFloat(array){for(var ushorts=pool.allocType(GL_UNSIGNED_SHORT$4,array.length),i=0;i<array.length;++i)if(isNaN(array[i]))ushorts[i]=65535;else if(array[i]===1/0)ushorts[i]=31744;else if(array[i]===-1/0)ushorts[i]=64512;else{FLOAT[0]=array[i];var x=INT[0],sgn=x>>>31<<15,exp=(x<<1>>>24)-127,frac=x>>13&1023;if(exp<-24)ushorts[i]=sgn;else if(exp<-14){var s=-14-exp;ushorts[i]=sgn+(frac+1024>>s)}else ushorts[i]=exp>15?sgn+31744:sgn+(exp+15<<10)+frac}return ushorts}function isArrayLike(s){return Array.isArray(s)||isTypedArray(s)}var isPow2$1=function(v){return!(v&v-1||!v)},GL_COMPRESSED_TEXTURE_FORMATS=34467,GL_TEXTURE_2D$1=3553,GL_TEXTURE_CUBE_MAP$1=34067,GL_TEXTURE_CUBE_MAP_POSITIVE_X$1=34069,GL_RGBA$1=6408,GL_ALPHA=6406,GL_RGB=6407,GL_LUMINANCE=6409,GL_LUMINANCE_ALPHA=6410,GL_RGBA4=32854,GL_RGB5_A1=32855,GL_RGB565=36194,GL_UNSIGNED_SHORT_4_4_4_4$1=32819,GL_UNSIGNED_SHORT_5_5_5_1$1=32820,GL_UNSIGNED_SHORT_5_6_5$1=33635,GL_UNSIGNED_INT_24_8_WEBGL$1=34042,GL_DEPTH_COMPONENT=6402,GL_DEPTH_STENCIL=34041,GL_SRGB_EXT=35904,GL_SRGB_ALPHA_EXT=35906,GL_HALF_FLOAT_OES$1=36193,GL_COMPRESSED_RGB_S3TC_DXT1_EXT=33776,GL_COMPRESSED_RGBA_S3TC_DXT1_EXT=33777,GL_COMPRESSED_RGBA_S3TC_DXT3_EXT=33778,GL_COMPRESSED_RGBA_S3TC_DXT5_EXT=33779,GL_COMPRESSED_RGB_ATC_WEBGL=35986,GL_COMPRESSED_RGBA_ATC_EXPLICIT_ALPHA_WEBGL=35987,GL_COMPRESSED_RGBA_ATC_INTERPOLATED_ALPHA_WEBGL=34798,GL_COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840,GL_COMPRESSED_RGB_PVRTC_2BPPV1_IMG=35841,GL_COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842,GL_COMPRESSED_RGBA_PVRTC_2BPPV1_IMG=35843,GL_COMPRESSED_RGB_ETC1_WEBGL=36196,GL_UNSIGNED_BYTE$5=5121,GL_UNSIGNED_SHORT$3=5123,GL_UNSIGNED_INT$3=5125,GL_FLOAT$4=5126,GL_TEXTURE_WRAP_S=10242,GL_TEXTURE_WRAP_T=10243,GL_REPEAT=10497,GL_CLAMP_TO_EDGE$1=33071,GL_MIRRORED_REPEAT=33648,GL_TEXTURE_MAG_FILTER=10240,GL_TEXTURE_MIN_FILTER=10241,GL_NEAREST$1=9728,GL_LINEAR=9729,GL_NEAREST_MIPMAP_NEAREST$1=9984,GL_LINEAR_MIPMAP_NEAREST$1=9985,GL_NEAREST_MIPMAP_LINEAR$1=9986,GL_LINEAR_MIPMAP_LINEAR$1=9987,GL_GENERATE_MIPMAP_HINT=33170,GL_DONT_CARE=4352,GL_FASTEST=4353,GL_NICEST=4354,GL_TEXTURE_MAX_ANISOTROPY_EXT=34046,GL_UNPACK_ALIGNMENT=3317,GL_UNPACK_FLIP_Y_WEBGL=37440,GL_UNPACK_PREMULTIPLY_ALPHA_WEBGL=37441,GL_UNPACK_COLORSPACE_CONVERSION_WEBGL=37443,GL_BROWSER_DEFAULT_WEBGL=37444,GL_TEXTURE0$1=33984,MIPMAP_FILTERS=[GL_NEAREST_MIPMAP_NEAREST$1,GL_NEAREST_MIPMAP_LINEAR$1,GL_LINEAR_MIPMAP_NEAREST$1,GL_LINEAR_MIPMAP_LINEAR$1],CHANNELS_FORMAT=[0,GL_LUMINANCE,GL_LUMINANCE_ALPHA,GL_RGB,GL_RGBA$1],FORMAT_CHANNELS={};function objectName(str){return"[object "+str+"]"}FORMAT_CHANNELS[GL_LUMINANCE]=FORMAT_CHANNELS[GL_ALPHA]=FORMAT_CHANNELS[GL_DEPTH_COMPONENT]=1,FORMAT_CHANNELS[GL_DEPTH_STENCIL]=FORMAT_CHANNELS[GL_LUMINANCE_ALPHA]=2,FORMAT_CHANNELS[GL_RGB]=FORMAT_CHANNELS[GL_SRGB_EXT]=3,FORMAT_CHANNELS[GL_RGBA$1]=FORMAT_CHANNELS[GL_SRGB_ALPHA_EXT]=4;var CANVAS_CLASS=objectName("HTMLCanvasElement"),OFFSCREENCANVAS_CLASS=objectName("OffscreenCanvas"),CONTEXT2D_CLASS=objectName("CanvasRenderingContext2D"),BITMAP_CLASS=objectName("ImageBitmap"),IMAGE_CLASS=objectName("HTMLImageElement"),VIDEO_CLASS=objectName("HTMLVideoElement"),PIXEL_CLASSES=Object.keys(arrayTypes).concat([CANVAS_CLASS,OFFSCREENCANVAS_CLASS,CONTEXT2D_CLASS,BITMAP_CLASS,IMAGE_CLASS,VIDEO_CLASS]),TYPE_SIZES=[];TYPE_SIZES[GL_UNSIGNED_BYTE$5]=1,TYPE_SIZES[GL_FLOAT$4]=4,TYPE_SIZES[GL_HALF_FLOAT_OES$1]=2,TYPE_SIZES[GL_UNSIGNED_SHORT$3]=2,TYPE_SIZES[GL_UNSIGNED_INT$3]=4;var FORMAT_SIZES_SPECIAL=[];function isNumericArray(arr){return Array.isArray(arr)&&(0===arr.length||"number"==typeof arr[0])}function isRectArray(arr){return!!Array.isArray(arr)&&!(0===arr.length||!isArrayLike(arr[0]))}function classString(x){return Object.prototype.toString.call(x)}function isCanvasElement(object){return classString(object)===CANVAS_CLASS}function isOffscreenCanvas(object){return classString(object)===OFFSCREENCANVAS_CLASS}function isPixelData(object){if(!object)return!1;var className=classString(object);return PIXEL_CLASSES.indexOf(className)>=0||isNumericArray(object)||isRectArray(object)||isNDArrayLike(object)}function typedArrayCode$1(data){return 0|arrayTypes[Object.prototype.toString.call(data)]}function preConvert(image,n){return pool.allocType(image.type===GL_HALF_FLOAT_OES$1?GL_FLOAT$4:image.type,n)}function postConvert(image,data){image.type===GL_HALF_FLOAT_OES$1?(image.data=convertToHalfFloat(data),pool.freeType(data)):image.data=data}function getTextureSize(format,type,width,height,isMipmap,isCube){var s;if(s=void 0!==FORMAT_SIZES_SPECIAL[format]?FORMAT_SIZES_SPECIAL[format]:FORMAT_CHANNELS[format]*TYPE_SIZES[type],isCube&&(s*=6),isMipmap){for(var total=0,w=width;w>=1;)total+=s*w*w,w/=2;return total}return s*width*height}function createTextureSet(gl,extensions,limits,reglPoll,contextState,stats,config){var mipmapHint={"don't care":GL_DONT_CARE,"dont care":GL_DONT_CARE,nice:GL_NICEST,fast:GL_FASTEST},wrapModes={repeat:GL_REPEAT,clamp:GL_CLAMP_TO_EDGE$1,mirror:GL_MIRRORED_REPEAT},magFilters={nearest:GL_NEAREST$1,linear:GL_LINEAR},minFilters=extend({mipmap:GL_LINEAR_MIPMAP_LINEAR$1,"nearest mipmap nearest":GL_NEAREST_MIPMAP_NEAREST$1,"linear mipmap nearest":GL_LINEAR_MIPMAP_NEAREST$1,"nearest mipmap linear":GL_NEAREST_MIPMAP_LINEAR$1,"linear mipmap linear":GL_LINEAR_MIPMAP_LINEAR$1},magFilters),colorSpace={none:0,browser:GL_BROWSER_DEFAULT_WEBGL},textureTypes={uint8:GL_UNSIGNED_BYTE$5,rgba4:GL_UNSIGNED_SHORT_4_4_4_4$1,rgb565:GL_UNSIGNED_SHORT_5_6_5$1,"rgb5 a1":GL_UNSIGNED_SHORT_5_5_5_1$1},textureFormats={alpha:GL_ALPHA,luminance:GL_LUMINANCE,"luminance alpha":GL_LUMINANCE_ALPHA,rgb:GL_RGB,rgba:GL_RGBA$1,rgba4:GL_RGBA4,"rgb5 a1":GL_RGB5_A1,rgb565:GL_RGB565},compressedTextureFormats={};extensions.ext_srgb&&(textureFormats.srgb=GL_SRGB_EXT,textureFormats.srgba=GL_SRGB_ALPHA_EXT),extensions.oes_texture_float&&(textureTypes.float32=textureTypes.float=GL_FLOAT$4),extensions.oes_texture_half_float&&(textureTypes.float16=textureTypes["half float"]=GL_HALF_FLOAT_OES$1),extensions.webgl_depth_texture&&(extend(textureFormats,{depth:GL_DEPTH_COMPONENT,"depth stencil":GL_DEPTH_STENCIL}),extend(textureTypes,{uint16:GL_UNSIGNED_SHORT$3,uint32:GL_UNSIGNED_INT$3,"depth stencil":GL_UNSIGNED_INT_24_8_WEBGL$1})),extensions.webgl_compressed_texture_s3tc&&extend(compressedTextureFormats,{"rgb s3tc dxt1":GL_COMPRESSED_RGB_S3TC_DXT1_EXT,"rgba s3tc dxt1":GL_COMPRESSED_RGBA_S3TC_DXT1_EXT,"rgba s3tc dxt3":GL_COMPRESSED_RGBA_S3TC_DXT3_EXT,"rgba s3tc dxt5":GL_COMPRESSED_RGBA_S3TC_DXT5_EXT}),extensions.webgl_compressed_texture_atc&&extend(compressedTextureFormats,{"rgb atc":GL_COMPRESSED_RGB_ATC_WEBGL,"rgba atc explicit alpha":GL_COMPRESSED_RGBA_ATC_EXPLICIT_ALPHA_WEBGL,"rgba atc interpolated alpha":GL_COMPRESSED_RGBA_ATC_INTERPOLATED_ALPHA_WEBGL}),extensions.webgl_compressed_texture_pvrtc&&extend(compressedTextureFormats,{"rgb pvrtc 4bppv1":GL_COMPRESSED_RGB_PVRTC_4BPPV1_IMG,"rgb pvrtc 2bppv1":GL_COMPRESSED_RGB_PVRTC_2BPPV1_IMG,"rgba pvrtc 4bppv1":GL_COMPRESSED_RGBA_PVRTC_4BPPV1_IMG,"rgba pvrtc 2bppv1":GL_COMPRESSED_RGBA_PVRTC_2BPPV1_IMG}),extensions.webgl_compressed_texture_etc1&&(compressedTextureFormats["rgb etc1"]=GL_COMPRESSED_RGB_ETC1_WEBGL);var supportedCompressedFormats=Array.prototype.slice.call(gl.getParameter(GL_COMPRESSED_TEXTURE_FORMATS));Object.keys(compressedTextureFormats).forEach((function(name){var format=compressedTextureFormats[name];supportedCompressedFormats.indexOf(format)>=0&&(textureFormats[name]=format)}));var supportedFormats=Object.keys(textureFormats);limits.textureFormats=supportedFormats;var textureFormatsInvert=[];Object.keys(textureFormats).forEach((function(key){var val=textureFormats[key];textureFormatsInvert[val]=key}));var textureTypesInvert=[];Object.keys(textureTypes).forEach((function(key){var val=textureTypes[key];textureTypesInvert[val]=key}));var magFiltersInvert=[];Object.keys(magFilters).forEach((function(key){var val=magFilters[key];magFiltersInvert[val]=key}));var minFiltersInvert=[];Object.keys(minFilters).forEach((function(key){var val=minFilters[key];minFiltersInvert[val]=key}));var wrapModesInvert=[];Object.keys(wrapModes).forEach((function(key){var val=wrapModes[key];wrapModesInvert[val]=key}));var colorFormats=supportedFormats.reduce((function(color,key){var glenum=textureFormats[key];return glenum===GL_LUMINANCE||glenum===GL_ALPHA||glenum===GL_LUMINANCE||glenum===GL_LUMINANCE_ALPHA||glenum===GL_DEPTH_COMPONENT||glenum===GL_DEPTH_STENCIL||extensions.ext_srgb&&(glenum===GL_SRGB_EXT||glenum===GL_SRGB_ALPHA_EXT)?color[glenum]=glenum:glenum===GL_RGB5_A1||key.indexOf("rgba")>=0?color[glenum]=GL_RGBA$1:color[glenum]=GL_RGB,color}),{});function TexFlags(){this.internalformat=GL_RGBA$1,this.format=GL_RGBA$1,this.type=GL_UNSIGNED_BYTE$5,this.compressed=!1,this.premultiplyAlpha=!1,this.flipY=!1,this.unpackAlignment=1,this.colorSpace=GL_BROWSER_DEFAULT_WEBGL,this.width=0,this.height=0,this.channels=0}function copyFlags(result,other){result.internalformat=other.internalformat,result.format=other.format,result.type=other.type,result.compressed=other.compressed,result.premultiplyAlpha=other.premultiplyAlpha,result.flipY=other.flipY,result.unpackAlignment=other.unpackAlignment,result.colorSpace=other.colorSpace,result.width=other.width,result.height=other.height,result.channels=other.channels}function parseFlags(flags,options){if("object"==typeof options&&options){if("premultiplyAlpha"in options&&(check$1.type(options.premultiplyAlpha,"boolean","invalid premultiplyAlpha"),flags.premultiplyAlpha=options.premultiplyAlpha),"flipY"in options&&(check$1.type(options.flipY,"boolean","invalid texture flip"),flags.flipY=options.flipY),"alignment"in options&&(check$1.oneOf(options.alignment,[1,2,4,8],"invalid texture unpack alignment"),flags.unpackAlignment=options.alignment),"colorSpace"in options&&(check$1.parameter(options.colorSpace,colorSpace,"invalid colorSpace"),flags.colorSpace=colorSpace[options.colorSpace]),"type"in options){var type=options.type;check$1(extensions.oes_texture_float||!("float"===type||"float32"===type),"you must enable the OES_texture_float extension in order to use floating point textures."),check$1(extensions.oes_texture_half_float||!("half float"===type||"float16"===type),"you must enable the OES_texture_half_float extension in order to use 16-bit floating point textures."),check$1(extensions.webgl_depth_texture||!("uint16"===type||"uint32"===type||"depth stencil"===type),"you must enable the WEBGL_depth_texture extension in order to use depth/stencil textures."),check$1.parameter(type,textureTypes,"invalid texture type"),flags.type=textureTypes[type]}var w=flags.width,h=flags.height,c=flags.channels,hasChannels=!1;"shape"in options?(check$1(Array.isArray(options.shape)&&options.shape.length>=2,"shape must be an array"),w=options.shape[0],h=options.shape[1],3===options.shape.length&&(c=options.shape[2],check$1(c>0&&c<=4,"invalid number of channels"),hasChannels=!0),check$1(w>=0&&w<=limits.maxTextureSize,"invalid width"),check$1(h>=0&&h<=limits.maxTextureSize,"invalid height")):("radius"in options&&(w=h=options.radius,check$1(w>=0&&w<=limits.maxTextureSize,"invalid radius")),"width"in options&&(w=options.width,check$1(w>=0&&w<=limits.maxTextureSize,"invalid width")),"height"in options&&(h=options.height,check$1(h>=0&&h<=limits.maxTextureSize,"invalid height")),"channels"in options&&(c=options.channels,check$1(c>0&&c<=4,"invalid number of channels"),hasChannels=!0)),flags.width=0|w,flags.height=0|h,flags.channels=0|c;var hasFormat=!1;if("format"in options){var formatStr=options.format;check$1(extensions.webgl_depth_texture||!("depth"===formatStr||"depth stencil"===formatStr),"you must enable the WEBGL_depth_texture extension in order to use depth/stencil textures."),check$1.parameter(formatStr,textureFormats,"invalid texture format");var internalformat=flags.internalformat=textureFormats[formatStr];flags.format=colorFormats[internalformat],formatStr in textureTypes&&("type"in options||(flags.type=textureTypes[formatStr])),formatStr in compressedTextureFormats&&(flags.compressed=!0),hasFormat=!0}!hasChannels&&hasFormat?flags.channels=FORMAT_CHANNELS[flags.format]:hasChannels&&!hasFormat?flags.channels!==CHANNELS_FORMAT[flags.format]&&(flags.format=flags.internalformat=CHANNELS_FORMAT[flags.channels]):hasFormat&&hasChannels&&check$1(flags.channels===FORMAT_CHANNELS[flags.format],"number of channels inconsistent with specified format")}}function setFlags(flags){gl.pixelStorei(GL_UNPACK_FLIP_Y_WEBGL,flags.flipY),gl.pixelStorei(GL_UNPACK_PREMULTIPLY_ALPHA_WEBGL,flags.premultiplyAlpha),gl.pixelStorei(GL_UNPACK_COLORSPACE_CONVERSION_WEBGL,flags.colorSpace),gl.pixelStorei(GL_UNPACK_ALIGNMENT,flags.unpackAlignment)}function TexImage(){TexFlags.call(this),this.xOffset=0,this.yOffset=0,this.data=null,this.needsFree=!1,this.element=null,this.needsCopy=!1}function parseImage(image,options){var data=null;if(isPixelData(options)?data=options:options&&(check$1.type(options,"object","invalid pixel data type"),parseFlags(image,options),"x"in options&&(image.xOffset=0|options.x),"y"in options&&(image.yOffset=0|options.y),isPixelData(options.data)&&(data=options.data)),check$1(!image.compressed||data instanceof Uint8Array,"compressed texture data must be stored in a uint8array"),options.copy){check$1(!data,"can not specify copy and data field for the same texture");var viewW=contextState.viewportWidth,viewH=contextState.viewportHeight;image.width=image.width||viewW-image.xOffset,image.height=image.height||viewH-image.yOffset,image.needsCopy=!0,check$1(image.xOffset>=0&&image.xOffset<viewW&&image.yOffset>=0&&image.yOffset<viewH&&image.width>0&&image.width<=viewW&&image.height>0&&image.height<=viewH,"copy texture read out of bounds")}else if(data){if(isTypedArray(data))image.channels=image.channels||4,image.data=data,"type"in options||image.type!==GL_UNSIGNED_BYTE$5||(image.type=typedArrayCode$1(data));else if(isNumericArray(data))image.channels=image.channels||4,function(result,data){var n=data.length;switch(result.type){case GL_UNSIGNED_BYTE$5:case GL_UNSIGNED_SHORT$3:case GL_UNSIGNED_INT$3:case GL_FLOAT$4:var converted=pool.allocType(result.type,n);converted.set(data),result.data=converted;break;case GL_HALF_FLOAT_OES$1:result.data=convertToHalfFloat(data);break;default:check$1.raise("unsupported texture type, must specify a typed array")}}(image,data),image.alignment=1,image.needsFree=!0;else if(isNDArrayLike(data)){var array=data.data;Array.isArray(array)||image.type!==GL_UNSIGNED_BYTE$5||(image.type=typedArrayCode$1(array));var shapeX,shapeY,shapeC,strideX,strideY,strideC,shape=data.shape,stride=data.stride;3===shape.length?(shapeC=shape[2],strideC=stride[2]):(check$1(2===shape.length,"invalid ndarray pixel data, must be 2 or 3D"),shapeC=1,strideC=1),shapeX=shape[0],shapeY=shape[1],strideX=stride[0],strideY=stride[1],image.alignment=1,image.width=shapeX,image.height=shapeY,image.channels=shapeC,image.format=image.internalformat=CHANNELS_FORMAT[shapeC],image.needsFree=!0,function(image,array,strideX,strideY,strideC,offset){for(var w=image.width,h=image.height,c=image.channels,data=preConvert(image,w*h*c),p=0,i=0;i<h;++i)for(var j=0;j<w;++j)for(var k=0;k<c;++k)data[p++]=array[strideX*j+strideY*i+strideC*k+offset];postConvert(image,data)}(image,array,strideX,strideY,strideC,data.offset)}else if(isCanvasElement(data)||isOffscreenCanvas(data)||classString(data)===CONTEXT2D_CLASS)isCanvasElement(data)||isOffscreenCanvas(data)?image.element=data:image.element=data.canvas,image.width=image.element.width,image.height=image.element.height,image.channels=4;else if(function(object){return classString(object)===BITMAP_CLASS}(data))image.element=data,image.width=data.width,image.height=data.height,image.channels=4;else if(function(object){return classString(object)===IMAGE_CLASS}(data))image.element=data,image.width=data.naturalWidth,image.height=data.naturalHeight,image.channels=4;else if(function(object){return classString(object)===VIDEO_CLASS}(data))image.element=data,image.width=data.videoWidth,image.height=data.videoHeight,image.channels=4;else if(isRectArray(data)){var w=image.width||data[0].length,h=image.height||data.length,c=image.channels;c=isArrayLike(data[0][0])?c||data[0][0].length:c||1;for(var arrayShape=flattenUtils.shape(data),n=1,dd=0;dd<arrayShape.length;++dd)n*=arrayShape[dd];var allocData=preConvert(image,n);flattenUtils.flatten(data,arrayShape,"",allocData),postConvert(image,allocData),image.alignment=1,image.width=w,image.height=h,image.channels=c,image.format=image.internalformat=CHANNELS_FORMAT[c],image.needsFree=!0}}else image.width=image.width||1,image.height=image.height||1,image.channels=image.channels||4;image.type===GL_FLOAT$4?check$1(limits.extensions.indexOf("oes_texture_float")>=0,"oes_texture_float extension not enabled"):image.type===GL_HALF_FLOAT_OES$1&&check$1(limits.extensions.indexOf("oes_texture_half_float")>=0,"oes_texture_half_float extension not enabled")}function setImage(info,target,miplevel){var element=info.element,data=info.data,internalformat=info.internalformat,format=info.format,type=info.type,width=info.width,height=info.height;setFlags(info),element?gl.texImage2D(target,miplevel,format,format,type,element):info.compressed?gl.compressedTexImage2D(target,miplevel,internalformat,width,height,0,data):info.needsCopy?(reglPoll(),gl.copyTexImage2D(target,miplevel,format,info.xOffset,info.yOffset,width,height,0)):gl.texImage2D(target,miplevel,format,width,height,0,format,type,data||null)}function setSubImage(info,target,x,y,miplevel){var element=info.element,data=info.data,internalformat=info.internalformat,format=info.format,type=info.type,width=info.width,height=info.height;setFlags(info),element?gl.texSubImage2D(target,miplevel,x,y,format,type,element):info.compressed?gl.compressedTexSubImage2D(target,miplevel,x,y,internalformat,width,height,data):info.needsCopy?(reglPoll(),gl.copyTexSubImage2D(target,miplevel,x,y,info.xOffset,info.yOffset,width,height)):gl.texSubImage2D(target,miplevel,x,y,width,height,format,type,data)}var imagePool=[];function allocImage(){return imagePool.pop()||new TexImage}function freeImage(image){image.needsFree&&pool.freeType(image.data),TexImage.call(image),imagePool.push(image)}function MipMap(){TexFlags.call(this),this.genMipmaps=!1,this.mipmapHint=GL_DONT_CARE,this.mipmask=0,this.images=Array(16)}function parseMipMapFromShape(mipmap,width,height){var img=mipmap.images[0]=allocImage();mipmap.mipmask=1,img.width=mipmap.width=width,img.height=mipmap.height=height,img.channels=mipmap.channels=4}function parseMipMapFromObject(mipmap,options){var imgData=null;if(isPixelData(options))copyFlags(imgData=mipmap.images[0]=allocImage(),mipmap),parseImage(imgData,options),mipmap.mipmask=1;else if(parseFlags(mipmap,options),Array.isArray(options.mipmap))for(var mipData=options.mipmap,i=0;i<mipData.length;++i)copyFlags(imgData=mipmap.images[i]=allocImage(),mipmap),imgData.width>>=i,imgData.height>>=i,parseImage(imgData,mipData[i]),mipmap.mipmask|=1<<i;else copyFlags(imgData=mipmap.images[0]=allocImage(),mipmap),parseImage(imgData,options),mipmap.mipmask=1;copyFlags(mipmap,mipmap.images[0]),!mipmap.compressed||mipmap.internalformat!==GL_COMPRESSED_RGB_S3TC_DXT1_EXT&&mipmap.internalformat!==GL_COMPRESSED_RGBA_S3TC_DXT1_EXT&&mipmap.internalformat!==GL_COMPRESSED_RGBA_S3TC_DXT3_EXT&&mipmap.internalformat!==GL_COMPRESSED_RGBA_S3TC_DXT5_EXT||check$1(mipmap.width%4==0&&mipmap.height%4==0,"for compressed texture formats, mipmap level 0 must have width and height that are a multiple of 4")}function setMipMap(mipmap,target){for(var images=mipmap.images,i=0;i<images.length;++i){if(!images[i])return;setImage(images[i],target,i)}}var mipPool=[];function allocMipMap(){var result=mipPool.pop()||new MipMap;TexFlags.call(result),result.mipmask=0;for(var i=0;i<16;++i)result.images[i]=null;return result}function freeMipMap(mipmap){for(var images=mipmap.images,i=0;i<images.length;++i)images[i]&&freeImage(images[i]),images[i]=null;mipPool.push(mipmap)}function TexInfo(){this.minFilter=GL_NEAREST$1,this.magFilter=GL_NEAREST$1,this.wrapS=GL_CLAMP_TO_EDGE$1,this.wrapT=GL_CLAMP_TO_EDGE$1,this.anisotropic=1,this.genMipmaps=!1,this.mipmapHint=GL_DONT_CARE}function parseTexInfo(info,options){if("min"in options){var minFilter=options.min;check$1.parameter(minFilter,minFilters),info.minFilter=minFilters[minFilter],MIPMAP_FILTERS.indexOf(info.minFilter)>=0&&!("faces"in options)&&(info.genMipmaps=!0)}if("mag"in options){var magFilter=options.mag;check$1.parameter(magFilter,magFilters),info.magFilter=magFilters[magFilter]}var wrapS=info.wrapS,wrapT=info.wrapT;if("wrap"in options){var wrap=options.wrap;"string"==typeof wrap?(check$1.parameter(wrap,wrapModes),wrapS=wrapT=wrapModes[wrap]):Array.isArray(wrap)&&(check$1.parameter(wrap[0],wrapModes),check$1.parameter(wrap[1],wrapModes),wrapS=wrapModes[wrap[0]],wrapT=wrapModes[wrap[1]])}else{if("wrapS"in options){var optWrapS=options.wrapS;check$1.parameter(optWrapS,wrapModes),wrapS=wrapModes[optWrapS]}if("wrapT"in options){var optWrapT=options.wrapT;check$1.parameter(optWrapT,wrapModes),wrapT=wrapModes[optWrapT]}}if(info.wrapS=wrapS,info.wrapT=wrapT,"anisotropic"in options){var anisotropic=options.anisotropic;check$1("number"==typeof anisotropic&&anisotropic>=1&&anisotropic<=limits.maxAnisotropic,"aniso samples must be between 1 and "),info.anisotropic=options.anisotropic}if("mipmap"in options){var hasMipMap=!1;switch(typeof options.mipmap){case"string":check$1.parameter(options.mipmap,mipmapHint,"invalid mipmap hint"),info.mipmapHint=mipmapHint[options.mipmap],info.genMipmaps=!0,hasMipMap=!0;break;case"boolean":hasMipMap=info.genMipmaps=options.mipmap;break;case"object":check$1(Array.isArray(options.mipmap),"invalid mipmap type"),info.genMipmaps=!1,hasMipMap=!0;break;default:check$1.raise("invalid mipmap type")}hasMipMap&&!("min"in options)&&(info.minFilter=GL_NEAREST_MIPMAP_NEAREST$1)}}function setTexInfo(info,target){gl.texParameteri(target,GL_TEXTURE_MIN_FILTER,info.minFilter),gl.texParameteri(target,GL_TEXTURE_MAG_FILTER,info.magFilter),gl.texParameteri(target,GL_TEXTURE_WRAP_S,info.wrapS),gl.texParameteri(target,GL_TEXTURE_WRAP_T,info.wrapT),extensions.ext_texture_filter_anisotropic&&gl.texParameteri(target,GL_TEXTURE_MAX_ANISOTROPY_EXT,info.anisotropic),info.genMipmaps&&(gl.hint(GL_GENERATE_MIPMAP_HINT,info.mipmapHint),gl.generateMipmap(target))}var textureCount=0,textureSet={},numTexUnits=limits.maxTextureUnits,textureUnits=Array(numTexUnits).map((function(){return null}));function REGLTexture(target){TexFlags.call(this),this.mipmask=0,this.internalformat=GL_RGBA$1,this.id=textureCount++,this.refCount=1,this.target=target,this.texture=gl.createTexture(),this.unit=-1,this.bindCount=0,this.texInfo=new TexInfo,config.profile&&(this.stats={size:0})}function tempBind(texture){gl.activeTexture(GL_TEXTURE0$1),gl.bindTexture(texture.target,texture.texture)}function tempRestore(){var prev=textureUnits[0];prev?gl.bindTexture(prev.target,prev.texture):gl.bindTexture(GL_TEXTURE_2D$1,null)}function destroy(texture){var handle=texture.texture;check$1(handle,"must not double destroy texture");var unit=texture.unit,target=texture.target;unit>=0&&(gl.activeTexture(GL_TEXTURE0$1+unit),gl.bindTexture(target,null),textureUnits[unit]=null),gl.deleteTexture(handle),texture.texture=null,texture.params=null,texture.pixels=null,texture.refCount=0,delete textureSet[texture.id],stats.textureCount--}return extend(REGLTexture.prototype,{bind:function(){this.bindCount+=1;var unit=this.unit;if(unit<0){for(var i=0;i<numTexUnits;++i){var other=textureUnits[i];if(other){if(other.bindCount>0)continue;other.unit=-1}textureUnits[i]=this,unit=i;break}unit>=numTexUnits&&check$1.raise("insufficient number of texture units"),config.profile&&stats.maxTextureUnits<unit+1&&(stats.maxTextureUnits=unit+1),this.unit=unit,gl.activeTexture(GL_TEXTURE0$1+unit),gl.bindTexture(this.target,this.texture)}return unit},unbind:function(){this.bindCount-=1},decRef:function(){--this.refCount<=0&&destroy(this)}}),config.profile&&(stats.getTotalTextureSize=function(){var total=0;return Object.keys(textureSet).forEach((function(key){total+=textureSet[key].stats.size})),total}),{create2D:function(a,b){var texture=new REGLTexture(GL_TEXTURE_2D$1);function reglTexture2D(a,b){var texInfo=texture.texInfo;TexInfo.call(texInfo);var mipData=allocMipMap();return"number"==typeof a?parseMipMapFromShape(mipData,0|a,"number"==typeof b?0|b:0|a):a?(check$1.type(a,"object","invalid arguments to regl.texture"),parseTexInfo(texInfo,a),parseMipMapFromObject(mipData,a)):parseMipMapFromShape(mipData,1,1),texInfo.genMipmaps&&(mipData.mipmask=(mipData.width<<1)-1),texture.mipmask=mipData.mipmask,copyFlags(texture,mipData),check$1.texture2D(texInfo,mipData,limits),texture.internalformat=mipData.internalformat,reglTexture2D.width=mipData.width,reglTexture2D.height=mipData.height,tempBind(texture),setMipMap(mipData,GL_TEXTURE_2D$1),setTexInfo(texInfo,GL_TEXTURE_2D$1),tempRestore(),freeMipMap(mipData),config.profile&&(texture.stats.size=getTextureSize(texture.internalformat,texture.type,mipData.width,mipData.height,texInfo.genMipmaps,!1)),reglTexture2D.format=textureFormatsInvert[texture.internalformat],reglTexture2D.type=textureTypesInvert[texture.type],reglTexture2D.mag=magFiltersInvert[texInfo.magFilter],reglTexture2D.min=minFiltersInvert[texInfo.minFilter],reglTexture2D.wrapS=wrapModesInvert[texInfo.wrapS],reglTexture2D.wrapT=wrapModesInvert[texInfo.wrapT],reglTexture2D}return textureSet[texture.id]=texture,stats.textureCount++,reglTexture2D(a,b),reglTexture2D.subimage=function(image,x_,y_,level_){check$1(!!image,"must specify image data");var x=0|x_,y=0|y_,level=0|level_,imageData=allocImage();return copyFlags(imageData,texture),imageData.width=0,imageData.height=0,parseImage(imageData,image),imageData.width=imageData.width||(texture.width>>level)-x,imageData.height=imageData.height||(texture.height>>level)-y,check$1(texture.type===imageData.type&&texture.format===imageData.format&&texture.internalformat===imageData.internalformat,"incompatible format for texture.subimage"),check$1(x>=0&&y>=0&&x+imageData.width<=texture.width&&y+imageData.height<=texture.height,"texture.subimage write out of bounds"),check$1(texture.mipmask&1<<level,"missing mipmap data"),check$1(imageData.data||imageData.element||imageData.needsCopy,"missing image data"),tempBind(texture),setSubImage(imageData,GL_TEXTURE_2D$1,x,y,level),tempRestore(),freeImage(imageData),reglTexture2D},reglTexture2D.resize=function(w_,h_){var w=0|w_,h=0|h_||w;if(w===texture.width&&h===texture.height)return reglTexture2D;reglTexture2D.width=texture.width=w,reglTexture2D.height=texture.height=h,tempBind(texture);for(var i=0;texture.mipmask>>i;++i){var _w=w>>i,_h=h>>i;if(!_w||!_h)break;gl.texImage2D(GL_TEXTURE_2D$1,i,texture.format,_w,_h,0,texture.format,texture.type,null)}return tempRestore(),config.profile&&(texture.stats.size=getTextureSize(texture.internalformat,texture.type,w,h,!1,!1)),reglTexture2D},reglTexture2D._reglType="texture2d",reglTexture2D._texture=texture,config.profile&&(reglTexture2D.stats=texture.stats),reglTexture2D.destroy=function(){texture.decRef()},reglTexture2D},createCube:function(a0,a1,a2,a3,a4,a5){var texture=new REGLTexture(GL_TEXTURE_CUBE_MAP$1);textureSet[texture.id]=texture,stats.cubeCount++;var faces=new Array(6);function reglTextureCube(a0,a1,a2,a3,a4,a5){var i,texInfo=texture.texInfo;for(TexInfo.call(texInfo),i=0;i<6;++i)faces[i]=allocMipMap();if("number"!=typeof a0&&a0)if("object"==typeof a0)if(a1)parseMipMapFromObject(faces[0],a0),parseMipMapFromObject(faces[1],a1),parseMipMapFromObject(faces[2],a2),parseMipMapFromObject(faces[3],a3),parseMipMapFromObject(faces[4],a4),parseMipMapFromObject(faces[5],a5);else if(parseTexInfo(texInfo,a0),parseFlags(texture,a0),"faces"in a0){var faceInput=a0.faces;for(check$1(Array.isArray(faceInput)&&6===faceInput.length,"cube faces must be a length 6 array"),i=0;i<6;++i)check$1("object"==typeof faceInput[i]&&!!faceInput[i],"invalid input for cube map face"),copyFlags(faces[i],texture),parseMipMapFromObject(faces[i],faceInput[i])}else for(i=0;i<6;++i)parseMipMapFromObject(faces[i],a0);else check$1.raise("invalid arguments to cube map");else{var s=0|a0||1;for(i=0;i<6;++i)parseMipMapFromShape(faces[i],s,s)}for(copyFlags(texture,faces[0]),check$1.optional((function(){limits.npotTextureCube||check$1(isPow2$1(texture.width)&&isPow2$1(texture.height),"your browser does not support non power or two texture dimensions")})),texInfo.genMipmaps?texture.mipmask=(faces[0].width<<1)-1:texture.mipmask=faces[0].mipmask,check$1.textureCube(texture,texInfo,faces,limits),texture.internalformat=faces[0].internalformat,reglTextureCube.width=faces[0].width,reglTextureCube.height=faces[0].height,tempBind(texture),i=0;i<6;++i)setMipMap(faces[i],GL_TEXTURE_CUBE_MAP_POSITIVE_X$1+i);for(setTexInfo(texInfo,GL_TEXTURE_CUBE_MAP$1),tempRestore(),config.profile&&(texture.stats.size=getTextureSize(texture.internalformat,texture.type,reglTextureCube.width,reglTextureCube.height,texInfo.genMipmaps,!0)),reglTextureCube.format=textureFormatsInvert[texture.internalformat],reglTextureCube.type=textureTypesInvert[texture.type],reglTextureCube.mag=magFiltersInvert[texInfo.magFilter],reglTextureCube.min=minFiltersInvert[texInfo.minFilter],reglTextureCube.wrapS=wrapModesInvert[texInfo.wrapS],reglTextureCube.wrapT=wrapModesInvert[texInfo.wrapT],i=0;i<6;++i)freeMipMap(faces[i]);return reglTextureCube}return reglTextureCube(a0,a1,a2,a3,a4,a5),reglTextureCube.subimage=function(face,image,x_,y_,level_){check$1(!!image,"must specify image data"),check$1("number"==typeof face&&face===(0|face)&&face>=0&&face<6,"invalid face");var x=0|x_,y=0|y_,level=0|level_,imageData=allocImage();return copyFlags(imageData,texture),imageData.width=0,imageData.height=0,parseImage(imageData,image),imageData.width=imageData.width||(texture.width>>level)-x,imageData.height=imageData.height||(texture.height>>level)-y,check$1(texture.type===imageData.type&&texture.format===imageData.format&&texture.internalformat===imageData.internalformat,"incompatible format for texture.subimage"),check$1(x>=0&&y>=0&&x+imageData.width<=texture.width&&y+imageData.height<=texture.height,"texture.subimage write out of bounds"),check$1(texture.mipmask&1<<level,"missing mipmap data"),check$1(imageData.data||imageData.element||imageData.needsCopy,"missing image data"),tempBind(texture),setSubImage(imageData,GL_TEXTURE_CUBE_MAP_POSITIVE_X$1+face,x,y,level),tempRestore(),freeImage(imageData),reglTextureCube},reglTextureCube.resize=function(radius_){var radius=0|radius_;if(radius!==texture.width){reglTextureCube.width=texture.width=radius,reglTextureCube.height=texture.height=radius,tempBind(texture);for(var i=0;i<6;++i)for(var j=0;texture.mipmask>>j;++j)gl.texImage2D(GL_TEXTURE_CUBE_MAP_POSITIVE_X$1+i,j,texture.format,radius>>j,radius>>j,0,texture.format,texture.type,null);return tempRestore(),config.profile&&(texture.stats.size=getTextureSize(texture.internalformat,texture.type,reglTextureCube.width,reglTextureCube.height,!1,!0)),reglTextureCube}},reglTextureCube._reglType="textureCube",reglTextureCube._texture=texture,config.profile&&(reglTextureCube.stats=texture.stats),reglTextureCube.destroy=function(){texture.decRef()},reglTextureCube},clear:function(){for(var i=0;i<numTexUnits;++i)gl.activeTexture(GL_TEXTURE0$1+i),gl.bindTexture(GL_TEXTURE_2D$1,null),textureUnits[i]=null;values(textureSet).forEach(destroy),stats.cubeCount=0,stats.textureCount=0},getTexture:function(wrapper){return null},restore:function(){for(var i=0;i<numTexUnits;++i){var tex=textureUnits[i];tex&&(tex.bindCount=0,tex.unit=-1,textureUnits[i]=null)}values(textureSet).forEach((function(texture){texture.texture=gl.createTexture(),gl.bindTexture(texture.target,texture.texture);for(var i=0;i<32;++i)if(texture.mipmask&1<<i)if(texture.target===GL_TEXTURE_2D$1)gl.texImage2D(GL_TEXTURE_2D$1,i,texture.internalformat,texture.width>>i,texture.height>>i,0,texture.internalformat,texture.type,null);else for(var j=0;j<6;++j)gl.texImage2D(GL_TEXTURE_CUBE_MAP_POSITIVE_X$1+j,i,texture.internalformat,texture.width>>i,texture.height>>i,0,texture.internalformat,texture.type,null);setTexInfo(texture.texInfo,texture.target)}))},refresh:function(){for(var i=0;i<numTexUnits;++i){var tex=textureUnits[i];tex&&(tex.bindCount=0,tex.unit=-1,textureUnits[i]=null),gl.activeTexture(GL_TEXTURE0$1+i),gl.bindTexture(GL_TEXTURE_2D$1,null),gl.bindTexture(GL_TEXTURE_CUBE_MAP$1,null)}}}}FORMAT_SIZES_SPECIAL[GL_RGBA4]=2,FORMAT_SIZES_SPECIAL[GL_RGB5_A1]=2,FORMAT_SIZES_SPECIAL[GL_RGB565]=2,FORMAT_SIZES_SPECIAL[GL_DEPTH_STENCIL]=4,FORMAT_SIZES_SPECIAL[GL_COMPRESSED_RGB_S3TC_DXT1_EXT]=.5,FORMAT_SIZES_SPECIAL[GL_COMPRESSED_RGBA_S3TC_DXT1_EXT]=.5,FORMAT_SIZES_SPECIAL[GL_COMPRESSED_RGBA_S3TC_DXT3_EXT]=1,FORMAT_SIZES_SPECIAL[GL_COMPRESSED_RGBA_S3TC_DXT5_EXT]=1,FORMAT_SIZES_SPECIAL[GL_COMPRESSED_RGB_ATC_WEBGL]=.5,FORMAT_SIZES_SPECIAL[GL_COMPRESSED_RGBA_ATC_EXPLICIT_ALPHA_WEBGL]=1,FORMAT_SIZES_SPECIAL[GL_COMPRESSED_RGBA_ATC_INTERPOLATED_ALPHA_WEBGL]=1,FORMAT_SIZES_SPECIAL[GL_COMPRESSED_RGB_PVRTC_4BPPV1_IMG]=.5,FORMAT_SIZES_SPECIAL[GL_COMPRESSED_RGB_PVRTC_2BPPV1_IMG]=.25,FORMAT_SIZES_SPECIAL[GL_COMPRESSED_RGBA_PVRTC_4BPPV1_IMG]=.5,FORMAT_SIZES_SPECIAL[GL_COMPRESSED_RGBA_PVRTC_2BPPV1_IMG]=.25,FORMAT_SIZES_SPECIAL[GL_COMPRESSED_RGB_ETC1_WEBGL]=.5;var FORMAT_SIZES=[];function getRenderbufferSize(format,width,height){return FORMAT_SIZES[format]*width*height}FORMAT_SIZES[32854]=2,FORMAT_SIZES[32855]=2,FORMAT_SIZES[36194]=2,FORMAT_SIZES[33189]=2,FORMAT_SIZES[36168]=1,FORMAT_SIZES[34041]=4,FORMAT_SIZES[35907]=4,FORMAT_SIZES[34836]=16,FORMAT_SIZES[34842]=8,FORMAT_SIZES[34843]=6;var GL_FRAMEBUFFER$1=36160,GL_RENDERBUFFER$1=36161,GL_TEXTURE_2D$2=3553,GL_TEXTURE_CUBE_MAP_POSITIVE_X$2=34069,GL_COLOR_ATTACHMENT0$1=36064,GL_DEPTH_ATTACHMENT=36096,GL_STENCIL_ATTACHMENT=36128,GL_DEPTH_STENCIL_ATTACHMENT=33306,GL_FRAMEBUFFER_COMPLETE$1=36053,GL_DEPTH_COMPONENT$1=6402,colorTextureFormatEnums=[6407,6408],textureFormatChannels=[];textureFormatChannels[6408]=4,textureFormatChannels[6407]=3;var textureTypeSizes=[];textureTypeSizes[5121]=1,textureTypeSizes[5126]=4,textureTypeSizes[36193]=2;var GL_DEPTH_COMPONENT16$1=33189,GL_STENCIL_INDEX8$1=36168,GL_DEPTH_STENCIL$2=34041,colorRenderbufferFormatEnums=[32854,32855,36194,35907,34842,34843,34836],statusCode={};statusCode[GL_FRAMEBUFFER_COMPLETE$1]="complete",statusCode[36054]="incomplete attachment",statusCode[36057]="incomplete dimensions",statusCode[36055]="incomplete, missing attachment",statusCode[36061]="unsupported";var GL_FLOAT$6=5126,GL_ARRAY_BUFFER$1=34962,GL_ELEMENT_ARRAY_BUFFER$1=34963,VAO_OPTIONS=["attributes","elements","offset","count","primitive","instances"];function AttributeRecord(){this.state=0,this.x=0,this.y=0,this.z=0,this.w=0,this.buffer=null,this.size=0,this.normalized=!1,this.type=GL_FLOAT$6,this.offset=0,this.stride=0,this.divisor=0}var GL_FRAGMENT_SHADER=35632,GL_VERTEX_SHADER=35633,GL_ACTIVE_UNIFORMS=35718,GL_ACTIVE_ATTRIBUTES=35721,GL_RGBA$3=6408,GL_UNSIGNED_BYTE$7=5121,GL_PACK_ALIGNMENT=3333,GL_FLOAT$7=5126;function wrapReadPixels(gl,framebufferState,reglPoll,context,glAttributes,extensions,limits){function readPixelsImpl(input){var type;null===framebufferState.next?(check$1(glAttributes.preserveDrawingBuffer,'you must create a webgl context with "preserveDrawingBuffer":true in order to read pixels from the drawing buffer'),type=GL_UNSIGNED_BYTE$7):(check$1(null!==framebufferState.next.colorAttachments[0].texture,"You cannot read from a renderbuffer"),type=framebufferState.next.colorAttachments[0].texture._texture.type,check$1.optional((function(){extensions.oes_texture_float?(check$1(type===GL_UNSIGNED_BYTE$7||type===GL_FLOAT$7,"Reading from a framebuffer is only allowed for the types 'uint8' and 'float'"),type===GL_FLOAT$7&&check$1(limits.readFloat,"Reading 'float' values is not permitted in your browser. For a fallback, please see: https://www.npmjs.com/package/glsl-read-float")):check$1(type===GL_UNSIGNED_BYTE$7,"Reading from a framebuffer is only allowed for the type 'uint8'")})));var x=0,y=0,width=context.framebufferWidth,height=context.framebufferHeight,data=null;isTypedArray(input)?data=input:input&&(check$1.type(input,"object","invalid arguments to regl.read()"),x=0|input.x,y=0|input.y,check$1(x>=0&&x<context.framebufferWidth,"invalid x offset for regl.read"),check$1(y>=0&&y<context.framebufferHeight,"invalid y offset for regl.read"),width=0|(input.width||context.framebufferWidth-x),height=0|(input.height||context.framebufferHeight-y),data=input.data||null),data&&(type===GL_UNSIGNED_BYTE$7?check$1(data instanceof Uint8Array,"buffer must be 'Uint8Array' when reading from a framebuffer of type 'uint8'"):type===GL_FLOAT$7&&check$1(data instanceof Float32Array,"buffer must be 'Float32Array' when reading from a framebuffer of type 'float'")),check$1(width>0&&width+x<=context.framebufferWidth,"invalid width for read pixels"),check$1(height>0&&height+y<=context.framebufferHeight,"invalid height for read pixels"),reglPoll();var size=width*height*4;return data||(type===GL_UNSIGNED_BYTE$7?data=new Uint8Array(size):type===GL_FLOAT$7&&(data=data||new Float32Array(size))),check$1.isTypedArray(data,"data buffer for regl.read() must be a typedarray"),check$1(data.byteLength>=size,"data buffer for regl.read() too small"),gl.pixelStorei(GL_PACK_ALIGNMENT,4),gl.readPixels(x,y,width,height,GL_RGBA$3,type,data),data}return function(options){return options&&"framebuffer"in options?function(options){var result;return framebufferState.setFBO({framebuffer:options.framebuffer},(function(){result=readPixelsImpl(options)})),result}(options):readPixelsImpl(options)}}function slice(x){return Array.prototype.slice.call(x)}function join(x){return slice(x).join("")}var CUTE_COMPONENTS="xyzw".split(""),GL_UNSIGNED_BYTE$8=5121,ATTRIB_STATE_POINTER=1,ATTRIB_STATE_CONSTANT=2,DYN_FUNC$1=0,DYN_PROP$1=1,DYN_CONTEXT$1=2,DYN_STATE$1=3,DYN_THUNK=4,DYN_CONSTANT$1=5,DYN_ARRAY$1=6,S_DITHER="dither",S_BLEND_ENABLE="blend.enable",S_BLEND_COLOR="blend.color",S_BLEND_EQUATION="blend.equation",S_BLEND_FUNC="blend.func",S_DEPTH_ENABLE="depth.enable",S_DEPTH_FUNC="depth.func",S_DEPTH_RANGE="depth.range",S_DEPTH_MASK="depth.mask",S_COLOR_MASK="colorMask",S_CULL_ENABLE="cull.enable",S_CULL_FACE="cull.face",S_FRONT_FACE="frontFace",S_LINE_WIDTH="lineWidth",S_POLYGON_OFFSET_ENABLE="polygonOffset.enable",S_POLYGON_OFFSET_OFFSET="polygonOffset.offset",S_SAMPLE_ALPHA="sample.alpha",S_SAMPLE_ENABLE="sample.enable",S_SAMPLE_COVERAGE="sample.coverage",S_STENCIL_ENABLE="stencil.enable",S_STENCIL_MASK="stencil.mask",S_STENCIL_FUNC="stencil.func",S_STENCIL_OPFRONT="stencil.opFront",S_STENCIL_OPBACK="stencil.opBack",S_SCISSOR_ENABLE="scissor.enable",S_SCISSOR_BOX="scissor.box",S_VIEWPORT="viewport",S_PROFILE="profile",S_FRAMEBUFFER="framebuffer",S_VERT="vert",S_FRAG="frag",S_ELEMENTS="elements",S_PRIMITIVE="primitive",S_COUNT="count",S_OFFSET="offset",S_INSTANCES="instances",S_VAO="vao",S_FRAMEBUFFER_WIDTH=S_FRAMEBUFFER+"Width",S_FRAMEBUFFER_HEIGHT=S_FRAMEBUFFER+"Height",S_VIEWPORT_WIDTH=S_VIEWPORT+"Width",S_VIEWPORT_HEIGHT=S_VIEWPORT+"Height",S_DRAWINGBUFFER_WIDTH="drawingBufferWidth",S_DRAWINGBUFFER_HEIGHT="drawingBufferHeight",NESTED_OPTIONS=[S_BLEND_FUNC,S_BLEND_EQUATION,S_STENCIL_FUNC,S_STENCIL_OPFRONT,S_STENCIL_OPBACK,S_SAMPLE_COVERAGE,S_VIEWPORT,S_SCISSOR_BOX,S_POLYGON_OFFSET_OFFSET],GL_ARRAY_BUFFER$2=34962,GL_ELEMENT_ARRAY_BUFFER$2=34963,GL_TEXTURE_2D$3=3553,GL_TEXTURE_CUBE_MAP$2=34067,GL_CULL_FACE=2884,GL_BLEND=3042,GL_DITHER=3024,GL_STENCIL_TEST=2960,GL_DEPTH_TEST=2929,GL_SCISSOR_TEST=3089,GL_POLYGON_OFFSET_FILL=32823,GL_SAMPLE_ALPHA_TO_COVERAGE=32926,GL_SAMPLE_COVERAGE=32928,GL_FLOAT$8=5126,GL_FLOAT_VEC2=35664,GL_FLOAT_VEC3=35665,GL_FLOAT_VEC4=35666,GL_INT$3=5124,GL_INT_VEC2=35667,GL_INT_VEC3=35668,GL_INT_VEC4=35669,GL_BOOL=35670,GL_BOOL_VEC2=35671,GL_BOOL_VEC3=35672,GL_BOOL_VEC4=35673,GL_FLOAT_MAT2=35674,GL_FLOAT_MAT3=35675,GL_FLOAT_MAT4=35676,GL_SAMPLER_2D=35678,GL_SAMPLER_CUBE=35680,GL_TRIANGLES$1=4,GL_FRONT=1028,GL_BACK=1029,GL_CW=2304,GL_CCW=2305,GL_MIN_EXT=32775,GL_MAX_EXT=32776,GL_ALWAYS=519,GL_KEEP=7680,GL_ZERO=0,GL_ONE=1,GL_FUNC_ADD=32774,GL_LESS=513,GL_FRAMEBUFFER$2=36160,GL_COLOR_ATTACHMENT0$2=36064,blendFuncs={0:0,1:1,zero:0,one:1,"src color":768,"one minus src color":769,"src alpha":770,"one minus src alpha":771,"dst color":774,"one minus dst color":775,"dst alpha":772,"one minus dst alpha":773,"constant color":32769,"one minus constant color":32770,"constant alpha":32771,"one minus constant alpha":32772,"src alpha saturate":776},invalidBlendCombinations=["constant color, constant alpha","one minus constant color, constant alpha","constant color, one minus constant alpha","one minus constant color, one minus constant alpha","constant alpha, constant color","constant alpha, one minus constant color","one minus constant alpha, constant color","one minus constant alpha, one minus constant color"],compareFuncs={never:512,less:513,"<":513,equal:514,"=":514,"==":514,"===":514,lequal:515,"<=":515,greater:516,">":516,notequal:517,"!=":517,"!==":517,gequal:518,">=":518,always:519},stencilOps={0:0,zero:0,keep:7680,replace:7681,increment:7682,decrement:7683,"increment wrap":34055,"decrement wrap":34056,invert:5386},shaderType={frag:35632,vert:35633},orientationType={cw:GL_CW,ccw:GL_CCW};function isBufferArgs(x){return Array.isArray(x)||isTypedArray(x)||isNDArrayLike(x)}function sortState(state){return state.sort((function(a,b){return a===S_VIEWPORT?-1:b===S_VIEWPORT?1:a<b?-1:1}))}function Declaration(thisDep,contextDep,propDep,append){this.thisDep=thisDep,this.contextDep=contextDep,this.propDep=propDep,this.append=append}function isStatic(decl){return decl&&!(decl.thisDep||decl.contextDep||decl.propDep)}function createStaticDecl(append){return new Declaration(!1,!1,!1,append)}function createDynamicDecl(dyn,append){var type=dyn.type;if(type===DYN_FUNC$1){var numArgs=dyn.data.length;return new Declaration(!0,numArgs>=1,numArgs>=2,append)}if(type===DYN_THUNK){var data=dyn.data;return new Declaration(data.thisDep,data.contextDep,data.propDep,append)}if(type===DYN_CONSTANT$1)return new Declaration(!1,!1,!1,append);if(type===DYN_ARRAY$1){for(var thisDep=!1,contextDep=!1,propDep=!1,i=0;i<dyn.data.length;++i){var subDyn=dyn.data[i];if(subDyn.type===DYN_PROP$1)propDep=!0;else if(subDyn.type===DYN_CONTEXT$1)contextDep=!0;else if(subDyn.type===DYN_STATE$1)thisDep=!0;else if(subDyn.type===DYN_FUNC$1){thisDep=!0;var subArgs=subDyn.data;subArgs>=1&&(contextDep=!0),subArgs>=2&&(propDep=!0)}else subDyn.type===DYN_THUNK&&(thisDep=thisDep||subDyn.data.thisDep,contextDep=contextDep||subDyn.data.contextDep,propDep=propDep||subDyn.data.propDep)}return new Declaration(thisDep,contextDep,propDep,append)}return new Declaration(type===DYN_STATE$1,type===DYN_CONTEXT$1,type===DYN_PROP$1,append)}var SCOPE_DECL=new Declaration(!1,!1,!1,(function(){}));function reglCore(gl,stringStore,extensions,limits,bufferState,elementState,textureState,framebufferState,uniformState,attributeState,shaderState,drawState,contextState,timer,config){var AttributeRecord=attributeState.Record,blendEquations={add:32774,subtract:32778,"reverse subtract":32779};extensions.ext_blend_minmax&&(blendEquations.min=GL_MIN_EXT,blendEquations.max=GL_MAX_EXT);var extInstancing=extensions.angle_instanced_arrays,extDrawBuffers=extensions.webgl_draw_buffers,extVertexArrays=extensions.oes_vertex_array_object,currentState={dirty:!0,profile:config.profile},nextState={},GL_STATE_NAMES=[],GL_FLAGS={},GL_VARIABLES={};function propName(name){return name.replace(".","_")}function stateFlag(sname,cap,init){var name=propName(sname);GL_STATE_NAMES.push(sname),nextState[name]=currentState[name]=!!init,GL_FLAGS[name]=cap}function stateVariable(sname,func,init){var name=propName(sname);GL_STATE_NAMES.push(sname),Array.isArray(init)?(currentState[name]=init.slice(),nextState[name]=init.slice()):currentState[name]=nextState[name]=init,GL_VARIABLES[name]=func}stateFlag(S_DITHER,GL_DITHER),stateFlag(S_BLEND_ENABLE,GL_BLEND),stateVariable(S_BLEND_COLOR,"blendColor",[0,0,0,0]),stateVariable(S_BLEND_EQUATION,"blendEquationSeparate",[GL_FUNC_ADD,GL_FUNC_ADD]),stateVariable(S_BLEND_FUNC,"blendFuncSeparate",[GL_ONE,GL_ZERO,GL_ONE,GL_ZERO]),stateFlag(S_DEPTH_ENABLE,GL_DEPTH_TEST,!0),stateVariable(S_DEPTH_FUNC,"depthFunc",GL_LESS),stateVariable(S_DEPTH_RANGE,"depthRange",[0,1]),stateVariable(S_DEPTH_MASK,"depthMask",!0),stateVariable(S_COLOR_MASK,S_COLOR_MASK,[!0,!0,!0,!0]),stateFlag(S_CULL_ENABLE,GL_CULL_FACE),stateVariable(S_CULL_FACE,"cullFace",GL_BACK),stateVariable(S_FRONT_FACE,S_FRONT_FACE,GL_CCW),stateVariable(S_LINE_WIDTH,S_LINE_WIDTH,1),stateFlag(S_POLYGON_OFFSET_ENABLE,GL_POLYGON_OFFSET_FILL),stateVariable(S_POLYGON_OFFSET_OFFSET,"polygonOffset",[0,0]),stateFlag(S_SAMPLE_ALPHA,GL_SAMPLE_ALPHA_TO_COVERAGE),stateFlag(S_SAMPLE_ENABLE,GL_SAMPLE_COVERAGE),stateVariable(S_SAMPLE_COVERAGE,"sampleCoverage",[1,!1]),stateFlag(S_STENCIL_ENABLE,GL_STENCIL_TEST),stateVariable(S_STENCIL_MASK,"stencilMask",-1),stateVariable(S_STENCIL_FUNC,"stencilFunc",[GL_ALWAYS,0,-1]),stateVariable(S_STENCIL_OPFRONT,"stencilOpSeparate",[GL_FRONT,GL_KEEP,GL_KEEP,GL_KEEP]),stateVariable(S_STENCIL_OPBACK,"stencilOpSeparate",[GL_BACK,GL_KEEP,GL_KEEP,GL_KEEP]),stateFlag(S_SCISSOR_ENABLE,GL_SCISSOR_TEST),stateVariable(S_SCISSOR_BOX,"scissor",[0,0,gl.drawingBufferWidth,gl.drawingBufferHeight]),stateVariable(S_VIEWPORT,S_VIEWPORT,[0,0,gl.drawingBufferWidth,gl.drawingBufferHeight]);var sharedState={gl:gl,context:contextState,strings:stringStore,next:nextState,current:currentState,draw:drawState,elements:elementState,buffer:bufferState,shader:shaderState,attributes:attributeState.state,vao:attributeState,uniforms:uniformState,framebuffer:framebufferState,extensions:extensions,timer:timer,isBufferArgs:isBufferArgs},sharedConstants={primTypes:primTypes,compareFuncs:compareFuncs,blendFuncs:blendFuncs,blendEquations:blendEquations,stencilOps:stencilOps,glTypes:glTypes,orientationType:orientationType};check$1.optional((function(){sharedState.isArrayLike=isArrayLike})),extDrawBuffers&&(sharedConstants.backBuffer=[GL_BACK],sharedConstants.drawBuffer=loop(limits.maxDrawbuffers,(function(i){return 0===i?[0]:loop(i,(function(j){return GL_COLOR_ATTACHMENT0$2+j}))})));var drawCallCounter=0;function createREGLEnvironment(){var env=function(){var varCounter=0,linkedNames=[],linkedValues=[];function block(){var code=[],vars=[];return extend((function(){code.push.apply(code,slice(arguments))}),{def:function(){var name="v"+varCounter++;return vars.push(name),arguments.length>0&&(code.push(name,"="),code.push.apply(code,slice(arguments)),code.push(";")),name},toString:function(){return join([vars.length>0?"var "+vars.join(",")+";":"",join(code)])}})}function scope(){var entry=block(),exit=block(),entryToString=entry.toString,exitToString=exit.toString;function save(object,prop){exit(object,prop,"=",entry.def(object,prop),";")}return extend((function(){entry.apply(entry,slice(arguments))}),{def:entry.def,entry:entry,exit:exit,save:save,set:function(object,prop,value){save(object,prop),entry(object,prop,"=",value,";")},toString:function(){return entryToString()+exitToString()}})}var globalBlock=block(),procedures={};return{global:globalBlock,link:function(value){for(var i=0;i<linkedValues.length;++i)if(linkedValues[i]===value)return linkedNames[i];var name="g"+varCounter++;return linkedNames.push(name),linkedValues.push(value),name},block:block,proc:function(name,count){var args=[];function arg(){var name="a"+args.length;return args.push(name),name}count=count||0;for(var i=0;i<count;++i)arg();var body=scope(),bodyToString=body.toString;return procedures[name]=extend(body,{arg:arg,toString:function(){return join(["function(",args.join(),"){",bodyToString(),"}"])}})},scope:scope,cond:function(){var pred=join(arguments),thenBlock=scope(),elseBlock=scope(),thenToString=thenBlock.toString,elseToString=elseBlock.toString;return extend(thenBlock,{then:function(){return thenBlock.apply(thenBlock,slice(arguments)),this},else:function(){return elseBlock.apply(elseBlock,slice(arguments)),this},toString:function(){var elseClause=elseToString();return elseClause&&(elseClause="else{"+elseClause+"}"),join(["if(",pred,"){",thenToString(),"}",elseClause])}})},compile:function(){var code=['"use strict";',globalBlock,"return {"];Object.keys(procedures).forEach((function(name){code.push('"',name,'":',procedures[name].toString(),",")})),code.push("}");var src=join(code).replace(/;/g,";\n").replace(/}/g,"}\n").replace(/{/g,"{\n");return Function.apply(null,linkedNames.concat(src)).apply(null,linkedValues)}}}(),link=env.link,global=env.global;env.id=drawCallCounter++,env.batchId="0";var SHARED=link(sharedState),shared=env.shared={props:"a0"};Object.keys(sharedState).forEach((function(prop){shared[prop]=global.def(SHARED,".",prop)})),check$1.optional((function(){env.CHECK=link(check$1),env.commandStr=check$1.guessCommand(),env.command=link(env.commandStr),env.assert=function(block,pred,message){block("if(!(",pred,"))",this.CHECK,".commandRaise(",link(message),",",this.command,");")},sharedConstants.invalidBlendCombinations=invalidBlendCombinations}));var nextVars=env.next={},currentVars=env.current={};Object.keys(GL_VARIABLES).forEach((function(variable){Array.isArray(currentState[variable])&&(nextVars[variable]=global.def(shared.next,".",variable),currentVars[variable]=global.def(shared.current,".",variable))}));var constants=env.constants={};Object.keys(sharedConstants).forEach((function(name){constants[name]=global.def(JSON.stringify(sharedConstants[name]))})),env.invoke=function(block,x){switch(x.type){case DYN_FUNC$1:var argList=["this",shared.context,shared.props,env.batchId];return block.def(link(x.data),".call(",argList.slice(0,Math.max(x.data.length+1,4)),")");case DYN_PROP$1:return block.def(shared.props,x.data);case DYN_CONTEXT$1:return block.def(shared.context,x.data);case DYN_STATE$1:return block.def("this",x.data);case DYN_THUNK:return x.data.append(env,block),x.data.ref;case DYN_CONSTANT$1:return x.data.toString();case DYN_ARRAY$1:return x.data.map((function(y){return env.invoke(block,y)}))}},env.attribCache={};var scopeAttribs={};return env.scopeAttrib=function(name){var id=stringStore.id(name);if(id in scopeAttribs)return scopeAttribs[id];var binding=attributeState.scope[id];return binding||(binding=attributeState.scope[id]=new AttributeRecord),scopeAttribs[id]=link(binding)},env}function parseArguments(options,attributes,uniforms,context,env){var staticOptions=options.static,dynamicOptions=options.dynamic;check$1.optional((function(){var KEY_NAMES=[S_FRAMEBUFFER,S_VERT,S_FRAG,S_ELEMENTS,S_PRIMITIVE,S_OFFSET,S_COUNT,S_INSTANCES,S_PROFILE,S_VAO].concat(GL_STATE_NAMES);function checkKeys(dict){Object.keys(dict).forEach((function(key){check$1.command(KEY_NAMES.indexOf(key)>=0,'unknown parameter "'+key+'"',env.commandStr)}))}checkKeys(staticOptions),checkKeys(dynamicOptions)}));var attribLocations=function(options,attributes){var staticOptions=options.static;if("string"==typeof staticOptions[S_FRAG]&&"string"==typeof staticOptions[S_VERT]){if(Object.keys(attributes.dynamic).length>0)return null;var staticAttributes=attributes.static,sAttributes=Object.keys(staticAttributes);if(sAttributes.length>0&&"number"==typeof staticAttributes[sAttributes[0]]){for(var bindings=[],i=0;i<sAttributes.length;++i)check$1("number"==typeof staticAttributes[sAttributes[i]],"must specify all vertex attribute locations when using vaos"),bindings.push([0|staticAttributes[sAttributes[i]],sAttributes[i]]);return bindings}}return null}(options,attributes),framebuffer=function(options,env){var staticOptions=options.static,dynamicOptions=options.dynamic;if(S_FRAMEBUFFER in staticOptions){var framebuffer=staticOptions[S_FRAMEBUFFER];return framebuffer?(framebuffer=framebufferState.getFramebuffer(framebuffer),check$1.command(framebuffer,"invalid framebuffer object"),createStaticDecl((function(env,block){var FRAMEBUFFER=env.link(framebuffer),shared=env.shared;block.set(shared.framebuffer,".next",FRAMEBUFFER);var CONTEXT=shared.context;return block.set(CONTEXT,"."+S_FRAMEBUFFER_WIDTH,FRAMEBUFFER+".width"),block.set(CONTEXT,"."+S_FRAMEBUFFER_HEIGHT,FRAMEBUFFER+".height"),FRAMEBUFFER}))):createStaticDecl((function(env,scope){var shared=env.shared;scope.set(shared.framebuffer,".next","null");var CONTEXT=shared.context;return scope.set(CONTEXT,"."+S_FRAMEBUFFER_WIDTH,CONTEXT+"."+S_DRAWINGBUFFER_WIDTH),scope.set(CONTEXT,"."+S_FRAMEBUFFER_HEIGHT,CONTEXT+"."+S_DRAWINGBUFFER_HEIGHT),"null"}))}if(S_FRAMEBUFFER in dynamicOptions){var dyn=dynamicOptions[S_FRAMEBUFFER];return createDynamicDecl(dyn,(function(env,scope){var FRAMEBUFFER_FUNC=env.invoke(scope,dyn),shared=env.shared,FRAMEBUFFER_STATE=shared.framebuffer,FRAMEBUFFER=scope.def(FRAMEBUFFER_STATE,".getFramebuffer(",FRAMEBUFFER_FUNC,")");check$1.optional((function(){env.assert(scope,"!"+FRAMEBUFFER_FUNC+"||"+FRAMEBUFFER,"invalid framebuffer object")})),scope.set(FRAMEBUFFER_STATE,".next",FRAMEBUFFER);var CONTEXT=shared.context;return scope.set(CONTEXT,"."+S_FRAMEBUFFER_WIDTH,FRAMEBUFFER+"?"+FRAMEBUFFER+".width:"+CONTEXT+"."+S_DRAWINGBUFFER_WIDTH),scope.set(CONTEXT,"."+S_FRAMEBUFFER_HEIGHT,FRAMEBUFFER+"?"+FRAMEBUFFER+".height:"+CONTEXT+"."+S_DRAWINGBUFFER_HEIGHT),FRAMEBUFFER}))}return null}(options),viewportAndScissor=function(options,framebuffer,env){var staticOptions=options.static,dynamicOptions=options.dynamic;function parseBox(param){if(param in staticOptions){var box=staticOptions[param];check$1.commandType(box,"object","invalid "+param,env.commandStr);var w,h,isStatic=!0,x=0|box.x,y=0|box.y;return"width"in box?(w=0|box.width,check$1.command(w>=0,"invalid "+param,env.commandStr)):isStatic=!1,"height"in box?(h=0|box.height,check$1.command(h>=0,"invalid "+param,env.commandStr)):isStatic=!1,new Declaration(!isStatic&&framebuffer&&framebuffer.thisDep,!isStatic&&framebuffer&&framebuffer.contextDep,!isStatic&&framebuffer&&framebuffer.propDep,(function(env,scope){var CONTEXT=env.shared.context,BOX_W=w;"width"in box||(BOX_W=scope.def(CONTEXT,".",S_FRAMEBUFFER_WIDTH,"-",x));var BOX_H=h;return"height"in box||(BOX_H=scope.def(CONTEXT,".",S_FRAMEBUFFER_HEIGHT,"-",y)),[x,y,BOX_W,BOX_H]}))}if(param in dynamicOptions){var dynBox=dynamicOptions[param],result=createDynamicDecl(dynBox,(function(env,scope){var BOX=env.invoke(scope,dynBox);check$1.optional((function(){env.assert(scope,BOX+"&&typeof "+BOX+'==="object"',"invalid "+param)}));var CONTEXT=env.shared.context,BOX_X=scope.def(BOX,".x|0"),BOX_Y=scope.def(BOX,".y|0"),BOX_W=scope.def('"width" in ',BOX,"?",BOX,".width|0:","(",CONTEXT,".",S_FRAMEBUFFER_WIDTH,"-",BOX_X,")"),BOX_H=scope.def('"height" in ',BOX,"?",BOX,".height|0:","(",CONTEXT,".",S_FRAMEBUFFER_HEIGHT,"-",BOX_Y,")");return check$1.optional((function(){env.assert(scope,BOX_W+">=0&&"+BOX_H+">=0","invalid "+param)})),[BOX_X,BOX_Y,BOX_W,BOX_H]}));return framebuffer&&(result.thisDep=result.thisDep||framebuffer.thisDep,result.contextDep=result.contextDep||framebuffer.contextDep,result.propDep=result.propDep||framebuffer.propDep),result}return framebuffer?new Declaration(framebuffer.thisDep,framebuffer.contextDep,framebuffer.propDep,(function(env,scope){var CONTEXT=env.shared.context;return[0,0,scope.def(CONTEXT,".",S_FRAMEBUFFER_WIDTH),scope.def(CONTEXT,".",S_FRAMEBUFFER_HEIGHT)]})):null}var viewport=parseBox(S_VIEWPORT);if(viewport){var prevViewport=viewport;viewport=new Declaration(viewport.thisDep,viewport.contextDep,viewport.propDep,(function(env,scope){var VIEWPORT=prevViewport.append(env,scope),CONTEXT=env.shared.context;return scope.set(CONTEXT,"."+S_VIEWPORT_WIDTH,VIEWPORT[2]),scope.set(CONTEXT,"."+S_VIEWPORT_HEIGHT,VIEWPORT[3]),VIEWPORT}))}return{viewport:viewport,scissor_box:parseBox(S_SCISSOR_BOX)}}(options,framebuffer,env),draw=function(options,env){var staticOptions=options.static,dynamicOptions=options.dynamic,staticDraw={},vaoActive=!1,vao=function(){if(S_VAO in staticOptions){var vao=staticOptions[S_VAO];return null!==vao&&null===attributeState.getVAO(vao)&&(vao=attributeState.createVAO(vao)),vaoActive=!0,staticDraw.vao=vao,createStaticDecl((function(env){var vaoRef=attributeState.getVAO(vao);return vaoRef?env.link(vaoRef):"null"}))}if(S_VAO in dynamicOptions){vaoActive=!0;var dyn=dynamicOptions[S_VAO];return createDynamicDecl(dyn,(function(env,scope){var vaoRef=env.invoke(scope,dyn);return scope.def(env.shared.vao+".getVAO("+vaoRef+")")}))}return null}(),elementsActive=!1,elements=function(){if(S_ELEMENTS in staticOptions){var elements=staticOptions[S_ELEMENTS];if(staticDraw.elements=elements,isBufferArgs(elements)){var e=staticDraw.elements=elementState.create(elements,!0);elements=elementState.getElements(e),elementsActive=!0}else elements&&(elements=elementState.getElements(elements),elementsActive=!0,check$1.command(elements,"invalid elements",env.commandStr));var result=createStaticDecl((function(env,scope){if(elements){var result=env.link(elements);return env.ELEMENTS=result,result}return env.ELEMENTS=null,null}));return result.value=elements,result}if(S_ELEMENTS in dynamicOptions){elementsActive=!0;var dyn=dynamicOptions[S_ELEMENTS];return createDynamicDecl(dyn,(function(env,scope){var shared=env.shared,IS_BUFFER_ARGS=shared.isBufferArgs,ELEMENT_STATE=shared.elements,elementDefn=env.invoke(scope,dyn),elements=scope.def("null"),elementStream=scope.def(IS_BUFFER_ARGS,"(",elementDefn,")"),ifte=env.cond(elementStream).then(elements,"=",ELEMENT_STATE,".createStream(",elementDefn,");").else(elements,"=",ELEMENT_STATE,".getElements(",elementDefn,");");return check$1.optional((function(){env.assert(ifte.else,"!"+elementDefn+"||"+elements,"invalid elements")})),scope.entry(ifte),scope.exit(env.cond(elementStream).then(ELEMENT_STATE,".destroyStream(",elements,");")),env.ELEMENTS=elements,elements}))}return vaoActive?new Declaration(vao.thisDep,vao.contextDep,vao.propDep,(function(env,scope){return scope.def(env.shared.vao+".currentVAO?"+env.shared.elements+".getElements("+env.shared.vao+".currentVAO.elements):null")})):null}();function parseParam(param,isOffset){if(param in staticOptions){var value=0|staticOptions[param];return isOffset?staticDraw.offset=value:staticDraw.instances=value,check$1.command(!isOffset||value>=0,"invalid "+param,env.commandStr),createStaticDecl((function(env,scope){return isOffset&&(env.OFFSET=value),value}))}if(param in dynamicOptions){var dynValue=dynamicOptions[param];return createDynamicDecl(dynValue,(function(env,scope){var result=env.invoke(scope,dynValue);return isOffset&&(env.OFFSET=result,check$1.optional((function(){env.assert(scope,result+">=0","invalid "+param)}))),result}))}if(isOffset){if(elementsActive)return createStaticDecl((function(env,scope){return env.OFFSET=0,0}));if(vaoActive)return new Declaration(vao.thisDep,vao.contextDep,vao.propDep,(function(env,scope){return scope.def(env.shared.vao+".currentVAO?"+env.shared.vao+".currentVAO.offset:0")}))}else if(vaoActive)return new Declaration(vao.thisDep,vao.contextDep,vao.propDep,(function(env,scope){return scope.def(env.shared.vao+".currentVAO?"+env.shared.vao+".currentVAO.instances:-1")}));return null}var OFFSET=parseParam(S_OFFSET,!0),primitive=function(){if(S_PRIMITIVE in staticOptions){var primitive=staticOptions[S_PRIMITIVE];return staticDraw.primitive=primitive,check$1.commandParameter(primitive,primTypes,"invalid primitve",env.commandStr),createStaticDecl((function(env,scope){return primTypes[primitive]}))}if(S_PRIMITIVE in dynamicOptions){var dynPrimitive=dynamicOptions[S_PRIMITIVE];return createDynamicDecl(dynPrimitive,(function(env,scope){var PRIM_TYPES=env.constants.primTypes,prim=env.invoke(scope,dynPrimitive);return check$1.optional((function(){env.assert(scope,prim+" in "+PRIM_TYPES,"invalid primitive, must be one of "+Object.keys(primTypes))})),scope.def(PRIM_TYPES,"[",prim,"]")}))}return elementsActive?isStatic(elements)?elements.value?createStaticDecl((function(env,scope){return scope.def(env.ELEMENTS,".primType")})):createStaticDecl((function(){return GL_TRIANGLES$1})):new Declaration(elements.thisDep,elements.contextDep,elements.propDep,(function(env,scope){var elements=env.ELEMENTS;return scope.def(elements,"?",elements,".primType:",GL_TRIANGLES$1)})):vaoActive?new Declaration(vao.thisDep,vao.contextDep,vao.propDep,(function(env,scope){return scope.def(env.shared.vao+".currentVAO?"+env.shared.vao+".currentVAO.primitive:"+GL_TRIANGLES$1)})):null}(),count=function(){if(S_COUNT in staticOptions){var count=0|staticOptions[S_COUNT];return staticDraw.count=count,check$1.command("number"==typeof count&&count>=0,"invalid vertex count",env.commandStr),createStaticDecl((function(){return count}))}if(S_COUNT in dynamicOptions){var dynCount=dynamicOptions[S_COUNT];return createDynamicDecl(dynCount,(function(env,scope){var result=env.invoke(scope,dynCount);return check$1.optional((function(){env.assert(scope,"typeof "+result+'==="number"&&'+result+">=0&&"+result+"===("+result+"|0)","invalid vertex count")})),result}))}if(elementsActive){if(isStatic(elements)){if(elements)return OFFSET?new Declaration(OFFSET.thisDep,OFFSET.contextDep,OFFSET.propDep,(function(env,scope){var result=scope.def(env.ELEMENTS,".vertCount-",env.OFFSET);return check$1.optional((function(){env.assert(scope,result+">=0","invalid vertex offset/element buffer too small")})),result})):createStaticDecl((function(env,scope){return scope.def(env.ELEMENTS,".vertCount")}));var result=createStaticDecl((function(){return-1}));return check$1.optional((function(){result.MISSING=!0})),result}var variable=new Declaration(elements.thisDep||OFFSET.thisDep,elements.contextDep||OFFSET.contextDep,elements.propDep||OFFSET.propDep,(function(env,scope){var elements=env.ELEMENTS;return env.OFFSET?scope.def(elements,"?",elements,".vertCount-",env.OFFSET,":-1"):scope.def(elements,"?",elements,".vertCount:-1")}));return check$1.optional((function(){variable.DYNAMIC=!0})),variable}if(vaoActive){var countVariable=new Declaration(vao.thisDep,vao.contextDep,vao.propDep,(function(env,scope){return scope.def(env.shared.vao,".currentVAO?",env.shared.vao,".currentVAO.count:-1")}));return countVariable}return null}(),instances=parseParam(S_INSTANCES,!1);return{elements:elements,primitive:primitive,count:count,instances:instances,offset:OFFSET,vao:vao,vaoActive:vaoActive,elementsActive:elementsActive,static:staticDraw}}(options,env),state=function(options,env){var staticOptions=options.static,dynamicOptions=options.dynamic,STATE={};return GL_STATE_NAMES.forEach((function(prop){var param=propName(prop);function parseParam(parseStatic,parseDynamic){if(prop in staticOptions){var value=parseStatic(staticOptions[prop]);STATE[param]=createStaticDecl((function(){return value}))}else if(prop in dynamicOptions){var dyn=dynamicOptions[prop];STATE[param]=createDynamicDecl(dyn,(function(env,scope){return parseDynamic(env,scope,env.invoke(scope,dyn))}))}}switch(prop){case S_CULL_ENABLE:case S_BLEND_ENABLE:case S_DITHER:case S_STENCIL_ENABLE:case S_DEPTH_ENABLE:case S_SCISSOR_ENABLE:case S_POLYGON_OFFSET_ENABLE:case S_SAMPLE_ALPHA:case S_SAMPLE_ENABLE:case S_DEPTH_MASK:return parseParam((function(value){return check$1.commandType(value,"boolean",prop,env.commandStr),value}),(function(env,scope,value){return check$1.optional((function(){env.assert(scope,"typeof "+value+'==="boolean"',"invalid flag "+prop,env.commandStr)})),value}));case S_DEPTH_FUNC:return parseParam((function(value){return check$1.commandParameter(value,compareFuncs,"invalid "+prop,env.commandStr),compareFuncs[value]}),(function(env,scope,value){var COMPARE_FUNCS=env.constants.compareFuncs;return check$1.optional((function(){env.assert(scope,value+" in "+COMPARE_FUNCS,"invalid "+prop+", must be one of "+Object.keys(compareFuncs))})),scope.def(COMPARE_FUNCS,"[",value,"]")}));case S_DEPTH_RANGE:return parseParam((function(value){return check$1.command(isArrayLike(value)&&2===value.length&&"number"==typeof value[0]&&"number"==typeof value[1]&&value[0]<=value[1],"depth range is 2d array",env.commandStr),value}),(function(env,scope,value){return check$1.optional((function(){env.assert(scope,env.shared.isArrayLike+"("+value+")&&"+value+".length===2&&typeof "+value+'[0]==="number"&&typeof '+value+'[1]==="number"&&'+value+"[0]<="+value+"[1]","depth range must be a 2d array")})),[scope.def("+",value,"[0]"),scope.def("+",value,"[1]")]}));case S_BLEND_FUNC:return parseParam((function(value){check$1.commandType(value,"object","blend.func",env.commandStr);var srcRGB="srcRGB"in value?value.srcRGB:value.src,srcAlpha="srcAlpha"in value?value.srcAlpha:value.src,dstRGB="dstRGB"in value?value.dstRGB:value.dst,dstAlpha="dstAlpha"in value?value.dstAlpha:value.dst;return check$1.commandParameter(srcRGB,blendFuncs,param+".srcRGB",env.commandStr),check$1.commandParameter(srcAlpha,blendFuncs,param+".srcAlpha",env.commandStr),check$1.commandParameter(dstRGB,blendFuncs,param+".dstRGB",env.commandStr),check$1.commandParameter(dstAlpha,blendFuncs,param+".dstAlpha",env.commandStr),check$1.command(-1===invalidBlendCombinations.indexOf(srcRGB+", "+dstRGB),"unallowed blending combination (srcRGB, dstRGB) = ("+srcRGB+", "+dstRGB+")",env.commandStr),[blendFuncs[srcRGB],blendFuncs[dstRGB],blendFuncs[srcAlpha],blendFuncs[dstAlpha]]}),(function(env,scope,value){var BLEND_FUNCS=env.constants.blendFuncs;function read(prefix,suffix){var func=scope.def('"',prefix,suffix,'" in ',value,"?",value,".",prefix,suffix,":",value,".",prefix);return check$1.optional((function(){env.assert(scope,func+" in "+BLEND_FUNCS,"invalid "+prop+"."+prefix+suffix+", must be one of "+Object.keys(blendFuncs))})),func}check$1.optional((function(){env.assert(scope,value+"&&typeof "+value+'==="object"',"invalid blend func, must be an object")}));var srcRGB=read("src","RGB"),dstRGB=read("dst","RGB");check$1.optional((function(){var INVALID_BLEND_COMBINATIONS=env.constants.invalidBlendCombinations;env.assert(scope,INVALID_BLEND_COMBINATIONS+".indexOf("+srcRGB+'+", "+'+dstRGB+") === -1 ","unallowed blending combination for (srcRGB, dstRGB)")}));var SRC_RGB=scope.def(BLEND_FUNCS,"[",srcRGB,"]"),SRC_ALPHA=scope.def(BLEND_FUNCS,"[",read("src","Alpha"),"]");return[SRC_RGB,scope.def(BLEND_FUNCS,"[",dstRGB,"]"),SRC_ALPHA,scope.def(BLEND_FUNCS,"[",read("dst","Alpha"),"]")]}));case S_BLEND_EQUATION:return parseParam((function(value){return"string"==typeof value?(check$1.commandParameter(value,blendEquations,"invalid "+prop,env.commandStr),[blendEquations[value],blendEquations[value]]):"object"==typeof value?(check$1.commandParameter(value.rgb,blendEquations,prop+".rgb",env.commandStr),check$1.commandParameter(value.alpha,blendEquations,prop+".alpha",env.commandStr),[blendEquations[value.rgb],blendEquations[value.alpha]]):void check$1.commandRaise("invalid blend.equation",env.commandStr)}),(function(env,scope,value){var BLEND_EQUATIONS=env.constants.blendEquations,RGB=scope.def(),ALPHA=scope.def(),ifte=env.cond("typeof ",value,'==="string"');return check$1.optional((function(){function checkProp(block,name,value){env.assert(block,value+" in "+BLEND_EQUATIONS,"invalid "+name+", must be one of "+Object.keys(blendEquations))}checkProp(ifte.then,prop,value),env.assert(ifte.else,value+"&&typeof "+value+'==="object"',"invalid "+prop),checkProp(ifte.else,prop+".rgb",value+".rgb"),checkProp(ifte.else,prop+".alpha",value+".alpha")})),ifte.then(RGB,"=",ALPHA,"=",BLEND_EQUATIONS,"[",value,"];"),ifte.else(RGB,"=",BLEND_EQUATIONS,"[",value,".rgb];",ALPHA,"=",BLEND_EQUATIONS,"[",value,".alpha];"),scope(ifte),[RGB,ALPHA]}));case S_BLEND_COLOR:return parseParam((function(value){return check$1.command(isArrayLike(value)&&4===value.length,"blend.color must be a 4d array",env.commandStr),loop(4,(function(i){return+value[i]}))}),(function(env,scope,value){return check$1.optional((function(){env.assert(scope,env.shared.isArrayLike+"("+value+")&&"+value+".length===4","blend.color must be a 4d array")})),loop(4,(function(i){return scope.def("+",value,"[",i,"]")}))}));case S_STENCIL_MASK:return parseParam((function(value){return check$1.commandType(value,"number",param,env.commandStr),0|value}),(function(env,scope,value){return check$1.optional((function(){env.assert(scope,"typeof "+value+'==="number"',"invalid stencil.mask")})),scope.def(value,"|0")}));case S_STENCIL_FUNC:return parseParam((function(value){check$1.commandType(value,"object",param,env.commandStr);var cmp=value.cmp||"keep",ref=value.ref||0,mask="mask"in value?value.mask:-1;return check$1.commandParameter(cmp,compareFuncs,prop+".cmp",env.commandStr),check$1.commandType(ref,"number",prop+".ref",env.commandStr),check$1.commandType(mask,"number",prop+".mask",env.commandStr),[compareFuncs[cmp],ref,mask]}),(function(env,scope,value){var COMPARE_FUNCS=env.constants.compareFuncs;return check$1.optional((function(){function assert(){env.assert(scope,Array.prototype.join.call(arguments,""),"invalid stencil.func")}assert(value+"&&typeof ",value,'==="object"'),assert('!("cmp" in ',value,")||(",value,".cmp in ",COMPARE_FUNCS,")")})),[scope.def('"cmp" in ',value,"?",COMPARE_FUNCS,"[",value,".cmp]",":",GL_KEEP),scope.def(value,".ref|0"),scope.def('"mask" in ',value,"?",value,".mask|0:-1")]}));case S_STENCIL_OPFRONT:case S_STENCIL_OPBACK:return parseParam((function(value){check$1.commandType(value,"object",param,env.commandStr);var fail=value.fail||"keep",zfail=value.zfail||"keep",zpass=value.zpass||"keep";return check$1.commandParameter(fail,stencilOps,prop+".fail",env.commandStr),check$1.commandParameter(zfail,stencilOps,prop+".zfail",env.commandStr),check$1.commandParameter(zpass,stencilOps,prop+".zpass",env.commandStr),[prop===S_STENCIL_OPBACK?GL_BACK:GL_FRONT,stencilOps[fail],stencilOps[zfail],stencilOps[zpass]]}),(function(env,scope,value){var STENCIL_OPS=env.constants.stencilOps;function read(name){return check$1.optional((function(){env.assert(scope,'!("'+name+'" in '+value+")||("+value+"."+name+" in "+STENCIL_OPS+")","invalid "+prop+"."+name+", must be one of "+Object.keys(stencilOps))})),scope.def('"',name,'" in ',value,"?",STENCIL_OPS,"[",value,".",name,"]:",GL_KEEP)}return check$1.optional((function(){env.assert(scope,value+"&&typeof "+value+'==="object"',"invalid "+prop)})),[prop===S_STENCIL_OPBACK?GL_BACK:GL_FRONT,read("fail"),read("zfail"),read("zpass")]}));case S_POLYGON_OFFSET_OFFSET:return parseParam((function(value){check$1.commandType(value,"object",param,env.commandStr);var factor=0|value.factor,units=0|value.units;return check$1.commandType(factor,"number",param+".factor",env.commandStr),check$1.commandType(units,"number",param+".units",env.commandStr),[factor,units]}),(function(env,scope,value){return check$1.optional((function(){env.assert(scope,value+"&&typeof "+value+'==="object"',"invalid "+prop)})),[scope.def(value,".factor|0"),scope.def(value,".units|0")]}));case S_CULL_FACE:return parseParam((function(value){var face=0;return"front"===value?face=GL_FRONT:"back"===value&&(face=GL_BACK),check$1.command(!!face,param,env.commandStr),face}),(function(env,scope,value){return check$1.optional((function(){env.assert(scope,value+'==="front"||'+value+'==="back"',"invalid cull.face")})),scope.def(value,'==="front"?',GL_FRONT,":",GL_BACK)}));case S_LINE_WIDTH:return parseParam((function(value){return check$1.command("number"==typeof value&&value>=limits.lineWidthDims[0]&&value<=limits.lineWidthDims[1],"invalid line width, must be a positive number between "+limits.lineWidthDims[0]+" and "+limits.lineWidthDims[1],env.commandStr),value}),(function(env,scope,value){return check$1.optional((function(){env.assert(scope,"typeof "+value+'==="number"&&'+value+">="+limits.lineWidthDims[0]+"&&"+value+"<="+limits.lineWidthDims[1],"invalid line width")})),value}));case S_FRONT_FACE:return parseParam((function(value){return check$1.commandParameter(value,orientationType,param,env.commandStr),orientationType[value]}),(function(env,scope,value){return check$1.optional((function(){env.assert(scope,value+'==="cw"||'+value+'==="ccw"',"invalid frontFace, must be one of cw,ccw")})),scope.def(value+'==="cw"?'+GL_CW+":"+GL_CCW)}));case S_COLOR_MASK:return parseParam((function(value){return check$1.command(isArrayLike(value)&&4===value.length,"color.mask must be length 4 array",env.commandStr),value.map((function(v){return!!v}))}),(function(env,scope,value){return check$1.optional((function(){env.assert(scope,env.shared.isArrayLike+"("+value+")&&"+value+".length===4","invalid color.mask")})),loop(4,(function(i){return"!!"+value+"["+i+"]"}))}));case S_SAMPLE_COVERAGE:return parseParam((function(value){check$1.command("object"==typeof value&&value,param,env.commandStr);var sampleValue="value"in value?value.value:1,sampleInvert=!!value.invert;return check$1.command("number"==typeof sampleValue&&sampleValue>=0&&sampleValue<=1,"sample.coverage.value must be a number between 0 and 1",env.commandStr),[sampleValue,sampleInvert]}),(function(env,scope,value){return check$1.optional((function(){env.assert(scope,value+"&&typeof "+value+'==="object"',"invalid sample.coverage")})),[scope.def('"value" in ',value,"?+",value,".value:1"),scope.def("!!",value,".invert")]}))}})),STATE}(options,env),shader=function(options,env,attribLocations){var staticOptions=options.static,dynamicOptions=options.dynamic;function parseShader(name){if(name in staticOptions){var id=stringStore.id(staticOptions[name]);check$1.optional((function(){shaderState.shader(shaderType[name],id,check$1.guessCommand())}));var result=createStaticDecl((function(){return id}));return result.id=id,result}if(name in dynamicOptions){var dyn=dynamicOptions[name];return createDynamicDecl(dyn,(function(env,scope){var str=env.invoke(scope,dyn),id=scope.def(env.shared.strings,".id(",str,")");return check$1.optional((function(){scope(env.shared.shader,".shader(",shaderType[name],",",id,",",env.command,");")})),id}))}return null}var progVar,frag=parseShader(S_FRAG),vert=parseShader(S_VERT),program=null;return isStatic(frag)&&isStatic(vert)?(program=shaderState.program(vert.id,frag.id,null,attribLocations),progVar=createStaticDecl((function(env,scope){return env.link(program)}))):progVar=new Declaration(frag&&frag.thisDep||vert&&vert.thisDep,frag&&frag.contextDep||vert&&vert.contextDep,frag&&frag.propDep||vert&&vert.propDep,(function(env,scope){var fragId,SHADER_STATE=env.shared.shader;fragId=frag?frag.append(env,scope):scope.def(SHADER_STATE,".",S_FRAG);var progDef=SHADER_STATE+".program("+(vert?vert.append(env,scope):scope.def(SHADER_STATE,".",S_VERT))+","+fragId;return check$1.optional((function(){progDef+=","+env.command})),scope.def(progDef+")")})),{frag:frag,vert:vert,progVar:progVar,program:program}}(options,0,attribLocations);function copyBox(name){var defn=viewportAndScissor[name];defn&&(state[name]=defn)}copyBox(S_VIEWPORT),copyBox(propName(S_SCISSOR_BOX));var dirty=Object.keys(state).length>0,result={framebuffer:framebuffer,draw:draw,shader:shader,state:state,dirty:dirty,scopeVAO:null,drawVAO:null,useVAO:!1,attributes:{}};if(result.profile=function(options){var profileEnable,staticOptions=options.static,dynamicOptions=options.dynamic;if(S_PROFILE in staticOptions){var value=!!staticOptions[S_PROFILE];(profileEnable=createStaticDecl((function(env,scope){return value}))).enable=value}else if(S_PROFILE in dynamicOptions){var dyn=dynamicOptions[S_PROFILE];profileEnable=createDynamicDecl(dyn,(function(env,scope){return env.invoke(scope,dyn)}))}return profileEnable}(options),result.uniforms=function(uniforms,env){var staticUniforms=uniforms.static,dynamicUniforms=uniforms.dynamic,UNIFORMS={};return Object.keys(staticUniforms).forEach((function(name){var result,value=staticUniforms[name];if("number"==typeof value||"boolean"==typeof value)result=createStaticDecl((function(){return value}));else if("function"==typeof value){var reglType=value._reglType;"texture2d"===reglType||"textureCube"===reglType?result=createStaticDecl((function(env){return env.link(value)})):"framebuffer"===reglType||"framebufferCube"===reglType?(check$1.command(value.color.length>0,'missing color attachment for framebuffer sent to uniform "'+name+'"',env.commandStr),result=createStaticDecl((function(env){return env.link(value.color[0])}))):check$1.commandRaise('invalid data for uniform "'+name+'"',env.commandStr)}else isArrayLike(value)?result=createStaticDecl((function(env){return env.global.def("[",loop(value.length,(function(i){return check$1.command("number"==typeof value[i]||"boolean"==typeof value[i],"invalid uniform "+name,env.commandStr),value[i]})),"]")})):check$1.commandRaise('invalid or missing data for uniform "'+name+'"',env.commandStr);result.value=value,UNIFORMS[name]=result})),Object.keys(dynamicUniforms).forEach((function(key){var dyn=dynamicUniforms[key];UNIFORMS[key]=createDynamicDecl(dyn,(function(env,scope){return env.invoke(scope,dyn)}))})),UNIFORMS}(uniforms,env),result.drawVAO=result.scopeVAO=draw.vao,!result.drawVAO&&shader.program&&!attribLocations&&extensions.angle_instanced_arrays&&draw.static.elements){var useVAO=!0,staticBindings=shader.program.attributes.map((function(attr){var binding=attributes.static[attr];return useVAO=useVAO&&!!binding,binding}));if(useVAO&&staticBindings.length>0){var vao=attributeState.getVAO(attributeState.createVAO({attributes:staticBindings,elements:draw.static.elements}));result.drawVAO=new Declaration(null,null,null,(function(env,scope){return env.link(vao)})),result.useVAO=!0}}return attribLocations?result.useVAO=!0:result.attributes=function(attributes,env){var staticAttributes=attributes.static,dynamicAttributes=attributes.dynamic,attributeDefs={};return Object.keys(staticAttributes).forEach((function(attribute){var value=staticAttributes[attribute],id=stringStore.id(attribute),record=new AttributeRecord;if(isBufferArgs(value))record.state=ATTRIB_STATE_POINTER,record.buffer=bufferState.getBuffer(bufferState.create(value,GL_ARRAY_BUFFER$2,!1,!0)),record.type=0;else{var buffer=bufferState.getBuffer(value);if(buffer)record.state=ATTRIB_STATE_POINTER,record.buffer=buffer,record.type=0;else if(check$1.command("object"==typeof value&&value,"invalid data for attribute "+attribute,env.commandStr),"constant"in value){var constant=value.constant;record.buffer="null",record.state=ATTRIB_STATE_CONSTANT,"number"==typeof constant?record.x=constant:(check$1.command(isArrayLike(constant)&&constant.length>0&&constant.length<=4,"invalid constant for attribute "+attribute,env.commandStr),CUTE_COMPONENTS.forEach((function(c,i){i<constant.length&&(record[c]=constant[i])})))}else{buffer=isBufferArgs(value.buffer)?bufferState.getBuffer(bufferState.create(value.buffer,GL_ARRAY_BUFFER$2,!1,!0)):bufferState.getBuffer(value.buffer),check$1.command(!!buffer,'missing buffer for attribute "'+attribute+'"',env.commandStr);var offset=0|value.offset;check$1.command(offset>=0,'invalid offset for attribute "'+attribute+'"',env.commandStr);var stride=0|value.stride;check$1.command(stride>=0&&stride<256,'invalid stride for attribute "'+attribute+'", must be integer betweeen [0, 255]',env.commandStr);var size=0|value.size;check$1.command(!("size"in value)||size>0&&size<=4,'invalid size for attribute "'+attribute+'", must be 1,2,3,4',env.commandStr);var normalized=!!value.normalized,type=0;"type"in value&&(check$1.commandParameter(value.type,glTypes,"invalid type for attribute "+attribute,env.commandStr),type=glTypes[value.type]);var divisor=0|value.divisor;check$1.optional((function(){"divisor"in value&&(check$1.command(0===divisor||extInstancing,'cannot specify divisor for attribute "'+attribute+'", instancing not supported',env.commandStr),check$1.command(divisor>=0,'invalid divisor for attribute "'+attribute+'"',env.commandStr));var command=env.commandStr,VALID_KEYS=["buffer","offset","divisor","normalized","type","size","stride"];Object.keys(value).forEach((function(prop){check$1.command(VALID_KEYS.indexOf(prop)>=0,'unknown parameter "'+prop+'" for attribute pointer "'+attribute+'" (valid parameters are '+VALID_KEYS+")",command)}))})),record.buffer=buffer,record.state=ATTRIB_STATE_POINTER,record.size=size,record.normalized=normalized,record.type=type||buffer.dtype,record.offset=offset,record.stride=stride,record.divisor=divisor}}attributeDefs[attribute]=createStaticDecl((function(env,scope){var cache=env.attribCache;if(id in cache)return cache[id];var result={isStream:!1};return Object.keys(record).forEach((function(key){result[key]=record[key]})),record.buffer&&(result.buffer=env.link(record.buffer),result.type=result.type||result.buffer+".dtype"),cache[id]=result,result}))})),Object.keys(dynamicAttributes).forEach((function(attribute){var dyn=dynamicAttributes[attribute];attributeDefs[attribute]=createDynamicDecl(dyn,(function(env,block){var VALUE=env.invoke(block,dyn),shared=env.shared,constants=env.constants,IS_BUFFER_ARGS=shared.isBufferArgs,BUFFER_STATE=shared.buffer;check$1.optional((function(){env.assert(block,VALUE+"&&(typeof "+VALUE+'==="object"||typeof '+VALUE+'==="function")&&('+IS_BUFFER_ARGS+"("+VALUE+")||"+BUFFER_STATE+".getBuffer("+VALUE+")||"+BUFFER_STATE+".getBuffer("+VALUE+".buffer)||"+IS_BUFFER_ARGS+"("+VALUE+'.buffer)||("constant" in '+VALUE+"&&(typeof "+VALUE+'.constant==="number"||'+shared.isArrayLike+"("+VALUE+".constant))))",'invalid dynamic attribute "'+attribute+'"')}));var result={isStream:block.def(!1)},defaultRecord=new AttributeRecord;defaultRecord.state=ATTRIB_STATE_POINTER,Object.keys(defaultRecord).forEach((function(key){result[key]=block.def(""+defaultRecord[key])}));var BUFFER=result.buffer,TYPE=result.type;function emitReadRecord(name){block(result[name],"=",VALUE,".",name,"|0;")}return block("if(",IS_BUFFER_ARGS,"(",VALUE,")){",result.isStream,"=true;",BUFFER,"=",BUFFER_STATE,".createStream(",GL_ARRAY_BUFFER$2,",",VALUE,");",TYPE,"=",BUFFER,".dtype;","}else{",BUFFER,"=",BUFFER_STATE,".getBuffer(",VALUE,");","if(",BUFFER,"){",TYPE,"=",BUFFER,".dtype;",'}else if("constant" in ',VALUE,"){",result.state,"=",ATTRIB_STATE_CONSTANT,";","if(typeof "+VALUE+'.constant === "number"){',result[CUTE_COMPONENTS[0]],"=",VALUE,".constant;",CUTE_COMPONENTS.slice(1).map((function(n){return result[n]})).join("="),"=0;","}else{",CUTE_COMPONENTS.map((function(name,i){return result[name]+"="+VALUE+".constant.length>"+i+"?"+VALUE+".constant["+i+"]:0;"})).join(""),"}}else{","if(",IS_BUFFER_ARGS,"(",VALUE,".buffer)){",BUFFER,"=",BUFFER_STATE,".createStream(",GL_ARRAY_BUFFER$2,",",VALUE,".buffer);","}else{",BUFFER,"=",BUFFER_STATE,".getBuffer(",VALUE,".buffer);","}",TYPE,'="type" in ',VALUE,"?",constants.glTypes,"[",VALUE,".type]:",BUFFER,".dtype;",result.normalized,"=!!",VALUE,".normalized;"),emitReadRecord("size"),emitReadRecord("offset"),emitReadRecord("stride"),emitReadRecord("divisor"),block("}}"),block.exit("if(",result.isStream,"){",BUFFER_STATE,".destroyStream(",BUFFER,");","}"),result}))})),attributeDefs}(attributes,env),result.context=function(context){var staticContext=context.static,dynamicContext=context.dynamic,result={};return Object.keys(staticContext).forEach((function(name){var value=staticContext[name];result[name]=createStaticDecl((function(env,scope){return"number"==typeof value||"boolean"==typeof value?""+value:env.link(value)}))})),Object.keys(dynamicContext).forEach((function(name){var dyn=dynamicContext[name];result[name]=createDynamicDecl(dyn,(function(env,scope){return env.invoke(scope,dyn)}))})),result}(context),result}function emitContext(env,scope,context){var CONTEXT=env.shared.context,contextEnter=env.scope();Object.keys(context).forEach((function(name){scope.save(CONTEXT,"."+name);var value=context[name].append(env,scope);Array.isArray(value)?contextEnter(CONTEXT,".",name,"=[",value.join(),"];"):contextEnter(CONTEXT,".",name,"=",value,";")})),scope(contextEnter)}function emitPollFramebuffer(env,scope,framebuffer,skipCheck){var EXT_DRAW_BUFFERS,shared=env.shared,GL=shared.gl,FRAMEBUFFER_STATE=shared.framebuffer;extDrawBuffers&&(EXT_DRAW_BUFFERS=scope.def(shared.extensions,".webgl_draw_buffers"));var NEXT,constants=env.constants,DRAW_BUFFERS=constants.drawBuffer,BACK_BUFFER=constants.backBuffer;NEXT=framebuffer?framebuffer.append(env,scope):scope.def(FRAMEBUFFER_STATE,".next"),skipCheck||scope("if(",NEXT,"!==",FRAMEBUFFER_STATE,".cur){"),scope("if(",NEXT,"){",GL,".bindFramebuffer(",GL_FRAMEBUFFER$2,",",NEXT,".framebuffer);"),extDrawBuffers&&scope(EXT_DRAW_BUFFERS,".drawBuffersWEBGL(",DRAW_BUFFERS,"[",NEXT,".colorAttachments.length]);"),scope("}else{",GL,".bindFramebuffer(",GL_FRAMEBUFFER$2,",null);"),extDrawBuffers&&scope(EXT_DRAW_BUFFERS,".drawBuffersWEBGL(",BACK_BUFFER,");"),scope("}",FRAMEBUFFER_STATE,".cur=",NEXT,";"),skipCheck||scope("}")}function emitPollState(env,scope,args){var shared=env.shared,GL=shared.gl,CURRENT_VARS=env.current,NEXT_VARS=env.next,CURRENT_STATE=shared.current,NEXT_STATE=shared.next,block=env.cond(CURRENT_STATE,".dirty");GL_STATE_NAMES.forEach((function(prop){var NEXT,CURRENT,param=propName(prop);if(!(param in args.state))if(param in NEXT_VARS){NEXT=NEXT_VARS[param],CURRENT=CURRENT_VARS[param];var parts=loop(currentState[param].length,(function(i){return block.def(NEXT,"[",i,"]")}));block(env.cond(parts.map((function(p,i){return p+"!=="+CURRENT+"["+i+"]"})).join("||")).then(GL,".",GL_VARIABLES[param],"(",parts,");",parts.map((function(p,i){return CURRENT+"["+i+"]="+p})).join(";"),";"))}else{NEXT=block.def(NEXT_STATE,".",param);var ifte=env.cond(NEXT,"!==",CURRENT_STATE,".",param);block(ifte),param in GL_FLAGS?ifte(env.cond(NEXT).then(GL,".enable(",GL_FLAGS[param],");").else(GL,".disable(",GL_FLAGS[param],");"),CURRENT_STATE,".",param,"=",NEXT,";"):ifte(GL,".",GL_VARIABLES[param],"(",NEXT,");",CURRENT_STATE,".",param,"=",NEXT,";")}})),0===Object.keys(args.state).length&&block(CURRENT_STATE,".dirty=false;"),scope(block)}function emitSetOptions(env,scope,options,filter){var shared=env.shared,CURRENT_VARS=env.current,CURRENT_STATE=shared.current,GL=shared.gl;sortState(Object.keys(options)).forEach((function(param){var defn=options[param];if(!filter||filter(defn)){var variable=defn.append(env,scope);if(GL_FLAGS[param]){var flag=GL_FLAGS[param];isStatic(defn)?scope(GL,variable?".enable(":".disable(",flag,");"):scope(env.cond(variable).then(GL,".enable(",flag,");").else(GL,".disable(",flag,");")),scope(CURRENT_STATE,".",param,"=",variable,";")}else if(isArrayLike(variable)){var CURRENT=CURRENT_VARS[param];scope(GL,".",GL_VARIABLES[param],"(",variable,");",variable.map((function(v,i){return CURRENT+"["+i+"]="+v})).join(";"),";")}else scope(GL,".",GL_VARIABLES[param],"(",variable,");",CURRENT_STATE,".",param,"=",variable,";")}}))}function injectExtensions(env,scope){extInstancing&&(env.instancing=scope.def(env.shared.extensions,".angle_instanced_arrays"))}function emitProfile(env,scope,args,useScope,incrementCounter){var CPU_START,QUERY_COUNTER,USE_PROFILE,shared=env.shared,STATS=env.stats,CURRENT_STATE=shared.current,TIMER=shared.timer,profileArg=args.profile;function perfCounter(){return"undefined"==typeof performance?"Date.now()":"performance.now()"}function emitProfileStart(block){block(CPU_START=scope.def(),"=",perfCounter(),";"),"string"==typeof incrementCounter?block(STATS,".count+=",incrementCounter,";"):block(STATS,".count++;"),timer&&(useScope?block(QUERY_COUNTER=scope.def(),"=",TIMER,".getNumPendingQueries();"):block(TIMER,".beginQuery(",STATS,");"))}function emitProfileEnd(block){block(STATS,".cpuTime+=",perfCounter(),"-",CPU_START,";"),timer&&(useScope?block(TIMER,".pushScopeStats(",QUERY_COUNTER,",",TIMER,".getNumPendingQueries(),",STATS,");"):block(TIMER,".endQuery();"))}function scopeProfile(value){var prev=scope.def(CURRENT_STATE,".profile");scope(CURRENT_STATE,".profile=",value,";"),scope.exit(CURRENT_STATE,".profile=",prev,";")}if(profileArg){if(isStatic(profileArg))return void(profileArg.enable?(emitProfileStart(scope),emitProfileEnd(scope.exit),scopeProfile("true")):scopeProfile("false"));scopeProfile(USE_PROFILE=profileArg.append(env,scope))}else USE_PROFILE=scope.def(CURRENT_STATE,".profile");var start=env.block();emitProfileStart(start),scope("if(",USE_PROFILE,"){",start,"}");var end=env.block();emitProfileEnd(end),scope.exit("if(",USE_PROFILE,"){",end,"}")}function emitAttributes(env,scope,args,attributes,filter){var shared=env.shared;attributes.forEach((function(attribute){var record,name=attribute.name,arg=args.attributes[name];if(arg){if(!filter(arg))return;record=arg.append(env,scope)}else{if(!filter(SCOPE_DECL))return;var scopeAttrib=env.scopeAttrib(name);check$1.optional((function(){env.assert(scope,scopeAttrib+".state","missing attribute "+name)})),record={},Object.keys(new AttributeRecord).forEach((function(key){record[key]=scope.def(scopeAttrib,".",key)}))}!function(ATTRIBUTE,size,record){var GL=shared.gl,LOCATION=scope.def(ATTRIBUTE,".location"),BINDING=scope.def(shared.attributes,"[",LOCATION,"]"),STATE=record.state,BUFFER=record.buffer,CONST_COMPONENTS=[record.x,record.y,record.z,record.w],COMMON_KEYS=["buffer","normalized","offset","stride"];function emitBuffer(){scope("if(!",BINDING,".buffer){",GL,".enableVertexAttribArray(",LOCATION,");}");var SIZE,TYPE=record.type;if(SIZE=record.size?scope.def(record.size,"||",size):size,scope("if(",BINDING,".type!==",TYPE,"||",BINDING,".size!==",SIZE,"||",COMMON_KEYS.map((function(key){return BINDING+"."+key+"!=="+record[key]})).join("||"),"){",GL,".bindBuffer(",GL_ARRAY_BUFFER$2,",",BUFFER,".buffer);",GL,".vertexAttribPointer(",[LOCATION,SIZE,TYPE,record.normalized,record.stride,record.offset],");",BINDING,".type=",TYPE,";",BINDING,".size=",SIZE,";",COMMON_KEYS.map((function(key){return BINDING+"."+key+"="+record[key]+";"})).join(""),"}"),extInstancing){var DIVISOR=record.divisor;scope("if(",BINDING,".divisor!==",DIVISOR,"){",env.instancing,".vertexAttribDivisorANGLE(",[LOCATION,DIVISOR],");",BINDING,".divisor=",DIVISOR,";}")}}function emitConstant(){scope("if(",BINDING,".buffer){",GL,".disableVertexAttribArray(",LOCATION,");",BINDING,".buffer=null;","}if(",CUTE_COMPONENTS.map((function(c,i){return BINDING+"."+c+"!=="+CONST_COMPONENTS[i]})).join("||"),"){",GL,".vertexAttrib4f(",LOCATION,",",CONST_COMPONENTS,");",CUTE_COMPONENTS.map((function(c,i){return BINDING+"."+c+"="+CONST_COMPONENTS[i]+";"})).join(""),"}")}STATE===ATTRIB_STATE_POINTER?emitBuffer():STATE===ATTRIB_STATE_CONSTANT?emitConstant():(scope("if(",STATE,"===",ATTRIB_STATE_POINTER,"){"),emitBuffer(),scope("}else{"),emitConstant(),scope("}"))}(env.link(attribute),function(x){switch(x){case GL_FLOAT_VEC2:case GL_INT_VEC2:case GL_BOOL_VEC2:return 2;case GL_FLOAT_VEC3:case GL_INT_VEC3:case GL_BOOL_VEC3:return 3;case GL_FLOAT_VEC4:case GL_INT_VEC4:case GL_BOOL_VEC4:return 4;default:return 1}}(attribute.info.type),record)}))}function emitUniforms(env,scope,args,uniforms,filter,isBatchInnerLoop){for(var infix,shared=env.shared,GL=shared.gl,definedArrUniforms={},i=0;i<uniforms.length;++i){var uniform=uniforms[i],name=uniform.name,type=uniform.info.type,size=uniform.info.size,arg=args.uniforms[name];if(size>1){if(!arg)continue;var arrUniformName=name.replace("[0]","");if(definedArrUniforms[arrUniformName])continue;definedArrUniforms[arrUniformName]=1}var VALUE,LOCATION=env.link(uniform)+".location";if(arg){if(!filter(arg))continue;if(isStatic(arg)){var value=arg.value;if(check$1.command(null!=value,'missing uniform "'+name+'"',env.commandStr),type===GL_SAMPLER_2D||type===GL_SAMPLER_CUBE){check$1.command("function"==typeof value&&(type===GL_SAMPLER_2D&&("texture2d"===value._reglType||"framebuffer"===value._reglType)||type===GL_SAMPLER_CUBE&&("textureCube"===value._reglType||"framebufferCube"===value._reglType)),"invalid texture for uniform "+name,env.commandStr);var TEX_VALUE=env.link(value._texture||value.color[0]._texture);scope(GL,".uniform1i(",LOCATION,",",TEX_VALUE+".bind());"),scope.exit(TEX_VALUE,".unbind();")}else if(type===GL_FLOAT_MAT2||type===GL_FLOAT_MAT3||type===GL_FLOAT_MAT4){check$1.optional((function(){check$1.command(isArrayLike(value),"invalid matrix for uniform "+name,env.commandStr),check$1.command(type===GL_FLOAT_MAT2&&4===value.length||type===GL_FLOAT_MAT3&&9===value.length||type===GL_FLOAT_MAT4&&16===value.length,"invalid length for matrix uniform "+name,env.commandStr)}));var MAT_VALUE=env.global.def("new Float32Array(["+Array.prototype.slice.call(value)+"])"),dim=2;type===GL_FLOAT_MAT3?dim=3:type===GL_FLOAT_MAT4&&(dim=4),scope(GL,".uniformMatrix",dim,"fv(",LOCATION,",false,",MAT_VALUE,");")}else{switch(type){case GL_FLOAT$8:1===size?check$1.commandType(value,"number","uniform "+name,env.commandStr):check$1.command(isArrayLike(value)&&value.length===size,"uniform "+name,env.commandStr),infix="1f";break;case GL_FLOAT_VEC2:check$1.command(isArrayLike(value)&&value.length&&value.length%2==0&&value.length<=2*size,"uniform "+name,env.commandStr),infix="2f";break;case GL_FLOAT_VEC3:check$1.command(isArrayLike(value)&&value.length&&value.length%3==0&&value.length<=3*size,"uniform "+name,env.commandStr),infix="3f";break;case GL_FLOAT_VEC4:check$1.command(isArrayLike(value)&&value.length&&value.length%4==0&&value.length<=4*size,"uniform "+name,env.commandStr),infix="4f";break;case GL_BOOL:1===size?check$1.commandType(value,"boolean","uniform "+name,env.commandStr):check$1.command(isArrayLike(value)&&value.length===size,"uniform "+name,env.commandStr),infix="1i";break;case GL_INT$3:1===size?check$1.commandType(value,"number","uniform "+name,env.commandStr):check$1.command(isArrayLike(value)&&value.length===size,"uniform "+name,env.commandStr),infix="1i";break;case GL_BOOL_VEC2:case GL_INT_VEC2:check$1.command(isArrayLike(value)&&value.length&&value.length%2==0&&value.length<=2*size,"uniform "+name,env.commandStr),infix="2i";break;case GL_BOOL_VEC3:case GL_INT_VEC3:check$1.command(isArrayLike(value)&&value.length&&value.length%3==0&&value.length<=3*size,"uniform "+name,env.commandStr),infix="3i";break;case GL_BOOL_VEC4:case GL_INT_VEC4:check$1.command(isArrayLike(value)&&value.length&&value.length%4==0&&value.length<=4*size,"uniform "+name,env.commandStr),infix="4i"}size>1?(infix+="v",value=env.global.def("["+Array.prototype.slice.call(value)+"]")):value=isArrayLike(value)?Array.prototype.slice.call(value):value,scope(GL,".uniform",infix,"(",LOCATION,",",value,");")}continue}VALUE=arg.append(env,scope)}else{if(!filter(SCOPE_DECL))continue;VALUE=scope.def(shared.uniforms,"[",stringStore.id(name),"]")}type===GL_SAMPLER_2D?(check$1(!Array.isArray(VALUE),"must specify a scalar prop for textures"),scope("if(",VALUE,"&&",VALUE,'._reglType==="framebuffer"){',VALUE,"=",VALUE,".color[0];","}")):type===GL_SAMPLER_CUBE&&(check$1(!Array.isArray(VALUE),"must specify a scalar prop for cube maps"),scope("if(",VALUE,"&&",VALUE,'._reglType==="framebufferCube"){',VALUE,"=",VALUE,".color[0];","}")),check$1.optional((function(){function emitCheck(pred,message){env.assert(scope,pred,'bad data or missing for uniform "'+name+'".  '+message)}function checkType(type,size){1===size&&check$1(!Array.isArray(VALUE),"must not specify an array type for uniform"),emitCheck("Array.isArray("+VALUE+") && typeof "+VALUE+'[0]===" '+type+'" || typeof '+VALUE+'==="'+type+'"',"invalid type, expected "+type)}function checkVector(n,type,size){Array.isArray(VALUE)?check$1(VALUE.length&&VALUE.length%n==0&&VALUE.length<=n*size,"must have length of "+(1===size?"":"n * ")+n):emitCheck(shared.isArrayLike+"("+VALUE+")&&"+VALUE+".length && "+VALUE+".length % "+n+" === 0 && "+VALUE+".length<="+n*size,"invalid vector, should have length of "+(1===size?"":"n * ")+n,env.commandStr)}function checkTexture(target){check$1(!Array.isArray(VALUE),"must not specify a value type"),emitCheck("typeof "+VALUE+'==="function"&&'+VALUE+'._reglType==="texture'+(target===GL_TEXTURE_2D$3?"2d":"Cube")+'"',"invalid texture type",env.commandStr)}switch(type){case GL_INT$3:checkType("number",size);break;case GL_INT_VEC2:checkVector(2,0,size);break;case GL_INT_VEC3:checkVector(3,0,size);break;case GL_INT_VEC4:checkVector(4,0,size);break;case GL_FLOAT$8:checkType("number",size);break;case GL_FLOAT_VEC2:checkVector(2,0,size);break;case GL_FLOAT_VEC3:checkVector(3,0,size);break;case GL_FLOAT_VEC4:checkVector(4,0,size);break;case GL_BOOL:checkType("boolean",size);break;case GL_BOOL_VEC2:checkVector(2,0,size);break;case GL_BOOL_VEC3:checkVector(3,0,size);break;case GL_BOOL_VEC4:case GL_FLOAT_MAT2:checkVector(4,0,size);break;case GL_FLOAT_MAT3:checkVector(9,0,size);break;case GL_FLOAT_MAT4:checkVector(16,0,size);break;case GL_SAMPLER_2D:checkTexture(GL_TEXTURE_2D$3);break;case GL_SAMPLER_CUBE:checkTexture(GL_TEXTURE_CUBE_MAP$2)}}));var unroll=1;switch(type){case GL_SAMPLER_2D:case GL_SAMPLER_CUBE:var TEX=scope.def(VALUE,"._texture");scope(GL,".uniform1i(",LOCATION,",",TEX,".bind());"),scope.exit(TEX,".unbind();");continue;case GL_INT$3:case GL_BOOL:infix="1i";break;case GL_INT_VEC2:case GL_BOOL_VEC2:infix="2i",unroll=2;break;case GL_INT_VEC3:case GL_BOOL_VEC3:infix="3i",unroll=3;break;case GL_INT_VEC4:case GL_BOOL_VEC4:infix="4i",unroll=4;break;case GL_FLOAT$8:infix="1f";break;case GL_FLOAT_VEC2:infix="2f",unroll=2;break;case GL_FLOAT_VEC3:infix="3f",unroll=3;break;case GL_FLOAT_VEC4:infix="4f",unroll=4;break;case GL_FLOAT_MAT2:infix="Matrix2fv";break;case GL_FLOAT_MAT3:infix="Matrix3fv";break;case GL_FLOAT_MAT4:infix="Matrix4fv"}if(-1===infix.indexOf("Matrix")&&size>1&&(infix+="v",unroll=1),"M"===infix.charAt(0)){scope(GL,".uniform",infix,"(",LOCATION,",");var matSize=Math.pow(type-GL_FLOAT_MAT2+2,2),STORAGE=env.global.def("new Float32Array(",matSize,")");Array.isArray(VALUE)?scope("false,(",loop(matSize,(function(i){return STORAGE+"["+i+"]="+VALUE[i]})),",",STORAGE,")"):scope("false,(Array.isArray(",VALUE,")||",VALUE," instanceof Float32Array)?",VALUE,":(",loop(matSize,(function(i){return STORAGE+"["+i+"]="+VALUE+"["+i+"]"})),",",STORAGE,")"),scope(");")}else if(unroll>1){for(var prev=[],cur=[],j=0;j<unroll;++j)Array.isArray(VALUE)?cur.push(VALUE[j]):cur.push(scope.def(VALUE+"["+j+"]")),isBatchInnerLoop&&prev.push(scope.def());isBatchInnerLoop&&scope("if(!",env.batchId,"||",prev.map((function(p,i){return p+"!=="+cur[i]})).join("||"),"){",prev.map((function(p,i){return p+"="+cur[i]+";"})).join("")),scope(GL,".uniform",infix,"(",LOCATION,",",cur.join(","),");"),isBatchInnerLoop&&scope("}")}else{if(check$1(!Array.isArray(VALUE),"uniform value must not be an array"),isBatchInnerLoop){var prevS=scope.def();scope("if(!",env.batchId,"||",prevS,"!==",VALUE,"){",prevS,"=",VALUE,";")}scope(GL,".uniform",infix,"(",LOCATION,",",VALUE,");"),isBatchInnerLoop&&scope("}")}}}function emitDraw(env,outer,inner,args){var shared=env.shared,GL=shared.gl,DRAW_STATE=shared.draw,drawOptions=args.draw,ELEMENTS=function(){var ELEMENTS,defn=drawOptions.elements,scope=outer;return defn?((defn.contextDep&&args.contextDynamic||defn.propDep)&&(scope=inner),ELEMENTS=defn.append(env,scope),drawOptions.elementsActive&&scope("if("+ELEMENTS+")"+GL+".bindBuffer("+GL_ELEMENT_ARRAY_BUFFER$2+","+ELEMENTS+".buffer.buffer);")):(ELEMENTS=scope.def(),scope(ELEMENTS,"=",DRAW_STATE,".",S_ELEMENTS,";","if(",ELEMENTS,"){",GL,".bindBuffer(",GL_ELEMENT_ARRAY_BUFFER$2,",",ELEMENTS,".buffer.buffer);}","else if(",shared.vao,".currentVAO){",ELEMENTS,"=",env.shared.elements+".getElements("+shared.vao,".currentVAO.elements);",extVertexArrays?"":"if("+ELEMENTS+")"+GL+".bindBuffer("+GL_ELEMENT_ARRAY_BUFFER$2+","+ELEMENTS+".buffer.buffer);","}")),ELEMENTS}();function emitValue(name){var defn=drawOptions[name];return defn?defn.contextDep&&args.contextDynamic||defn.propDep?defn.append(env,inner):defn.append(env,outer):outer.def(DRAW_STATE,".",name)}var INSTANCES,EXT_INSTANCING,PRIMITIVE=emitValue(S_PRIMITIVE),OFFSET=emitValue(S_OFFSET),COUNT=function(){var COUNT,defn=drawOptions.count,scope=outer;return defn?((defn.contextDep&&args.contextDynamic||defn.propDep)&&(scope=inner),COUNT=defn.append(env,scope),check$1.optional((function(){defn.MISSING&&env.assert(outer,"false","missing vertex count"),defn.DYNAMIC&&env.assert(scope,COUNT+">=0","missing vertex count")}))):(COUNT=scope.def(DRAW_STATE,".",S_COUNT),check$1.optional((function(){env.assert(scope,COUNT+">=0","missing vertex count")}))),COUNT}();if("number"==typeof COUNT){if(0===COUNT)return}else inner("if(",COUNT,"){"),inner.exit("}");extInstancing&&(INSTANCES=emitValue(S_INSTANCES),EXT_INSTANCING=env.instancing);var ELEMENT_TYPE=ELEMENTS+".type",elementsStatic=drawOptions.elements&&isStatic(drawOptions.elements)&&!drawOptions.vaoActive;function emitInstancing(){function drawElements(){inner(EXT_INSTANCING,".drawElementsInstancedANGLE(",[PRIMITIVE,COUNT,ELEMENT_TYPE,OFFSET+"<<(("+ELEMENT_TYPE+"-"+GL_UNSIGNED_BYTE$8+")>>1)",INSTANCES],");")}function drawArrays(){inner(EXT_INSTANCING,".drawArraysInstancedANGLE(",[PRIMITIVE,OFFSET,COUNT,INSTANCES],");")}ELEMENTS&&"null"!==ELEMENTS?elementsStatic?drawElements():(inner("if(",ELEMENTS,"){"),drawElements(),inner("}else{"),drawArrays(),inner("}")):drawArrays()}function emitRegular(){function drawElements(){inner(GL+".drawElements("+[PRIMITIVE,COUNT,ELEMENT_TYPE,OFFSET+"<<(("+ELEMENT_TYPE+"-"+GL_UNSIGNED_BYTE$8+")>>1)"]+");")}function drawArrays(){inner(GL+".drawArrays("+[PRIMITIVE,OFFSET,COUNT]+");")}ELEMENTS&&"null"!==ELEMENTS?elementsStatic?drawElements():(inner("if(",ELEMENTS,"){"),drawElements(),inner("}else{"),drawArrays(),inner("}")):drawArrays()}extInstancing&&("number"!=typeof INSTANCES||INSTANCES>=0)?"string"==typeof INSTANCES?(inner("if(",INSTANCES,">0){"),emitInstancing(),inner("}else if(",INSTANCES,"<0){"),emitRegular(),inner("}")):emitInstancing():emitRegular()}function createBody(emitBody,parentEnv,args,program,count){var env=createREGLEnvironment(),scope=env.proc("body",count);return check$1.optional((function(){env.commandStr=parentEnv.commandStr,env.command=env.link(parentEnv.commandStr)})),extInstancing&&(env.instancing=scope.def(env.shared.extensions,".angle_instanced_arrays")),emitBody(env,scope,args,program),env.compile().body}function emitDrawBody(env,draw,args,program){injectExtensions(env,draw),args.useVAO?args.drawVAO?draw(env.shared.vao,".setVAO(",args.drawVAO.append(env,draw),");"):draw(env.shared.vao,".setVAO(",env.shared.vao,".targetVAO);"):(draw(env.shared.vao,".setVAO(null);"),emitAttributes(env,draw,args,program.attributes,(function(){return!0}))),emitUniforms(env,draw,args,program.uniforms,(function(){return!0}),!1),emitDraw(env,draw,draw,args)}function emitBatchDynamicShaderBody(env,scope,args,program){function all(){return!0}env.batchId="a1",injectExtensions(env,scope),emitAttributes(env,scope,args,program.attributes,all),emitUniforms(env,scope,args,program.uniforms,all,!1),emitDraw(env,scope,scope,args)}function emitBatchBody(env,scope,args,program){injectExtensions(env,scope);var contextDynamic=args.contextDep,BATCH_ID=scope.def(),PROPS=scope.def();env.shared.props=PROPS,env.batchId=BATCH_ID;var outer=env.scope(),inner=env.scope();function isInnerDefn(defn){return defn.contextDep&&contextDynamic||defn.propDep}function isOuterDefn(defn){return!isInnerDefn(defn)}if(scope(outer.entry,"for(",BATCH_ID,"=0;",BATCH_ID,"<","a1",";++",BATCH_ID,"){",PROPS,"=","a0","[",BATCH_ID,"];",inner,"}",outer.exit),args.needsContext&&emitContext(env,inner,args.context),args.needsFramebuffer&&emitPollFramebuffer(env,inner,args.framebuffer),emitSetOptions(env,inner,args.state,isInnerDefn),args.profile&&isInnerDefn(args.profile)&&emitProfile(env,inner,args,!1,!0),program)args.useVAO?args.drawVAO?isInnerDefn(args.drawVAO)?inner(env.shared.vao,".setVAO(",args.drawVAO.append(env,inner),");"):outer(env.shared.vao,".setVAO(",args.drawVAO.append(env,outer),");"):outer(env.shared.vao,".setVAO(",env.shared.vao,".targetVAO);"):(outer(env.shared.vao,".setVAO(null);"),emitAttributes(env,outer,args,program.attributes,isOuterDefn),emitAttributes(env,inner,args,program.attributes,isInnerDefn)),emitUniforms(env,outer,args,program.uniforms,isOuterDefn,!1),emitUniforms(env,inner,args,program.uniforms,isInnerDefn,!0),emitDraw(env,outer,inner,args);else{var progCache=env.global.def("{}"),PROGRAM=args.shader.progVar.append(env,inner),PROG_ID=inner.def(PROGRAM,".id"),CACHED_PROC=inner.def(progCache,"[",PROG_ID,"]");inner(env.shared.gl,".useProgram(",PROGRAM,".program);","if(!",CACHED_PROC,"){",CACHED_PROC,"=",progCache,"[",PROG_ID,"]=",env.link((function(program){return createBody(emitBatchDynamicShaderBody,env,args,program,2)})),"(",PROGRAM,");}",CACHED_PROC,".call(this,a0[",BATCH_ID,"],",BATCH_ID,");")}}function splatObject(env,options,name){var object=options.static[name];if(object&&function(object){if("object"==typeof object&&!isArrayLike(object)){for(var props=Object.keys(object),i=0;i<props.length;++i)if(dynamic.isDynamic(object[props[i]]))return!0;return!1}}(object)){var globals=env.global,keys=Object.keys(object),thisDep=!1,contextDep=!1,propDep=!1,objectRef=env.global.def("{}");keys.forEach((function(key){var value=object[key];if(dynamic.isDynamic(value)){"function"==typeof value&&(value=object[key]=dynamic.unbox(value));var deps=createDynamicDecl(value,null);thisDep=thisDep||deps.thisDep,propDep=propDep||deps.propDep,contextDep=contextDep||deps.contextDep}else{switch(globals(objectRef,".",key,"="),typeof value){case"number":globals(value);break;case"string":globals('"',value,'"');break;case"object":Array.isArray(value)&&globals("[",value.join(),"]");break;default:globals(env.link(value))}globals(";")}})),options.dynamic[name]=new dynamic.DynamicVariable(DYN_THUNK,{thisDep:thisDep,contextDep:contextDep,propDep:propDep,ref:objectRef,append:function(env,block){keys.forEach((function(key){var value=object[key];if(dynamic.isDynamic(value)){var ref=env.invoke(block,value);block(objectRef,".",key,"=",ref,";")}}))}}),delete options.static[name]}}return{next:nextState,current:currentState,procs:function(){var env=createREGLEnvironment(),poll=env.proc("poll"),refresh=env.proc("refresh"),common=env.block();poll(common),refresh(common);var INSTANCING,shared=env.shared,GL=shared.gl,NEXT_STATE=shared.next,CURRENT_STATE=shared.current;common(CURRENT_STATE,".dirty=false;"),emitPollFramebuffer(env,poll),emitPollFramebuffer(env,refresh,null,!0),extInstancing&&(INSTANCING=env.link(extInstancing)),extensions.oes_vertex_array_object&&refresh(env.link(extensions.oes_vertex_array_object),".bindVertexArrayOES(null);");for(var i=0;i<limits.maxAttributes;++i){var BINDING=refresh.def(shared.attributes,"[",i,"]"),ifte=env.cond(BINDING,".buffer");ifte.then(GL,".enableVertexAttribArray(",i,");",GL,".bindBuffer(",GL_ARRAY_BUFFER$2,",",BINDING,".buffer.buffer);",GL,".vertexAttribPointer(",i,",",BINDING,".size,",BINDING,".type,",BINDING,".normalized,",BINDING,".stride,",BINDING,".offset);").else(GL,".disableVertexAttribArray(",i,");",GL,".vertexAttrib4f(",i,",",BINDING,".x,",BINDING,".y,",BINDING,".z,",BINDING,".w);",BINDING,".buffer=null;"),refresh(ifte),extInstancing&&refresh(INSTANCING,".vertexAttribDivisorANGLE(",i,",",BINDING,".divisor);")}return refresh(env.shared.vao,".currentVAO=null;",env.shared.vao,".setVAO(",env.shared.vao,".targetVAO);"),Object.keys(GL_FLAGS).forEach((function(flag){var cap=GL_FLAGS[flag],NEXT=common.def(NEXT_STATE,".",flag),block=env.block();block("if(",NEXT,"){",GL,".enable(",cap,")}else{",GL,".disable(",cap,")}",CURRENT_STATE,".",flag,"=",NEXT,";"),refresh(block),poll("if(",NEXT,"!==",CURRENT_STATE,".",flag,"){",block,"}")})),Object.keys(GL_VARIABLES).forEach((function(name){var NEXT,CURRENT,func=GL_VARIABLES[name],init=currentState[name],block=env.block();if(block(GL,".",func,"("),isArrayLike(init)){var n=init.length;NEXT=env.global.def(NEXT_STATE,".",name),CURRENT=env.global.def(CURRENT_STATE,".",name),block(loop(n,(function(i){return NEXT+"["+i+"]"})),");",loop(n,(function(i){return CURRENT+"["+i+"]="+NEXT+"["+i+"];"})).join("")),poll("if(",loop(n,(function(i){return NEXT+"["+i+"]!=="+CURRENT+"["+i+"]"})).join("||"),"){",block,"}")}else NEXT=common.def(NEXT_STATE,".",name),CURRENT=common.def(CURRENT_STATE,".",name),block(NEXT,");",CURRENT_STATE,".",name,"=",NEXT,";"),poll("if(",NEXT,"!==",CURRENT,"){",block,"}");refresh(block)})),env.compile()}(),compile:function(options,attributes,uniforms,context,stats){var env=createREGLEnvironment();env.stats=env.link(stats),Object.keys(attributes.static).forEach((function(key){splatObject(env,attributes,key)})),NESTED_OPTIONS.forEach((function(name){splatObject(env,options,name)}));var args=parseArguments(options,attributes,uniforms,context,env);return function(env,args){var draw=env.proc("draw",1);injectExtensions(env,draw),emitContext(env,draw,args.context),emitPollFramebuffer(env,draw,args.framebuffer),emitPollState(env,draw,args),emitSetOptions(env,draw,args.state),emitProfile(env,draw,args,!1,!0);var program=args.shader.progVar.append(env,draw);if(draw(env.shared.gl,".useProgram(",program,".program);"),args.shader.program)emitDrawBody(env,draw,args,args.shader.program);else{draw(env.shared.vao,".setVAO(null);");var drawCache=env.global.def("{}"),PROG_ID=draw.def(program,".id"),CACHED_PROC=draw.def(drawCache,"[",PROG_ID,"]");draw(env.cond(CACHED_PROC).then(CACHED_PROC,".call(this,a0);").else(CACHED_PROC,"=",drawCache,"[",PROG_ID,"]=",env.link((function(program){return createBody(emitDrawBody,env,args,program,1)})),"(",program,");",CACHED_PROC,".call(this,a0);"))}Object.keys(args.state).length>0&&draw(env.shared.current,".dirty=true;"),env.shared.vao&&draw(env.shared.vao,".setVAO(null);")}(env,args),function(env,args){var scope=env.proc("scope",3);env.batchId="a2";var shared=env.shared,CURRENT_STATE=shared.current;function saveShader(name){var shader=args.shader[name];shader&&scope.set(shared.shader,"."+name,shader.append(env,scope))}emitContext(env,scope,args.context),args.framebuffer&&args.framebuffer.append(env,scope),sortState(Object.keys(args.state)).forEach((function(name){var value=args.state[name].append(env,scope);isArrayLike(value)?value.forEach((function(v,i){scope.set(env.next[name],"["+i+"]",v)})):scope.set(shared.next,"."+name,value)})),emitProfile(env,scope,args,!0,!0),[S_ELEMENTS,S_OFFSET,S_COUNT,S_INSTANCES,S_PRIMITIVE].forEach((function(opt){var variable=args.draw[opt];variable&&scope.set(shared.draw,"."+opt,""+variable.append(env,scope))})),Object.keys(args.uniforms).forEach((function(opt){var value=args.uniforms[opt].append(env,scope);Array.isArray(value)&&(value="["+value.join()+"]"),scope.set(shared.uniforms,"["+stringStore.id(opt)+"]",value)})),Object.keys(args.attributes).forEach((function(name){var record=args.attributes[name].append(env,scope),scopeAttrib=env.scopeAttrib(name);Object.keys(new AttributeRecord).forEach((function(prop){scope.set(scopeAttrib,"."+prop,record[prop])}))})),args.scopeVAO&&scope.set(shared.vao,".targetVAO",args.scopeVAO.append(env,scope)),saveShader(S_VERT),saveShader(S_FRAG),Object.keys(args.state).length>0&&(scope(CURRENT_STATE,".dirty=true;"),scope.exit(CURRENT_STATE,".dirty=true;")),scope("a1(",env.shared.context,",a0,",env.batchId,");")}(env,args),function(env,args){var batch=env.proc("batch",2);env.batchId="0",injectExtensions(env,batch);var contextDynamic=!1,needsContext=!0;Object.keys(args.context).forEach((function(name){contextDynamic=contextDynamic||args.context[name].propDep})),contextDynamic||(emitContext(env,batch,args.context),needsContext=!1);var framebuffer=args.framebuffer,needsFramebuffer=!1;function isInnerDefn(defn){return defn.contextDep&&contextDynamic||defn.propDep}framebuffer?(framebuffer.propDep?contextDynamic=needsFramebuffer=!0:framebuffer.contextDep&&contextDynamic&&(needsFramebuffer=!0),needsFramebuffer||emitPollFramebuffer(env,batch,framebuffer)):emitPollFramebuffer(env,batch,null),args.state.viewport&&args.state.viewport.propDep&&(contextDynamic=!0),emitPollState(env,batch,args),emitSetOptions(env,batch,args.state,(function(defn){return!isInnerDefn(defn)})),args.profile&&isInnerDefn(args.profile)||emitProfile(env,batch,args,!1,"a1"),args.contextDep=contextDynamic,args.needsContext=needsContext,args.needsFramebuffer=needsFramebuffer;var progDefn=args.shader.progVar;if(progDefn.contextDep&&contextDynamic||progDefn.propDep)emitBatchBody(env,batch,args,null);else{var PROGRAM=progDefn.append(env,batch);if(batch(env.shared.gl,".useProgram(",PROGRAM,".program);"),args.shader.program)emitBatchBody(env,batch,args,args.shader.program);else{batch(env.shared.vao,".setVAO(null);");var batchCache=env.global.def("{}"),PROG_ID=batch.def(PROGRAM,".id"),CACHED_PROC=batch.def(batchCache,"[",PROG_ID,"]");batch(env.cond(CACHED_PROC).then(CACHED_PROC,".call(this,a0,a1);").else(CACHED_PROC,"=",batchCache,"[",PROG_ID,"]=",env.link((function(program){return createBody(emitBatchBody,env,args,program,2)})),"(",PROGRAM,");",CACHED_PROC,".call(this,a0,a1);"))}}Object.keys(args.state).length>0&&batch(env.shared.current,".dirty=true;"),env.shared.vao&&batch(env.shared.vao,".setVAO(null);")}(env,args),extend(env.compile(),{destroy:function(){args.shader.program.destroy()}})}}}var createTimer=function(gl,extensions){if(!extensions.ext_disjoint_timer_query)return null;var queryPool=[];function freeQuery(query){queryPool.push(query)}var pendingQueries=[];function PendingStats(){this.startQueryIndex=-1,this.endQueryIndex=-1,this.sum=0,this.stats=null}var pendingStatsPool=[];function freePendingStats(pendingStats){pendingStatsPool.push(pendingStats)}var pendingStats=[];function pushScopeStats(start,end,stats){var ps=pendingStatsPool.pop()||new PendingStats;ps.startQueryIndex=start,ps.endQueryIndex=end,ps.sum=0,ps.stats=stats,pendingStats.push(ps)}var timeSum=[],queryPtr=[];return{beginQuery:function(stats){var query=queryPool.pop()||extensions.ext_disjoint_timer_query.createQueryEXT();extensions.ext_disjoint_timer_query.beginQueryEXT(35007,query),pendingQueries.push(query),pushScopeStats(pendingQueries.length-1,pendingQueries.length,stats)},endQuery:function(){extensions.ext_disjoint_timer_query.endQueryEXT(35007)},pushScopeStats:pushScopeStats,update:function(){var ptr,i,n=pendingQueries.length;if(0!==n){queryPtr.length=Math.max(queryPtr.length,n+1),timeSum.length=Math.max(timeSum.length,n+1),timeSum[0]=0,queryPtr[0]=0;var queryTime=0;for(ptr=0,i=0;i<pendingQueries.length;++i){var query=pendingQueries[i];extensions.ext_disjoint_timer_query.getQueryObjectEXT(query,34919)?(queryTime+=extensions.ext_disjoint_timer_query.getQueryObjectEXT(query,34918),freeQuery(query)):pendingQueries[ptr++]=query,timeSum[i+1]=queryTime,queryPtr[i+1]=ptr}for(pendingQueries.length=ptr,ptr=0,i=0;i<pendingStats.length;++i){var stats=pendingStats[i],start=stats.startQueryIndex,end=stats.endQueryIndex;stats.sum+=timeSum[end]-timeSum[start];var startPtr=queryPtr[start],endPtr=queryPtr[end];endPtr===startPtr?(stats.stats.gpuTime+=stats.sum/1e6,freePendingStats(stats)):(stats.startQueryIndex=startPtr,stats.endQueryIndex=endPtr,pendingStats[ptr++]=stats)}pendingStats.length=ptr}},getNumPendingQueries:function(){return pendingQueries.length},clear:function(){queryPool.push.apply(queryPool,pendingQueries);for(var i=0;i<queryPool.length;i++)extensions.ext_disjoint_timer_query.deleteQueryEXT(queryPool[i]);pendingQueries.length=0,queryPool.length=0},restore:function(){pendingQueries.length=0,queryPool.length=0}}};function find(haystack,needle){for(var i=0;i<haystack.length;++i)if(haystack[i]===needle)return i;return-1}return function(args){var config=parseArgs(args);if(!config)return null;var gl=config.gl,glAttributes=gl.getContextAttributes(),contextLost=gl.isContextLost(),extensionState=function(gl,config){var extensions={};function tryLoadExtension(name_){check$1.type(name_,"string","extension name must be string");var ext,name=name_.toLowerCase();try{ext=extensions[name]=gl.getExtension(name)}catch(e){}return!!ext}for(var i=0;i<config.extensions.length;++i){var name=config.extensions[i];if(!tryLoadExtension(name))return config.onDestroy(),config.onDone('"'+name+'" extension is not supported by the current WebGL context, try upgrading your system or a different browser'),null}return config.optionalExtensions.forEach(tryLoadExtension),{extensions:extensions,restore:function(){Object.keys(extensions).forEach((function(name){if(extensions[name]&&!tryLoadExtension(name))throw new Error("(regl): error restoring extension "+name)}))}}}(gl,config);if(!extensionState)return null;var stringIds,stringValues,stringStore=(stringIds={"":0},stringValues=[""],{id:function(str){var result=stringIds[str];return result||(result=stringIds[str]=stringValues.length,stringValues.push(str),result)},str:function(id){return stringValues[id]}}),stats$$1={vaoCount:0,bufferCount:0,elementsCount:0,framebufferCount:0,shaderCount:0,textureCount:0,cubeCount:0,renderbufferCount:0,maxTextureUnits:0},extensions=extensionState.extensions,timer=createTimer(0,extensions),START_TIME=clock(),WIDTH=gl.drawingBufferWidth,HEIGHT=gl.drawingBufferHeight,contextState={tick:0,time:0,viewportWidth:WIDTH,viewportHeight:HEIGHT,framebufferWidth:WIDTH,framebufferHeight:HEIGHT,drawingBufferWidth:WIDTH,drawingBufferHeight:HEIGHT,pixelRatio:config.pixelRatio},drawState={elements:null,primitive:4,count:-1,offset:0,instances:-1},limits=function(gl,extensions){var maxAnisotropic=1;extensions.ext_texture_filter_anisotropic&&(maxAnisotropic=gl.getParameter(34047));var maxDrawbuffers=1,maxColorAttachments=1;extensions.webgl_draw_buffers&&(maxDrawbuffers=gl.getParameter(34852),maxColorAttachments=gl.getParameter(36063));var readFloat=!!extensions.oes_texture_float;if(readFloat){var readFloatTexture=gl.createTexture();gl.bindTexture(3553,readFloatTexture),gl.texImage2D(3553,0,6408,1,1,0,6408,5126,null);var fbo=gl.createFramebuffer();if(gl.bindFramebuffer(36160,fbo),gl.framebufferTexture2D(36160,36064,3553,readFloatTexture,0),gl.bindTexture(3553,null),36053!==gl.checkFramebufferStatus(36160))readFloat=!1;else{gl.viewport(0,0,1,1),gl.clearColor(1,0,0,1),gl.clear(16384);var pixels=pool.allocType(5126,4);gl.readPixels(0,0,1,1,6408,5126,pixels),gl.getError()?readFloat=!1:(gl.deleteFramebuffer(fbo),gl.deleteTexture(readFloatTexture),readFloat=1===pixels[0]),pool.freeType(pixels)}}var npotTextureCube=!0;if("undefined"==typeof navigator||!(/MSIE/.test(navigator.userAgent)||/Trident\//.test(navigator.appVersion)||/Edge/.test(navigator.userAgent))){var cubeTexture=gl.createTexture(),data=pool.allocType(5121,36);gl.activeTexture(33984),gl.bindTexture(34067,cubeTexture),gl.texImage2D(34069,0,6408,3,3,0,6408,5121,data),pool.freeType(data),gl.bindTexture(34067,null),gl.deleteTexture(cubeTexture),npotTextureCube=!gl.getError()}return{colorBits:[gl.getParameter(3410),gl.getParameter(3411),gl.getParameter(3412),gl.getParameter(3413)],depthBits:gl.getParameter(3414),stencilBits:gl.getParameter(3415),subpixelBits:gl.getParameter(3408),extensions:Object.keys(extensions).filter((function(ext){return!!extensions[ext]})),maxAnisotropic:maxAnisotropic,maxDrawbuffers:maxDrawbuffers,maxColorAttachments:maxColorAttachments,pointSizeDims:gl.getParameter(33901),lineWidthDims:gl.getParameter(33902),maxViewportDims:gl.getParameter(3386),maxCombinedTextureUnits:gl.getParameter(35661),maxCubeMapSize:gl.getParameter(34076),maxRenderbufferSize:gl.getParameter(34024),maxTextureUnits:gl.getParameter(34930),maxTextureSize:gl.getParameter(3379),maxAttributes:gl.getParameter(34921),maxVertexUniforms:gl.getParameter(36347),maxVertexTextureUnits:gl.getParameter(35660),maxVaryingVectors:gl.getParameter(36348),maxFragmentUniforms:gl.getParameter(36349),glsl:gl.getParameter(35724),renderer:gl.getParameter(7937),vendor:gl.getParameter(7936),version:gl.getParameter(7938),readFloat:readFloat,npotTextureCube:npotTextureCube}}(gl,extensions),bufferState=function(gl,stats,config,destroyBuffer){var bufferCount=0,bufferSet={};function REGLBuffer(type){this.id=bufferCount++,this.buffer=gl.createBuffer(),this.type=type,this.usage=GL_STATIC_DRAW,this.byteLength=0,this.dimension=1,this.dtype=GL_UNSIGNED_BYTE$3,this.persistentData=null,config.profile&&(this.stats={size:0})}REGLBuffer.prototype.bind=function(){gl.bindBuffer(this.type,this.buffer)},REGLBuffer.prototype.destroy=function(){destroy(this)};var streamPool=[];function initBufferFromTypedArray(buffer,data,usage){buffer.byteLength=data.byteLength,gl.bufferData(buffer.type,data,usage)}function initBufferFromData(buffer,data,usage,dtype,dimension,persist){var shape,flatData;if(buffer.usage=usage,Array.isArray(data)){if(buffer.dtype=dtype||GL_FLOAT$3,data.length>0)if(Array.isArray(data[0])){shape=arrayShape(data);for(var dim=1,i=1;i<shape.length;++i)dim*=shape[i];buffer.dimension=dim,initBufferFromTypedArray(buffer,flatData=arrayFlatten(data,shape,buffer.dtype),usage),persist?buffer.persistentData=flatData:pool.freeType(flatData)}else if("number"==typeof data[0]){buffer.dimension=dimension;var typedData=pool.allocType(buffer.dtype,data.length);copyArray(typedData,data),initBufferFromTypedArray(buffer,typedData,usage),persist?buffer.persistentData=typedData:pool.freeType(typedData)}else isTypedArray(data[0])?(buffer.dimension=data[0].length,buffer.dtype=dtype||typedArrayCode(data[0])||GL_FLOAT$3,initBufferFromTypedArray(buffer,flatData=arrayFlatten(data,[data.length,data[0].length],buffer.dtype),usage),persist?buffer.persistentData=flatData:pool.freeType(flatData)):check$1.raise("invalid buffer data")}else if(isTypedArray(data))buffer.dtype=dtype||typedArrayCode(data),buffer.dimension=dimension,initBufferFromTypedArray(buffer,data,usage),persist&&(buffer.persistentData=new Uint8Array(new Uint8Array(data.buffer)));else if(isNDArrayLike(data)){shape=data.shape;var stride=data.stride,offset=data.offset,shapeX=0,shapeY=0,strideX=0,strideY=0;1===shape.length?(shapeX=shape[0],shapeY=1,strideX=stride[0],strideY=0):2===shape.length?(shapeX=shape[0],shapeY=shape[1],strideX=stride[0],strideY=stride[1]):check$1.raise("invalid shape"),buffer.dtype=dtype||typedArrayCode(data.data)||GL_FLOAT$3,buffer.dimension=shapeY;var transposeData=pool.allocType(buffer.dtype,shapeX*shapeY);transpose(transposeData,data.data,shapeX,shapeY,strideX,strideY,offset),initBufferFromTypedArray(buffer,transposeData,usage),persist?buffer.persistentData=transposeData:pool.freeType(transposeData)}else data instanceof ArrayBuffer?(buffer.dtype=GL_UNSIGNED_BYTE$3,buffer.dimension=dimension,initBufferFromTypedArray(buffer,data,usage),persist&&(buffer.persistentData=new Uint8Array(new Uint8Array(data)))):check$1.raise("invalid buffer data")}function destroy(buffer){stats.bufferCount--,destroyBuffer(buffer);var handle=buffer.buffer;check$1(handle,"buffer must not be deleted already"),gl.deleteBuffer(handle),buffer.buffer=null,delete bufferSet[buffer.id]}return config.profile&&(stats.getTotalBufferSize=function(){var total=0;return Object.keys(bufferSet).forEach((function(key){total+=bufferSet[key].stats.size})),total}),{create:function(options,type,deferInit,persistent){stats.bufferCount++;var buffer=new REGLBuffer(type);function reglBuffer(options){var usage=GL_STATIC_DRAW,data=null,byteLength=0,dtype=0,dimension=1;return Array.isArray(options)||isTypedArray(options)||isNDArrayLike(options)||options instanceof ArrayBuffer?data=options:"number"==typeof options?byteLength=0|options:options&&(check$1.type(options,"object","buffer arguments must be an object, a number or an array"),"data"in options&&(check$1(null===data||Array.isArray(data)||isTypedArray(data)||isNDArrayLike(data),"invalid data for buffer"),data=options.data),"usage"in options&&(check$1.parameter(options.usage,usageTypes,"invalid buffer usage"),usage=usageTypes[options.usage]),"type"in options&&(check$1.parameter(options.type,glTypes,"invalid buffer type"),dtype=glTypes[options.type]),"dimension"in options&&(check$1.type(options.dimension,"number","invalid dimension"),dimension=0|options.dimension),"length"in options&&(check$1.nni(byteLength,"buffer length must be a nonnegative integer"),byteLength=0|options.length)),buffer.bind(),data?initBufferFromData(buffer,data,usage,dtype,dimension,persistent):(byteLength&&gl.bufferData(buffer.type,byteLength,usage),buffer.dtype=dtype||GL_UNSIGNED_BYTE$3,buffer.usage=usage,buffer.dimension=dimension,buffer.byteLength=byteLength),config.profile&&(buffer.stats.size=buffer.byteLength*DTYPES_SIZES[buffer.dtype]),reglBuffer}function setSubData(data,offset){check$1(offset+data.byteLength<=buffer.byteLength,"invalid buffer subdata call, buffer is too small.  Can't write data of size "+data.byteLength+" starting from offset "+offset+" to a buffer of size "+buffer.byteLength),gl.bufferSubData(buffer.type,offset,data)}return bufferSet[buffer.id]=buffer,deferInit||reglBuffer(options),reglBuffer._reglType="buffer",reglBuffer._buffer=buffer,reglBuffer.subdata=function(data,offset_){var shape,offset=0|(offset_||0);if(buffer.bind(),isTypedArray(data)||data instanceof ArrayBuffer)setSubData(data,offset);else if(Array.isArray(data)){if(data.length>0)if("number"==typeof data[0]){var converted=pool.allocType(buffer.dtype,data.length);copyArray(converted,data),setSubData(converted,offset),pool.freeType(converted)}else if(Array.isArray(data[0])||isTypedArray(data[0])){shape=arrayShape(data);var flatData=arrayFlatten(data,shape,buffer.dtype);setSubData(flatData,offset),pool.freeType(flatData)}else check$1.raise("invalid buffer data")}else if(isNDArrayLike(data)){shape=data.shape;var stride=data.stride,shapeX=0,shapeY=0,strideX=0,strideY=0;1===shape.length?(shapeX=shape[0],shapeY=1,strideX=stride[0],strideY=0):2===shape.length?(shapeX=shape[0],shapeY=shape[1],strideX=stride[0],strideY=stride[1]):check$1.raise("invalid shape");var dtype=Array.isArray(data.data)?buffer.dtype:typedArrayCode(data.data),transposeData=pool.allocType(dtype,shapeX*shapeY);transpose(transposeData,data.data,shapeX,shapeY,strideX,strideY,data.offset),setSubData(transposeData,offset),pool.freeType(transposeData)}else check$1.raise("invalid data for buffer subdata");return reglBuffer},config.profile&&(reglBuffer.stats=buffer.stats),reglBuffer.destroy=function(){destroy(buffer)},reglBuffer},createStream:function(type,data){var buffer=streamPool.pop();return buffer||(buffer=new REGLBuffer(type)),buffer.bind(),initBufferFromData(buffer,data,GL_STREAM_DRAW,0,1,!1),buffer},destroyStream:function(stream$$1){streamPool.push(stream$$1)},clear:function(){values(bufferSet).forEach(destroy),streamPool.forEach(destroy)},getBuffer:function(wrapper){return wrapper&&wrapper._buffer instanceof REGLBuffer?wrapper._buffer:null},restore:function(){values(bufferSet).forEach((function(buffer){buffer.buffer=gl.createBuffer(),gl.bindBuffer(buffer.type,buffer.buffer),gl.bufferData(buffer.type,buffer.persistentData||buffer.byteLength,buffer.usage)}))},_initBuffer:initBufferFromData}}(gl,stats$$1,config,(function(buffer){return attributeState.destroyBuffer(buffer)})),elementState=function(gl,extensions,bufferState,stats){var elementSet={},elementCount=0,elementTypes={uint8:GL_UNSIGNED_BYTE$4,uint16:GL_UNSIGNED_SHORT$2};function REGLElementBuffer(buffer){this.id=elementCount++,elementSet[this.id]=this,this.buffer=buffer,this.primType=GL_TRIANGLES,this.vertCount=0,this.type=0}extensions.oes_element_index_uint&&(elementTypes.uint32=GL_UNSIGNED_INT$2),REGLElementBuffer.prototype.bind=function(){this.buffer.bind()};var bufferPool=[];function initElements(elements,data,usage,prim,count,byteLength,type){var dtype;if(elements.buffer.bind(),data){var predictedType=type;type||isTypedArray(data)&&(!isNDArrayLike(data)||isTypedArray(data.data))||(predictedType=extensions.oes_element_index_uint?GL_UNSIGNED_INT$2:GL_UNSIGNED_SHORT$2),bufferState._initBuffer(elements.buffer,data,usage,predictedType,3)}else gl.bufferData(GL_ELEMENT_ARRAY_BUFFER,byteLength,usage),elements.buffer.dtype=dtype||GL_UNSIGNED_BYTE$4,elements.buffer.usage=usage,elements.buffer.dimension=3,elements.buffer.byteLength=byteLength;if(dtype=type,!type){switch(elements.buffer.dtype){case GL_UNSIGNED_BYTE$4:case GL_BYTE$2:dtype=GL_UNSIGNED_BYTE$4;break;case GL_UNSIGNED_SHORT$2:case GL_SHORT$2:dtype=GL_UNSIGNED_SHORT$2;break;case GL_UNSIGNED_INT$2:case GL_INT$2:dtype=GL_UNSIGNED_INT$2;break;default:check$1.raise("unsupported type for element array")}elements.buffer.dtype=dtype}elements.type=dtype,check$1(dtype!==GL_UNSIGNED_INT$2||!!extensions.oes_element_index_uint,"32 bit element buffers not supported, enable oes_element_index_uint first");var vertCount=count;vertCount<0&&(vertCount=elements.buffer.byteLength,dtype===GL_UNSIGNED_SHORT$2?vertCount>>=1:dtype===GL_UNSIGNED_INT$2&&(vertCount>>=2)),elements.vertCount=vertCount;var primType=prim;if(prim<0){primType=GL_TRIANGLES;var dimension=elements.buffer.dimension;1===dimension&&(primType=GL_POINTS),2===dimension&&(primType=GL_LINES),3===dimension&&(primType=GL_TRIANGLES)}elements.primType=primType}function destroyElements(elements){stats.elementsCount--,check$1(null!==elements.buffer,"must not double destroy elements"),delete elementSet[elements.id],elements.buffer.destroy(),elements.buffer=null}return{create:function(options,persistent){var buffer=bufferState.create(null,GL_ELEMENT_ARRAY_BUFFER,!0),elements=new REGLElementBuffer(buffer._buffer);function reglElements(options){if(options)if("number"==typeof options)buffer(options),elements.primType=GL_TRIANGLES,elements.vertCount=0|options,elements.type=GL_UNSIGNED_BYTE$4;else{var data=null,usage=GL_STATIC_DRAW$1,primType=-1,vertCount=-1,byteLength=0,dtype=0;Array.isArray(options)||isTypedArray(options)||isNDArrayLike(options)?data=options:(check$1.type(options,"object","invalid arguments for elements"),"data"in options&&(data=options.data,check$1(Array.isArray(data)||isTypedArray(data)||isNDArrayLike(data),"invalid data for element buffer")),"usage"in options&&(check$1.parameter(options.usage,usageTypes,"invalid element buffer usage"),usage=usageTypes[options.usage]),"primitive"in options&&(check$1.parameter(options.primitive,primTypes,"invalid element buffer primitive"),primType=primTypes[options.primitive]),"count"in options&&(check$1("number"==typeof options.count&&options.count>=0,"invalid vertex count for elements"),vertCount=0|options.count),"type"in options&&(check$1.parameter(options.type,elementTypes,"invalid buffer type"),dtype=elementTypes[options.type]),"length"in options?byteLength=0|options.length:(byteLength=vertCount,dtype===GL_UNSIGNED_SHORT$2||dtype===GL_SHORT$2?byteLength*=2:dtype!==GL_UNSIGNED_INT$2&&dtype!==GL_INT$2||(byteLength*=4))),initElements(elements,data,usage,primType,vertCount,byteLength,dtype)}else buffer(),elements.primType=GL_TRIANGLES,elements.vertCount=0,elements.type=GL_UNSIGNED_BYTE$4;return reglElements}return stats.elementsCount++,reglElements(options),reglElements._reglType="elements",reglElements._elements=elements,reglElements.subdata=function(data,offset){return buffer.subdata(data,offset),reglElements},reglElements.destroy=function(){destroyElements(elements)},reglElements},createStream:function(data){var result=bufferPool.pop();return result||(result=new REGLElementBuffer(bufferState.create(null,GL_ELEMENT_ARRAY_BUFFER,!0,!1)._buffer)),initElements(result,data,GL_STREAM_DRAW$1,-1,-1,0,0),result},destroyStream:function(elements){bufferPool.push(elements)},getElements:function(elements){return"function"==typeof elements&&elements._elements instanceof REGLElementBuffer?elements._elements:null},clear:function(){values(elementSet).forEach(destroyElements)}}}(gl,extensions,bufferState,stats$$1),attributeState=function(gl,extensions,limits,stats,bufferState,elementState,drawState){for(var NUM_ATTRIBUTES=limits.maxAttributes,attributeBindings=new Array(NUM_ATTRIBUTES),i=0;i<NUM_ATTRIBUTES;++i)attributeBindings[i]=new AttributeRecord;var vaoCount=0,vaoSet={},state={Record:AttributeRecord,scope:{},state:attributeBindings,currentVAO:null,targetVAO:null,restore:extVAO()?function(){extVAO()&&values(vaoSet).forEach((function(vao){vao.refresh()}))}:function(){},createVAO:function(_attr){var vao=new REGLVAO;function updateVAO(options){var attributes;if(Array.isArray(options))attributes=options,vao.elements&&vao.ownsElements&&vao.elements.destroy(),vao.elements=null,vao.ownsElements=!1,vao.offset=0,vao.count=0,vao.instances=-1,vao.primitive=4;else{if(check$1("object"==typeof options,"invalid arguments for create vao"),check$1("attributes"in options,"must specify attributes for vao"),options.elements){var elements=options.elements;vao.ownsElements?"function"==typeof elements&&"elements"===elements._reglType?(vao.elements.destroy(),vao.ownsElements=!1):(vao.elements(elements),vao.ownsElements=!1):elementState.getElements(options.elements)?(vao.elements=options.elements,vao.ownsElements=!1):(vao.elements=elementState.create(options.elements),vao.ownsElements=!0)}else vao.elements=null,vao.ownsElements=!1;attributes=options.attributes,vao.offset=0,vao.count=-1,vao.instances=-1,vao.primitive=4,vao.elements&&(vao.count=vao.elements._elements.vertCount,vao.primitive=vao.elements._elements.primType),"offset"in options&&(vao.offset=0|options.offset),"count"in options&&(vao.count=0|options.count),"instances"in options&&(vao.instances=0|options.instances),"primitive"in options&&(check$1(options.primitive in primTypes,"bad primitive type: "+options.primitive),vao.primitive=primTypes[options.primitive]),check$1.optional((()=>{for(var keys=Object.keys(options),i=0;i<keys.length;++i)check$1(VAO_OPTIONS.indexOf(keys[i])>=0,'invalid option for vao: "'+keys[i]+'" valid options are '+VAO_OPTIONS)})),check$1(Array.isArray(attributes),"attributes must be an array")}check$1(attributes.length<NUM_ATTRIBUTES,"too many attributes"),check$1(attributes.length>0,"must specify at least one attribute");var bufUpdated={},nattributes=vao.attributes;nattributes.length=attributes.length;for(var i=0;i<attributes.length;++i){var buf,spec=attributes[i],rec=nattributes[i]=new AttributeRecord,data=spec.data||spec;Array.isArray(data)||isTypedArray(data)||isNDArrayLike(data)?(vao.buffers[i]&&(buf=vao.buffers[i],isTypedArray(data)&&buf._buffer.byteLength>=data.byteLength?buf.subdata(data):(buf.destroy(),vao.buffers[i]=null)),vao.buffers[i]||(buf=vao.buffers[i]=bufferState.create(spec,GL_ARRAY_BUFFER$1,!1,!0)),rec.buffer=bufferState.getBuffer(buf),rec.size=0|rec.buffer.dimension,rec.normalized=!1,rec.type=rec.buffer.dtype,rec.offset=0,rec.stride=0,rec.divisor=0,rec.state=1,bufUpdated[i]=1):bufferState.getBuffer(spec)?(rec.buffer=bufferState.getBuffer(spec),rec.size=0|rec.buffer.dimension,rec.normalized=!1,rec.type=rec.buffer.dtype,rec.offset=0,rec.stride=0,rec.divisor=0,rec.state=1):bufferState.getBuffer(spec.buffer)?(rec.buffer=bufferState.getBuffer(spec.buffer),rec.size=0|(+spec.size||rec.buffer.dimension),rec.normalized=!!spec.normalized||!1,"type"in spec?(check$1.parameter(spec.type,glTypes,"invalid buffer type"),rec.type=glTypes[spec.type]):rec.type=rec.buffer.dtype,rec.offset=0|(spec.offset||0),rec.stride=0|(spec.stride||0),rec.divisor=0|(spec.divisor||0),rec.state=1,check$1(rec.size>=1&&rec.size<=4,"size must be between 1 and 4"),check$1(rec.offset>=0,"invalid offset"),check$1(rec.stride>=0&&rec.stride<=255,"stride must be between 0 and 255"),check$1(rec.divisor>=0,"divisor must be positive"),check$1(!rec.divisor||!!extensions.angle_instanced_arrays,"ANGLE_instanced_arrays must be enabled to use divisor")):"x"in spec?(check$1(i>0,"first attribute must not be a constant"),rec.x=+spec.x||0,rec.y=+spec.y||0,rec.z=+spec.z||0,rec.w=+spec.w||0,rec.state=2):check$1(!1,"invalid attribute spec for location "+i)}for(var j=0;j<vao.buffers.length;++j)!bufUpdated[j]&&vao.buffers[j]&&(vao.buffers[j].destroy(),vao.buffers[j]=null);return vao.refresh(),updateVAO}return stats.vaoCount+=1,updateVAO.destroy=function(){for(var j=0;j<vao.buffers.length;++j)vao.buffers[j]&&vao.buffers[j].destroy();vao.buffers.length=0,vao.ownsElements&&(vao.elements.destroy(),vao.elements=null,vao.ownsElements=!1),vao.destroy()},updateVAO._vao=vao,updateVAO._reglType="vao",updateVAO(_attr)},getVAO:function(vao){return"function"==typeof vao&&vao._vao?vao._vao:null},destroyBuffer:function(buffer){for(var i=0;i<attributeBindings.length;++i){var record=attributeBindings[i];record.buffer===buffer&&(gl.disableVertexAttribArray(i),record.buffer=null)}},setVAO:extVAO()?function(vao){if(vao!==state.currentVAO){var ext=extVAO();vao?ext.bindVertexArrayOES(vao.vao):ext.bindVertexArrayOES(null),state.currentVAO=vao}}:function(vao){if(vao!==state.currentVAO){if(vao)vao.bindAttrs();else{for(var exti=extInstanced(),i=0;i<attributeBindings.length;++i){var binding=attributeBindings[i];binding.buffer?(gl.enableVertexAttribArray(i),binding.buffer.bind(),gl.vertexAttribPointer(i,binding.size,binding.type,binding.normalized,binding.stride,binding.offfset),exti&&binding.divisor&&exti.vertexAttribDivisorANGLE(i,binding.divisor)):(gl.disableVertexAttribArray(i),gl.vertexAttrib4f(i,binding.x,binding.y,binding.z,binding.w))}drawState.elements?gl.bindBuffer(GL_ELEMENT_ARRAY_BUFFER$1,drawState.elements.buffer.buffer):gl.bindBuffer(GL_ELEMENT_ARRAY_BUFFER$1,null)}state.currentVAO=vao}},clear:extVAO()?function(){values(vaoSet).forEach((function(vao){vao.destroy()}))}:function(){}};function extVAO(){return extensions.oes_vertex_array_object}function extInstanced(){return extensions.angle_instanced_arrays}function REGLVAO(){this.id=++vaoCount,this.attributes=[],this.elements=null,this.ownsElements=!1,this.count=0,this.offset=0,this.instances=-1,this.primitive=4;var extension=extVAO();this.vao=extension?extension.createVertexArrayOES():null,vaoSet[this.id]=this,this.buffers=[]}return REGLVAO.prototype.bindAttrs=function(){for(var exti=extInstanced(),attributes=this.attributes,i=0;i<attributes.length;++i){var attr=attributes[i];attr.buffer?(gl.enableVertexAttribArray(i),gl.bindBuffer(GL_ARRAY_BUFFER$1,attr.buffer.buffer),gl.vertexAttribPointer(i,attr.size,attr.type,attr.normalized,attr.stride,attr.offset),exti&&attr.divisor&&exti.vertexAttribDivisorANGLE(i,attr.divisor)):(gl.disableVertexAttribArray(i),gl.vertexAttrib4f(i,attr.x,attr.y,attr.z,attr.w))}for(var j=attributes.length;j<NUM_ATTRIBUTES;++j)gl.disableVertexAttribArray(j);var elements=elementState.getElements(this.elements);elements?gl.bindBuffer(GL_ELEMENT_ARRAY_BUFFER$1,elements.buffer.buffer):gl.bindBuffer(GL_ELEMENT_ARRAY_BUFFER$1,null)},REGLVAO.prototype.refresh=function(){var ext=extVAO();ext&&(ext.bindVertexArrayOES(this.vao),this.bindAttrs(),state.currentVAO=null,ext.bindVertexArrayOES(null))},REGLVAO.prototype.destroy=function(){if(this.vao){var extension=extVAO();this===state.currentVAO&&(state.currentVAO=null,extension.bindVertexArrayOES(null)),extension.deleteVertexArrayOES(this.vao),this.vao=null}this.ownsElements&&(this.elements.destroy(),this.elements=null,this.ownsElements=!1),vaoSet[this.id]&&(delete vaoSet[this.id],stats.vaoCount-=1)},state}(gl,extensions,limits,stats$$1,bufferState,elementState,drawState),shaderState=function(gl,stringStore,stats,config){var fragShaders={},vertShaders={};function ActiveInfo(name,id,location,info){this.name=name,this.id=id,this.location=location,this.info=info}function insertActiveInfo(list,info){for(var i=0;i<list.length;++i)if(list[i].id===info.id)return void(list[i].location=info.location);list.push(info)}function getShader(type,id,command){var cache=type===GL_FRAGMENT_SHADER?fragShaders:vertShaders,shader=cache[id];if(!shader){var source=stringStore.str(id);shader=gl.createShader(type),gl.shaderSource(shader,source),gl.compileShader(shader),check$1.shaderError(gl,shader,source,type,command),cache[id]=shader}return shader}var programCache={},programList=[],PROGRAM_COUNTER=0;function REGLProgram(fragId,vertId){this.id=PROGRAM_COUNTER++,this.fragId=fragId,this.vertId=vertId,this.program=null,this.uniforms=[],this.attributes=[],this.refCount=1,config.profile&&(this.stats={uniformsCount:0,attributesCount:0})}function linkProgram(desc,command,attributeLocations){var i,info,fragShader=getShader(GL_FRAGMENT_SHADER,desc.fragId),vertShader=getShader(GL_VERTEX_SHADER,desc.vertId),program=desc.program=gl.createProgram();if(gl.attachShader(program,fragShader),gl.attachShader(program,vertShader),attributeLocations)for(i=0;i<attributeLocations.length;++i){var binding=attributeLocations[i];gl.bindAttribLocation(program,binding[0],binding[1])}gl.linkProgram(program),check$1.linkError(gl,program,stringStore.str(desc.fragId),stringStore.str(desc.vertId),command);var numUniforms=gl.getProgramParameter(program,GL_ACTIVE_UNIFORMS);config.profile&&(desc.stats.uniformsCount=numUniforms);var uniforms=desc.uniforms;for(i=0;i<numUniforms;++i)if(info=gl.getActiveUniform(program,i)){if(info.size>1)for(var j=0;j<info.size;++j){var name=info.name.replace("[0]","["+j+"]");insertActiveInfo(uniforms,new ActiveInfo(name,stringStore.id(name),gl.getUniformLocation(program,name),info))}var uniName=info.name;info.size>1&&(uniName=uniName.replace("[0]","")),insertActiveInfo(uniforms,new ActiveInfo(uniName,stringStore.id(uniName),gl.getUniformLocation(program,uniName),info))}var numAttributes=gl.getProgramParameter(program,GL_ACTIVE_ATTRIBUTES);config.profile&&(desc.stats.attributesCount=numAttributes);var attributes=desc.attributes;for(i=0;i<numAttributes;++i)(info=gl.getActiveAttrib(program,i))&&insertActiveInfo(attributes,new ActiveInfo(info.name,stringStore.id(info.name),gl.getAttribLocation(program,info.name),info))}return config.profile&&(stats.getMaxUniformsCount=function(){var m=0;return programList.forEach((function(desc){desc.stats.uniformsCount>m&&(m=desc.stats.uniformsCount)})),m},stats.getMaxAttributesCount=function(){var m=0;return programList.forEach((function(desc){desc.stats.attributesCount>m&&(m=desc.stats.attributesCount)})),m}),{clear:function(){var deleteShader=gl.deleteShader.bind(gl);values(fragShaders).forEach(deleteShader),fragShaders={},values(vertShaders).forEach(deleteShader),vertShaders={},programList.forEach((function(desc){gl.deleteProgram(desc.program)})),programList.length=0,programCache={},stats.shaderCount=0},program:function(vertId,fragId,command,attribLocations){check$1.command(vertId>=0,"missing vertex shader",command),check$1.command(fragId>=0,"missing fragment shader",command);var cache=programCache[fragId];cache||(cache=programCache[fragId]={});var prevProgram=cache[vertId];if(prevProgram&&(prevProgram.refCount++,!attribLocations))return prevProgram;var program=new REGLProgram(fragId,vertId);return stats.shaderCount++,linkProgram(program,command,attribLocations),prevProgram||(cache[vertId]=program),programList.push(program),extend(program,{destroy:function(){if(program.refCount--,program.refCount<=0){gl.deleteProgram(program.program);var idx=programList.indexOf(program);programList.splice(idx,1),stats.shaderCount--}cache[program.vertId].refCount<=0&&(gl.deleteShader(vertShaders[program.vertId]),delete vertShaders[program.vertId],delete programCache[program.fragId][program.vertId]),Object.keys(programCache[program.fragId]).length||(gl.deleteShader(fragShaders[program.fragId]),delete fragShaders[program.fragId],delete programCache[program.fragId])}})},restore:function(){fragShaders={},vertShaders={};for(var i=0;i<programList.length;++i)linkProgram(programList[i],null,programList[i].attributes.map((function(info){return[info.location,info.name]})))},shader:getShader,frag:-1,vert:-1}}(gl,stringStore,stats$$1,config),textureState=createTextureSet(gl,extensions,limits,(function(){core.procs.poll()}),contextState,stats$$1,config),renderbufferState=function(gl,extensions,limits,stats,config){var formatTypes={rgba4:32854,rgb565:36194,"rgb5 a1":32855,depth:33189,stencil:36168,"depth stencil":34041};extensions.ext_srgb&&(formatTypes.srgba=35907),extensions.ext_color_buffer_half_float&&(formatTypes.rgba16f=34842,formatTypes.rgb16f=34843),extensions.webgl_color_buffer_float&&(formatTypes.rgba32f=34836);var formatTypesInvert=[];Object.keys(formatTypes).forEach((function(key){var val=formatTypes[key];formatTypesInvert[val]=key}));var renderbufferCount=0,renderbufferSet={};function REGLRenderbuffer(renderbuffer){this.id=renderbufferCount++,this.refCount=1,this.renderbuffer=renderbuffer,this.format=32854,this.width=0,this.height=0,config.profile&&(this.stats={size:0})}function destroy(rb){var handle=rb.renderbuffer;check$1(handle,"must not double destroy renderbuffer"),gl.bindRenderbuffer(36161,null),gl.deleteRenderbuffer(handle),rb.renderbuffer=null,rb.refCount=0,delete renderbufferSet[rb.id],stats.renderbufferCount--}return REGLRenderbuffer.prototype.decRef=function(){--this.refCount<=0&&destroy(this)},config.profile&&(stats.getTotalRenderbufferSize=function(){var total=0;return Object.keys(renderbufferSet).forEach((function(key){total+=renderbufferSet[key].stats.size})),total}),{create:function(a,b){var renderbuffer=new REGLRenderbuffer(gl.createRenderbuffer());function reglRenderbuffer(a,b){var w=0,h=0,format=32854;if("object"==typeof a&&a){var options=a;if("shape"in options){var shape=options.shape;check$1(Array.isArray(shape)&&shape.length>=2,"invalid renderbuffer shape"),w=0|shape[0],h=0|shape[1]}else"radius"in options&&(w=h=0|options.radius),"width"in options&&(w=0|options.width),"height"in options&&(h=0|options.height);"format"in options&&(check$1.parameter(options.format,formatTypes,"invalid renderbuffer format"),format=formatTypes[options.format])}else"number"==typeof a?(w=0|a,h="number"==typeof b?0|b:w):a?check$1.raise("invalid arguments to renderbuffer constructor"):w=h=1;if(check$1(w>0&&h>0&&w<=limits.maxRenderbufferSize&&h<=limits.maxRenderbufferSize,"invalid renderbuffer size"),w!==renderbuffer.width||h!==renderbuffer.height||format!==renderbuffer.format)return reglRenderbuffer.width=renderbuffer.width=w,reglRenderbuffer.height=renderbuffer.height=h,renderbuffer.format=format,gl.bindRenderbuffer(36161,renderbuffer.renderbuffer),gl.renderbufferStorage(36161,format,w,h),check$1(0===gl.getError(),"invalid render buffer format"),config.profile&&(renderbuffer.stats.size=getRenderbufferSize(renderbuffer.format,renderbuffer.width,renderbuffer.height)),reglRenderbuffer.format=formatTypesInvert[renderbuffer.format],reglRenderbuffer}return renderbufferSet[renderbuffer.id]=renderbuffer,stats.renderbufferCount++,reglRenderbuffer(a,b),reglRenderbuffer.resize=function(w_,h_){var w=0|w_,h=0|h_||w;return w===renderbuffer.width&&h===renderbuffer.height||(check$1(w>0&&h>0&&w<=limits.maxRenderbufferSize&&h<=limits.maxRenderbufferSize,"invalid renderbuffer size"),reglRenderbuffer.width=renderbuffer.width=w,reglRenderbuffer.height=renderbuffer.height=h,gl.bindRenderbuffer(36161,renderbuffer.renderbuffer),gl.renderbufferStorage(36161,renderbuffer.format,w,h),check$1(0===gl.getError(),"invalid render buffer format"),config.profile&&(renderbuffer.stats.size=getRenderbufferSize(renderbuffer.format,renderbuffer.width,renderbuffer.height))),reglRenderbuffer},reglRenderbuffer._reglType="renderbuffer",reglRenderbuffer._renderbuffer=renderbuffer,config.profile&&(reglRenderbuffer.stats=renderbuffer.stats),reglRenderbuffer.destroy=function(){renderbuffer.decRef()},reglRenderbuffer},clear:function(){values(renderbufferSet).forEach(destroy)},restore:function(){values(renderbufferSet).forEach((function(rb){rb.renderbuffer=gl.createRenderbuffer(),gl.bindRenderbuffer(36161,rb.renderbuffer),gl.renderbufferStorage(36161,rb.format,rb.width,rb.height)})),gl.bindRenderbuffer(36161,null)}}}(gl,extensions,limits,stats$$1,config),framebufferState=function(gl,extensions,limits,textureState,renderbufferState,stats){var framebufferState={cur:null,next:null,dirty:!1,setFBO:null},colorTextureFormats=["rgba"],colorRenderbufferFormats=["rgba4","rgb565","rgb5 a1"];extensions.ext_srgb&&colorRenderbufferFormats.push("srgba"),extensions.ext_color_buffer_half_float&&colorRenderbufferFormats.push("rgba16f","rgb16f"),extensions.webgl_color_buffer_float&&colorRenderbufferFormats.push("rgba32f");var colorTypes=["uint8"];function FramebufferAttachment(target,texture,renderbuffer){this.target=target,this.texture=texture,this.renderbuffer=renderbuffer;var w=0,h=0;texture?(w=texture.width,h=texture.height):renderbuffer&&(w=renderbuffer.width,h=renderbuffer.height),this.width=w,this.height=h}function decRef(attachment){attachment&&(attachment.texture&&attachment.texture._texture.decRef(),attachment.renderbuffer&&attachment.renderbuffer._renderbuffer.decRef())}function incRefAndCheckShape(attachment,width,height){if(attachment)if(attachment.texture){var texture=attachment.texture._texture,tw=Math.max(1,texture.width),th=Math.max(1,texture.height);check$1(tw===width&&th===height,"inconsistent width/height for supplied texture"),texture.refCount+=1}else{var renderbuffer=attachment.renderbuffer._renderbuffer;check$1(renderbuffer.width===width&&renderbuffer.height===height,"inconsistent width/height for renderbuffer"),renderbuffer.refCount+=1}}function attach(location,attachment){attachment&&(attachment.texture?gl.framebufferTexture2D(GL_FRAMEBUFFER$1,location,attachment.target,attachment.texture._texture.texture,0):gl.framebufferRenderbuffer(GL_FRAMEBUFFER$1,location,GL_RENDERBUFFER$1,attachment.renderbuffer._renderbuffer.renderbuffer))}function parseAttachment(attachment){var target=GL_TEXTURE_2D$2,texture=null,renderbuffer=null,data=attachment;"object"==typeof attachment&&(data=attachment.data,"target"in attachment&&(target=0|attachment.target)),check$1.type(data,"function","invalid attachment data");var type=data._reglType;return"texture2d"===type?(texture=data,check$1(target===GL_TEXTURE_2D$2)):"textureCube"===type?(texture=data,check$1(target>=GL_TEXTURE_CUBE_MAP_POSITIVE_X$2&&target<GL_TEXTURE_CUBE_MAP_POSITIVE_X$2+6,"invalid cube map target")):"renderbuffer"===type?(renderbuffer=data,target=GL_RENDERBUFFER$1):check$1.raise("invalid regl object for attachment"),new FramebufferAttachment(target,texture,renderbuffer)}function allocAttachment(width,height,isTexture,format,type){if(isTexture){var texture=textureState.create2D({width:width,height:height,format:format,type:type});return texture._texture.refCount=0,new FramebufferAttachment(GL_TEXTURE_2D$2,texture,null)}var rb=renderbufferState.create({width:width,height:height,format:format});return rb._renderbuffer.refCount=0,new FramebufferAttachment(GL_RENDERBUFFER$1,null,rb)}function unwrapAttachment(attachment){return attachment&&(attachment.texture||attachment.renderbuffer)}function resizeAttachment(attachment,w,h){attachment&&(attachment.texture?attachment.texture.resize(w,h):attachment.renderbuffer&&attachment.renderbuffer.resize(w,h),attachment.width=w,attachment.height=h)}extensions.oes_texture_half_float&&colorTypes.push("half float","float16"),extensions.oes_texture_float&&colorTypes.push("float","float32");var framebufferCount=0,framebufferSet={};function REGLFramebuffer(){this.id=framebufferCount++,framebufferSet[this.id]=this,this.framebuffer=gl.createFramebuffer(),this.width=0,this.height=0,this.colorAttachments=[],this.depthAttachment=null,this.stencilAttachment=null,this.depthStencilAttachment=null}function decFBORefs(framebuffer){framebuffer.colorAttachments.forEach(decRef),decRef(framebuffer.depthAttachment),decRef(framebuffer.stencilAttachment),decRef(framebuffer.depthStencilAttachment)}function destroy(framebuffer){var handle=framebuffer.framebuffer;check$1(handle,"must not double destroy framebuffer"),gl.deleteFramebuffer(handle),framebuffer.framebuffer=null,stats.framebufferCount--,delete framebufferSet[framebuffer.id]}function updateFramebuffer(framebuffer){var i;gl.bindFramebuffer(GL_FRAMEBUFFER$1,framebuffer.framebuffer);var colorAttachments=framebuffer.colorAttachments;for(i=0;i<colorAttachments.length;++i)attach(GL_COLOR_ATTACHMENT0$1+i,colorAttachments[i]);for(i=colorAttachments.length;i<limits.maxColorAttachments;++i)gl.framebufferTexture2D(GL_FRAMEBUFFER$1,GL_COLOR_ATTACHMENT0$1+i,GL_TEXTURE_2D$2,null,0);gl.framebufferTexture2D(GL_FRAMEBUFFER$1,GL_DEPTH_STENCIL_ATTACHMENT,GL_TEXTURE_2D$2,null,0),gl.framebufferTexture2D(GL_FRAMEBUFFER$1,GL_DEPTH_ATTACHMENT,GL_TEXTURE_2D$2,null,0),gl.framebufferTexture2D(GL_FRAMEBUFFER$1,GL_STENCIL_ATTACHMENT,GL_TEXTURE_2D$2,null,0),attach(GL_DEPTH_ATTACHMENT,framebuffer.depthAttachment),attach(GL_STENCIL_ATTACHMENT,framebuffer.stencilAttachment),attach(GL_DEPTH_STENCIL_ATTACHMENT,framebuffer.depthStencilAttachment);var status=gl.checkFramebufferStatus(GL_FRAMEBUFFER$1);gl.isContextLost()||status===GL_FRAMEBUFFER_COMPLETE$1||check$1.raise("framebuffer configuration not supported, status = "+statusCode[status]),gl.bindFramebuffer(GL_FRAMEBUFFER$1,framebufferState.next?framebufferState.next.framebuffer:null),framebufferState.cur=framebufferState.next,gl.getError()}function createFBO(a0,a1){var framebuffer=new REGLFramebuffer;function reglFramebuffer(a,b){var i;check$1(framebufferState.next!==framebuffer,"can not update framebuffer which is currently in use");var width=0,height=0,needsDepth=!0,needsStencil=!0,colorBuffer=null,colorTexture=!0,colorFormat="rgba",colorType="uint8",colorCount=1,depthBuffer=null,stencilBuffer=null,depthStencilBuffer=null,depthStencilTexture=!1;if("number"==typeof a)width=0|a,height=0|b||width;else if(a){check$1.type(a,"object","invalid arguments for framebuffer");var options=a;if("shape"in options){var shape=options.shape;check$1(Array.isArray(shape)&&shape.length>=2,"invalid shape for framebuffer"),width=shape[0],height=shape[1]}else"radius"in options&&(width=height=options.radius),"width"in options&&(width=options.width),"height"in options&&(height=options.height);("color"in options||"colors"in options)&&(colorBuffer=options.color||options.colors,Array.isArray(colorBuffer)&&check$1(1===colorBuffer.length||extensions.webgl_draw_buffers,"multiple render targets not supported")),colorBuffer||("colorCount"in options&&(colorCount=0|options.colorCount,check$1(colorCount>0,"invalid color buffer count")),"colorTexture"in options&&(colorTexture=!!options.colorTexture,colorFormat="rgba4"),"colorType"in options&&(colorType=options.colorType,colorTexture?(check$1(extensions.oes_texture_float||!("float"===colorType||"float32"===colorType),"you must enable OES_texture_float in order to use floating point framebuffer objects"),check$1(extensions.oes_texture_half_float||!("half float"===colorType||"float16"===colorType),"you must enable OES_texture_half_float in order to use 16-bit floating point framebuffer objects")):"half float"===colorType||"float16"===colorType?(check$1(extensions.ext_color_buffer_half_float,"you must enable EXT_color_buffer_half_float to use 16-bit render buffers"),colorFormat="rgba16f"):"float"!==colorType&&"float32"!==colorType||(check$1(extensions.webgl_color_buffer_float,"you must enable WEBGL_color_buffer_float in order to use 32-bit floating point renderbuffers"),colorFormat="rgba32f"),check$1.oneOf(colorType,colorTypes,"invalid color type")),"colorFormat"in options&&(colorFormat=options.colorFormat,colorTextureFormats.indexOf(colorFormat)>=0?colorTexture=!0:colorRenderbufferFormats.indexOf(colorFormat)>=0?colorTexture=!1:check$1.optional((function(){colorTexture?check$1.oneOf(options.colorFormat,colorTextureFormats,"invalid color format for texture"):check$1.oneOf(options.colorFormat,colorRenderbufferFormats,"invalid color format for renderbuffer")})))),("depthTexture"in options||"depthStencilTexture"in options)&&(depthStencilTexture=!(!options.depthTexture&&!options.depthStencilTexture),check$1(!depthStencilTexture||extensions.webgl_depth_texture,"webgl_depth_texture extension not supported")),"depth"in options&&("boolean"==typeof options.depth?needsDepth=options.depth:(depthBuffer=options.depth,needsStencil=!1)),"stencil"in options&&("boolean"==typeof options.stencil?needsStencil=options.stencil:(stencilBuffer=options.stencil,needsDepth=!1)),"depthStencil"in options&&("boolean"==typeof options.depthStencil?needsDepth=needsStencil=options.depthStencil:(depthStencilBuffer=options.depthStencil,needsDepth=!1,needsStencil=!1))}else width=height=1;var colorAttachments=null,depthAttachment=null,stencilAttachment=null,depthStencilAttachment=null;if(Array.isArray(colorBuffer))colorAttachments=colorBuffer.map(parseAttachment);else if(colorBuffer)colorAttachments=[parseAttachment(colorBuffer)];else for(colorAttachments=new Array(colorCount),i=0;i<colorCount;++i)colorAttachments[i]=allocAttachment(width,height,colorTexture,colorFormat,colorType);check$1(extensions.webgl_draw_buffers||colorAttachments.length<=1,"you must enable the WEBGL_draw_buffers extension in order to use multiple color buffers."),check$1(colorAttachments.length<=limits.maxColorAttachments,"too many color attachments, not supported"),width=width||colorAttachments[0].width,height=height||colorAttachments[0].height,depthBuffer?depthAttachment=parseAttachment(depthBuffer):needsDepth&&!needsStencil&&(depthAttachment=allocAttachment(width,height,depthStencilTexture,"depth","uint32")),stencilBuffer?stencilAttachment=parseAttachment(stencilBuffer):needsStencil&&!needsDepth&&(stencilAttachment=allocAttachment(width,height,!1,"stencil","uint8")),depthStencilBuffer?depthStencilAttachment=parseAttachment(depthStencilBuffer):!depthBuffer&&!stencilBuffer&&needsStencil&&needsDepth&&(depthStencilAttachment=allocAttachment(width,height,depthStencilTexture,"depth stencil","depth stencil")),check$1(!!depthBuffer+!!stencilBuffer+!!depthStencilBuffer<=1,"invalid framebuffer configuration, can specify exactly one depth/stencil attachment");var commonColorAttachmentSize=null;for(i=0;i<colorAttachments.length;++i)if(incRefAndCheckShape(colorAttachments[i],width,height),check$1(!colorAttachments[i]||colorAttachments[i].texture&&colorTextureFormatEnums.indexOf(colorAttachments[i].texture._texture.format)>=0||colorAttachments[i].renderbuffer&&colorRenderbufferFormatEnums.indexOf(colorAttachments[i].renderbuffer._renderbuffer.format)>=0,"framebuffer color attachment "+i+" is invalid"),colorAttachments[i]&&colorAttachments[i].texture){var colorAttachmentSize=textureFormatChannels[colorAttachments[i].texture._texture.format]*textureTypeSizes[colorAttachments[i].texture._texture.type];null===commonColorAttachmentSize?commonColorAttachmentSize=colorAttachmentSize:check$1(commonColorAttachmentSize===colorAttachmentSize,"all color attachments much have the same number of bits per pixel.")}return incRefAndCheckShape(depthAttachment,width,height),check$1(!depthAttachment||depthAttachment.texture&&depthAttachment.texture._texture.format===GL_DEPTH_COMPONENT$1||depthAttachment.renderbuffer&&depthAttachment.renderbuffer._renderbuffer.format===GL_DEPTH_COMPONENT16$1,"invalid depth attachment for framebuffer object"),incRefAndCheckShape(stencilAttachment,width,height),check$1(!stencilAttachment||stencilAttachment.renderbuffer&&stencilAttachment.renderbuffer._renderbuffer.format===GL_STENCIL_INDEX8$1,"invalid stencil attachment for framebuffer object"),incRefAndCheckShape(depthStencilAttachment,width,height),check$1(!depthStencilAttachment||depthStencilAttachment.texture&&depthStencilAttachment.texture._texture.format===GL_DEPTH_STENCIL$2||depthStencilAttachment.renderbuffer&&depthStencilAttachment.renderbuffer._renderbuffer.format===GL_DEPTH_STENCIL$2,"invalid depth-stencil attachment for framebuffer object"),decFBORefs(framebuffer),framebuffer.width=width,framebuffer.height=height,framebuffer.colorAttachments=colorAttachments,framebuffer.depthAttachment=depthAttachment,framebuffer.stencilAttachment=stencilAttachment,framebuffer.depthStencilAttachment=depthStencilAttachment,reglFramebuffer.color=colorAttachments.map(unwrapAttachment),reglFramebuffer.depth=unwrapAttachment(depthAttachment),reglFramebuffer.stencil=unwrapAttachment(stencilAttachment),reglFramebuffer.depthStencil=unwrapAttachment(depthStencilAttachment),reglFramebuffer.width=framebuffer.width,reglFramebuffer.height=framebuffer.height,updateFramebuffer(framebuffer),reglFramebuffer}return stats.framebufferCount++,reglFramebuffer(a0,a1),extend(reglFramebuffer,{resize:function(w_,h_){check$1(framebufferState.next!==framebuffer,"can not resize a framebuffer which is currently in use");var w=Math.max(0|w_,1),h=Math.max(0|h_||w,1);if(w===framebuffer.width&&h===framebuffer.height)return reglFramebuffer;for(var colorAttachments=framebuffer.colorAttachments,i=0;i<colorAttachments.length;++i)resizeAttachment(colorAttachments[i],w,h);return resizeAttachment(framebuffer.depthAttachment,w,h),resizeAttachment(framebuffer.stencilAttachment,w,h),resizeAttachment(framebuffer.depthStencilAttachment,w,h),framebuffer.width=reglFramebuffer.width=w,framebuffer.height=reglFramebuffer.height=h,updateFramebuffer(framebuffer),reglFramebuffer},_reglType:"framebuffer",_framebuffer:framebuffer,destroy:function(){destroy(framebuffer),decFBORefs(framebuffer)},use:function(block){framebufferState.setFBO({framebuffer:reglFramebuffer},block)}})}return extend(framebufferState,{getFramebuffer:function(object){if("function"==typeof object&&"framebuffer"===object._reglType){var fbo=object._framebuffer;if(fbo instanceof REGLFramebuffer)return fbo}return null},create:createFBO,createCube:function(options){var faces=Array(6);function reglFramebufferCube(a){var i;check$1(faces.indexOf(framebufferState.next)<0,"can not update framebuffer which is currently in use");var colorCubes,params={color:null},radius=0,colorBuffer=null,colorFormat="rgba",colorType="uint8",colorCount=1;if("number"==typeof a)radius=0|a;else if(a){check$1.type(a,"object","invalid arguments for framebuffer");var options=a;if("shape"in options){var shape=options.shape;check$1(Array.isArray(shape)&&shape.length>=2,"invalid shape for framebuffer"),check$1(shape[0]===shape[1],"cube framebuffer must be square"),radius=shape[0]}else"radius"in options&&(radius=0|options.radius),"width"in options?(radius=0|options.width,"height"in options&&check$1(options.height===radius,"must be square")):"height"in options&&(radius=0|options.height);("color"in options||"colors"in options)&&(colorBuffer=options.color||options.colors,Array.isArray(colorBuffer)&&check$1(1===colorBuffer.length||extensions.webgl_draw_buffers,"multiple render targets not supported")),colorBuffer||("colorCount"in options&&(colorCount=0|options.colorCount,check$1(colorCount>0,"invalid color buffer count")),"colorType"in options&&(check$1.oneOf(options.colorType,colorTypes,"invalid color type"),colorType=options.colorType),"colorFormat"in options&&(colorFormat=options.colorFormat,check$1.oneOf(options.colorFormat,colorTextureFormats,"invalid color format for texture"))),"depth"in options&&(params.depth=options.depth),"stencil"in options&&(params.stencil=options.stencil),"depthStencil"in options&&(params.depthStencil=options.depthStencil)}else radius=1;if(colorBuffer)if(Array.isArray(colorBuffer))for(colorCubes=[],i=0;i<colorBuffer.length;++i)colorCubes[i]=colorBuffer[i];else colorCubes=[colorBuffer];else{colorCubes=Array(colorCount);var cubeMapParams={radius:radius,format:colorFormat,type:colorType};for(i=0;i<colorCount;++i)colorCubes[i]=textureState.createCube(cubeMapParams)}for(params.color=Array(colorCubes.length),i=0;i<colorCubes.length;++i){var cube=colorCubes[i];check$1("function"==typeof cube&&"textureCube"===cube._reglType,"invalid cube map"),radius=radius||cube.width,check$1(cube.width===radius&&cube.height===radius,"invalid cube map shape"),params.color[i]={target:GL_TEXTURE_CUBE_MAP_POSITIVE_X$2,data:colorCubes[i]}}for(i=0;i<6;++i){for(var j=0;j<colorCubes.length;++j)params.color[j].target=GL_TEXTURE_CUBE_MAP_POSITIVE_X$2+i;i>0&&(params.depth=faces[0].depth,params.stencil=faces[0].stencil,params.depthStencil=faces[0].depthStencil),faces[i]?faces[i](params):faces[i]=createFBO(params)}return extend(reglFramebufferCube,{width:radius,height:radius,color:colorCubes})}return reglFramebufferCube(options),extend(reglFramebufferCube,{faces:faces,resize:function(radius_){var i,radius=0|radius_;if(check$1(radius>0&&radius<=limits.maxCubeMapSize,"invalid radius for cube fbo"),radius===reglFramebufferCube.width)return reglFramebufferCube;var colors=reglFramebufferCube.color;for(i=0;i<colors.length;++i)colors[i].resize(radius);for(i=0;i<6;++i)faces[i].resize(radius);return reglFramebufferCube.width=reglFramebufferCube.height=radius,reglFramebufferCube},_reglType:"framebufferCube",destroy:function(){faces.forEach((function(f){f.destroy()}))}})},clear:function(){values(framebufferSet).forEach(destroy)},restore:function(){framebufferState.cur=null,framebufferState.next=null,framebufferState.dirty=!0,values(framebufferSet).forEach((function(fb){fb.framebuffer=gl.createFramebuffer(),updateFramebuffer(fb)}))}})}(gl,extensions,limits,textureState,renderbufferState,stats$$1),core=reglCore(gl,stringStore,extensions,limits,bufferState,elementState,0,framebufferState,{},attributeState,shaderState,drawState,contextState,timer,config),readPixels=wrapReadPixels(gl,framebufferState,core.procs.poll,contextState,glAttributes,extensions,limits),nextState=core.next,canvas=gl.canvas,rafCallbacks=[],lossCallbacks=[],restoreCallbacks=[],destroyCallbacks=[config.onDestroy],activeRAF=null;function handleRAF(){if(0===rafCallbacks.length)return timer&&timer.update(),void(activeRAF=null);activeRAF=raf.next(handleRAF),poll();for(var i=rafCallbacks.length-1;i>=0;--i){var cb=rafCallbacks[i];cb&&cb(contextState,null,0)}gl.flush(),timer&&timer.update()}function startRAF(){!activeRAF&&rafCallbacks.length>0&&(activeRAF=raf.next(handleRAF))}function stopRAF(){activeRAF&&(raf.cancel(handleRAF),activeRAF=null)}function handleContextLoss(event){event.preventDefault(),contextLost=!0,stopRAF(),lossCallbacks.forEach((function(cb){cb()}))}function handleContextRestored(event){gl.getError(),contextLost=!1,extensionState.restore(),shaderState.restore(),bufferState.restore(),textureState.restore(),renderbufferState.restore(),framebufferState.restore(),attributeState.restore(),timer&&timer.restore(),core.procs.refresh(),startRAF(),restoreCallbacks.forEach((function(cb){cb()}))}function compileProcedure(options){function separateDynamic(object,useArrays){var staticItems={},dynamicItems={};return Object.keys(object).forEach((function(option){var value=object[option];if(dynamic.isDynamic(value))dynamicItems[option]=dynamic.unbox(value,option);else{if(useArrays&&Array.isArray(value))for(var i=0;i<value.length;++i)if(dynamic.isDynamic(value[i]))return void(dynamicItems[option]=dynamic.unbox(value,option));staticItems[option]=value}})),{dynamic:dynamicItems,static:staticItems}}check$1(!!options,"invalid args to regl({...})"),check$1.type(options,"object","invalid args to regl({...})");var context=separateDynamic(options.context||{},!0),uniforms=separateDynamic(options.uniforms||{},!0),attributes=separateDynamic(options.attributes||{},!1),opts=separateDynamic(function(options){var result=extend({},options);function merge(name){if(name in result){var child=result[name];delete result[name],Object.keys(child).forEach((function(prop){result[name+"."+prop]=child[prop]}))}}return delete result.uniforms,delete result.attributes,delete result.context,delete result.vao,"stencil"in result&&result.stencil.op&&(result.stencil.opBack=result.stencil.opFront=result.stencil.op,delete result.stencil.op),merge("blend"),merge("depth"),merge("cull"),merge("stencil"),merge("polygonOffset"),merge("scissor"),merge("sample"),"vao"in options&&(result.vao=options.vao),result}(options),!1),stats$$1={gpuTime:0,cpuTime:0,count:0},compiled=core.compile(opts,attributes,uniforms,context,stats$$1),draw=compiled.draw,batch=compiled.batch,scope=compiled.scope,EMPTY_ARRAY=[];return extend((function(args,body){var i;if(contextLost&&check$1.raise("context lost"),"function"==typeof args)return scope.call(this,null,args,0);if("function"==typeof body)if("number"==typeof args)for(i=0;i<args;++i)scope.call(this,null,body,i);else{if(!Array.isArray(args))return scope.call(this,args,body,0);for(i=0;i<args.length;++i)scope.call(this,args[i],body,i)}else if("number"==typeof args){if(args>0)return batch.call(this,function(count){for(;EMPTY_ARRAY.length<count;)EMPTY_ARRAY.push(null);return EMPTY_ARRAY}(0|args),0|args)}else{if(!Array.isArray(args))return draw.call(this,args);if(args.length)return batch.call(this,args,args.length)}}),{stats:stats$$1,destroy:function(){compiled.destroy()}})}canvas&&(canvas.addEventListener("webglcontextlost",handleContextLoss,!1),canvas.addEventListener("webglcontextrestored",handleContextRestored,!1));var setFBO=framebufferState.setFBO=compileProcedure({framebuffer:dynamic.define.call(null,1,"framebuffer")});function clearImpl(_,options){var clearFlags=0;core.procs.poll();var c=options.color;c&&(gl.clearColor(+c[0]||0,+c[1]||0,+c[2]||0,+c[3]||0),clearFlags|=16384),"depth"in options&&(gl.clearDepth(+options.depth),clearFlags|=256),"stencil"in options&&(gl.clearStencil(0|options.stencil),clearFlags|=1024),check$1(!!clearFlags,"called regl.clear with no buffer specified"),gl.clear(clearFlags)}function frame(cb){return check$1.type(cb,"function","regl.frame() callback must be a function"),rafCallbacks.push(cb),startRAF(),{cancel:function(){var i=find(rafCallbacks,cb);check$1(i>=0,"cannot cancel a frame twice"),rafCallbacks[i]=function pendingCancel(){var index=find(rafCallbacks,pendingCancel);rafCallbacks[index]=rafCallbacks[rafCallbacks.length-1],rafCallbacks.length-=1,rafCallbacks.length<=0&&stopRAF()}}}}function pollViewport(){var viewport=nextState.viewport,scissorBox=nextState.scissor_box;viewport[0]=viewport[1]=scissorBox[0]=scissorBox[1]=0,contextState.viewportWidth=contextState.framebufferWidth=contextState.drawingBufferWidth=viewport[2]=scissorBox[2]=gl.drawingBufferWidth,contextState.viewportHeight=contextState.framebufferHeight=contextState.drawingBufferHeight=viewport[3]=scissorBox[3]=gl.drawingBufferHeight}function poll(){contextState.tick+=1,contextState.time=now(),pollViewport(),core.procs.poll()}function refresh(){textureState.refresh(),pollViewport(),core.procs.refresh(),timer&&timer.update()}function now(){return(clock()-START_TIME)/1e3}refresh();var regl=extend(compileProcedure,{clear:function(options){if(check$1("object"==typeof options&&options,"regl.clear() takes an object as input"),"framebuffer"in options)if(options.framebuffer&&"framebufferCube"===options.framebuffer_reglType)for(var i=0;i<6;++i)setFBO(extend({framebuffer:options.framebuffer.faces[i]},options),clearImpl);else setFBO(options,clearImpl);else clearImpl(0,options)},prop:dynamic.define.bind(null,1),context:dynamic.define.bind(null,2),this:dynamic.define.bind(null,3),draw:compileProcedure({}),buffer:function(options){return bufferState.create(options,34962,!1,!1)},elements:function(options){return elementState.create(options,!1)},texture:textureState.create2D,cube:textureState.createCube,renderbuffer:renderbufferState.create,framebuffer:framebufferState.create,framebufferCube:framebufferState.createCube,vao:attributeState.createVAO,attributes:glAttributes,frame:frame,on:function(event,callback){var callbacks;switch(check$1.type(callback,"function","listener callback must be a function"),event){case"frame":return frame(callback);case"lost":callbacks=lossCallbacks;break;case"restore":callbacks=restoreCallbacks;break;case"destroy":callbacks=destroyCallbacks;break;default:check$1.raise("invalid event, must be one of frame,lost,restore,destroy")}return callbacks.push(callback),{cancel:function(){for(var i=0;i<callbacks.length;++i)if(callbacks[i]===callback)return callbacks[i]=callbacks[callbacks.length-1],void callbacks.pop()}}},limits:limits,hasExtension:function(name){return limits.extensions.indexOf(name.toLowerCase())>=0},read:readPixels,destroy:function(){rafCallbacks.length=0,stopRAF(),canvas&&(canvas.removeEventListener("webglcontextlost",handleContextLoss),canvas.removeEventListener("webglcontextrestored",handleContextRestored)),shaderState.clear(),framebufferState.clear(),renderbufferState.clear(),attributeState.clear(),textureState.clear(),elementState.clear(),bufferState.clear(),timer&&timer.clear(),destroyCallbacks.forEach((function(cb){cb()}))},_gl:gl,_refresh:refresh,poll:function(){poll(),timer&&timer.update()},now:now,stats:stats$$1});return config.onDone(null,regl),regl}},"object"==typeof exports&&void 0!==module?module.exports=factory():"function"==typeof define&&define.amd?define(factory):global.createREGL=factory()},{}],15:[function(require,module,exports){const tracker=new class{constructor(errorDivID,successMsg,callback=null,successCallback=null){this.hasError=!1,this.message=null,this.successMsg=successMsg,this.target=errorDivID,this.callback=callback,this.successCallback=successCallback}setTarget(errorDivID){this.target=errorDivID}setCallback(callback){this.callback=callback}setSuccessCallback(successCallback){this.successCallback=successCallback}defaultCallback(target){target&&(target.innerText=this.message,target.style.color="red",target.style.display="block")}defaultSuccessCallback(target){target&&(target.innerText=this.message,target.style.color="green",target.style.display="block")}error(message){this.hasError=!0,this.message=message;const target=document.querySelector(`#${this.target}`);null===this.callback?this.defaultCallback(target):this.callback(this.message,target)}clear(){this.hasError=!1,this.message=this.successMsg;const target=document.querySelector(`#${this.target}`);null===this.successCallback?this.defaultCallback(target):this.successCallback(this.message,target)}}(null,"Parsing successful!");module.exports={tracker:tracker}},{}],16:[function(require,module,exports){function clearFractions(text,depth=0){if(depth>9)return console.error("fractions nested too deeply"),"";let letter,buffer,bCount,j,newString="",fracOpen=!1;for(let i=0;i<text.length;i++)if(letter=text[i],i>=4&&"frac"===text.slice(i-4,i)&&(fracOpen=!0),"{"===letter&&fracOpen){for(buffer="",bCount=1,j=i+1;j<text.length;j++){if("{"===text[j])bCount++;else if("}"===text[j]&&(bCount--,0===bCount))break;buffer+=text[j]}i>=4&&"frac"===text.slice(i-4,i)?newString+="(("+clearFractions(buffer,depth+1)+")/":(newString+="("+clearFractions(buffer,depth+1)+"))",fracOpen=!1),i=j}else newString+=letter;return newString.replace(/\\frac/g,"")}module.exports={cleanLatex:function(text){return text=(text=(text=(text=clearFractions(text=(text=text.replace(/\s/g,"")).replace(/\\cdot/g,"*").replace(/\\operatorname{(.*?)}/g,((tot,group1)=>group1)))).replace(/(\\left)|(\\right)/g,"")).replace(/\\/g,"")).replace(/{/g,"(").replace(/}/g,")")}}},{}],17:[function(require,module,exports){const{Parser:Parser}=require("./parser.js"),{InfixParselet:InfixParselet,PrefixParselet:PrefixParselet,AssignParselet:AssignParselet,BinaryOperatorParselet:BinaryOperatorParselet,CallParselet:CallParselet,GroupParselet:GroupParselet,NameParselet:NameParselet,NumberParselet:NumberParselet,PrefixOperatorParselet:PrefixOperatorParselet}=require("./parselets.js"),{TokenType:TokenType}=require("./tokentype.js"),{Precedence:Precedence}=require("./precedence.js");module.exports={ExpressionParser:class extends Parser{constructor(tokens){super(tokens),this.registerPrefix(TokenType.NUMBER,new NumberParselet),this.registerPrefix(TokenType.NAME,new NameParselet),this.registerInfix(TokenType.ASSIGN,new AssignParselet),this.registerPrefix(TokenType.LEFT_PAREN,new GroupParselet),this.registerInfix(TokenType.LEFT_PAREN,new CallParselet),this.prefix(TokenType.PLUS,Precedence.PREFIX),this.prefix(TokenType.MINUS,Precedence.PREFIX),this.infixLeft(TokenType.COLON,Precedence.CALL),this.infixLeft(TokenType.PLUS,Precedence.SUM),this.infixLeft(TokenType.MINUS,Precedence.SUM),this.infixLeft(TokenType.ASTERISK,Precedence.PRODUCT),this.infixLeft(TokenType.SLASH,Precedence.PRODUCT),this.infixRight(TokenType.CARET,Precedence.EXPONENT)}prefix(tokenType,precedence){this.registerPrefix(tokenType,new PrefixOperatorParselet(precedence))}infixLeft(tokenType,precedence){this.registerInfix(tokenType,new BinaryOperatorParselet(precedence,!1))}infixRight(tokenType,precedence){this.registerInfix(tokenType,new BinaryOperatorParselet(precedence,!0))}}}},{"./parselets.js":20,"./parser.js":21,"./precedence.js":22,"./tokentype.js":24}],18:[function(require,module,exports){const{TokenType:TokenType}=require("./tokentype.js");class Expression{}module.exports={Expression:Expression,AssignExpression:class extends Expression{constructor(left,right){super(),this.mLeft=left,this.mRight=right}toString(){return`(${this.mLeft.toString()} = ${this.mRight.toString()})`}},CallExpression:class extends Expression{constructor(func,args){super(),this.mFunction=func,this.mArgs=args}toString(){const args=this.mArgs.join();return`${this.mFunction.toString()}(${args})`}},NameExpression:class extends Expression{constructor(name){super(),this.mName=name}toString(){return this.mName}},NumberExpression:class extends Expression{constructor(number){super(),this.mNumber=number}toString(){return this.mNumber.toString().includes(".")||this.mNumber.toString().includes("e")?this.mNumber.toString():this.mNumber.toFixed(1)}},OperatorExpression:class extends Expression{constructor(left,operator,right){super(),this.mLeft=left,this.mOperator=operator,this.mRight=right}toString(){return`(${this.mLeft.toString()} ${TokenType.toStr(this.mOperator)} ${this.mRight.toString()})`}},PrefixExpression:class extends Expression{constructor(operator,right){super(),this.mOperator=operator,this.mRight=right}toString(){return`(${TokenType.toStr(this.mOperator)}${this.mRight})`}}}},{"./tokentype.js":24}],19:[function(require,module,exports){const{TokenType:TokenType}=require("./tokentype.js"),{Token:Token}=require("./token.js"),{Trie:Trie}=require("../trie.js"),{tracker:tracker}=require("../errors.js"),num="0123456789",alnum="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";module.exports={Lexer:class{constructor(mText,allowUnboundIdentifiers=!1){this.mPunctuators=[],this.mText=mText,this.index=0,this.allowUnboundIdentifiers=allowUnboundIdentifiers,this.setScope({})}setScope(scope){this.scope=scope,this.builtinLookup=new Trie(Object.keys(void 0===scope.builtin?{}:scope.builtin)),this.userGlobalLookup=new Trie(Object.keys(void 0===scope.userGlobal?{}:scope.userGlobal))}setAllowUnboundIdentifiers(allowUnboundIdentifiers){this.allowUnboundIdentifiers=allowUnboundIdentifiers}setText(mText){this.mPunctuators=[],this.mText=mText,this.index=0}getTokenName(tokenizingAssignment=!1,assignmentEncountered=!1){let buffer="";for(;this.index<this.mText.length&&alnum.includes(this.mText[this.index]);)buffer+=this.mText[this.index],this.index++;const identifiers=[];for(;buffer.length>0;){let possibleIdentifier,i,matchFound=!1;for(i=buffer.length-1;i>=0;i--)if(possibleIdentifier=buffer.slice(0,i+1),this.builtinLookup.containsKey(possibleIdentifier)||this.userGlobalLookup.containsKey(possibleIdentifier)){matchFound=!0;break}if(matchFound)identifiers.push(possibleIdentifier),buffer=buffer.slice(i+1,buffer.length);else{if(!alnum.includes(possibleIdentifier[0])||num.includes(possibleIdentifier[0]))return tracker.error("unexpected number following identifier"),void this.kill();if(!(this.allowUnboundIdentifiers||tokenizingAssignment&&(assignmentEncountered&&this.mPunctuators.some((token=>token.mtype===TokenType.NAME&&token.text===possibleIdentifier))||!assignmentEncountered)))return tracker.error(`Undefined identifier ${buffer}`),void this.kill();identifiers.push(buffer),buffer=""}}for(let identifier of identifiers)this.mPunctuators.push(new Token(TokenType.NAME,identifier)),this.mPunctuators.push(new Token(TokenType.ASTERISK,"*"));this.mPunctuators.pop()}getTokenNumber(){let number="",decimalEncounted=!1;for(;this.index<this.mText.length&&(num.includes(this.mText[this.index])||"."===this.mText[this.index]);){if("."===this.mText[this.index]){if(decimalEncounted)return tracker.error("two decimal points encountered in number"),void this.kill();decimalEncounted=!0}number+=this.mText[this.index],this.index++}this.mPunctuators.push(new Token(TokenType.NUMBER,number))}kill(){this.index=this.mText.length}tokenize(){this.mPunctuators=[],this.index=0;const tokenizingAssignment=this.mText.includes("=");let assignmentEncountered=!1;for(;this.index<this.mText.length;){const char=this.mText[this.index];if("("===char)this.mPunctuators.push(new Token(TokenType.LEFT_PAREN,char));else if(")"===char)this.mPunctuators.push(new Token(TokenType.RIGHT_PAREN,char));else if(","===char)this.mPunctuators.push(new Token(TokenType.COMMA,char));else if("="===char)this.mPunctuators.push(new Token(TokenType.ASSIGN,char)),assignmentEncountered=!0;else if("+"===char)this.mPunctuators.push(new Token(TokenType.PLUS,char));else if("-"===char)this.mPunctuators.push(new Token(TokenType.MINUS,char));else if("*"===char)this.mPunctuators.push(new Token(TokenType.ASTERISK,char));else if("/"===char)this.mPunctuators.push(new Token(TokenType.SLASH,char));else if("^"===char)this.mPunctuators.push(new Token(TokenType.CARET,char));else{if(":"!==char){if(num.includes(char)||"."===char){this.getTokenNumber();continue}if(alnum.includes(char)){this.getTokenName(tokenizingAssignment,assignmentEncountered);continue}return tracker.error(`bruh what is this character even doing in your input ${char}`),void this.kill()}this.mPunctuators.push(new Token(TokenType.COLON,char))}this.index++}this.mPunctuators.push(new Token(TokenType.EOF,null));const tokens=this.mPunctuators.length>0?[this.mPunctuators[0]]:[];for(let i=0;i<this.mPunctuators.length-1;i++){const token=this.mPunctuators[i],nextToken=this.mPunctuators[i+1];let needsMultiplication=!1;if(token.mtype===TokenType.NAME&&nextToken.mtype===TokenType.NUMBER)return tracker.error("unexpected number following identifier"),void this.kill();token.mtype===TokenType.NUMBER&&nextToken.mtype===TokenType.NAME||token.mtype===TokenType.NUMBER&&nextToken.mtype===TokenType.LEFT_PAREN||token.mtype===TokenType.RIGHT_PAREN&&nextToken.mtype===TokenType.NUMBER||token.mtype===TokenType.RIGHT_PAREN&&nextToken.mtype===TokenType.NAME||token.mtype===TokenType.RIGHT_PAREN&&nextToken.mtype===TokenType.LEFT_PAREN?needsMultiplication=!0:token.mtype===TokenType.NAME&&nextToken.mtype===TokenType.LEFT_PAREN&&(this.builtinLookup.containsKey(token.text)?needsMultiplication=!this.scope.builtin[token.text].isFunction:this.userGlobalLookup.containsKey(token.text)&&(needsMultiplication=!this.scope.userGlobal[token.text].isFunction)),needsMultiplication&&tokens.push(new Token(TokenType.ASTERISK,"*")),tokens.push(nextToken)}this.mPunctuators=tokens.slice(),this._validateTokens()}_checkIsFunction(token){return!(token.mtype!==TokenType.NAME||!this.scope.builtin[token.text]?.isFunction&&!this.scope.userGlobal[token.text]?.isFunction)}_validateTokens(){let equalCount=0;for(let i=0;i<this.mPunctuators.length-1;i++){const token=this.mPunctuators[i],nextToken=this.mPunctuators[i+1];if(this._checkIsFunction(token)&&nextToken.mtype!==TokenType.LEFT_PAREN)return void tracker.error(`Function call to ${token.text} requires parentheses`);token.mtype===TokenType.ASSIGN&&equalCount++}equalCount>1&&tracker.error("More than one equals sign present in expression")}getTokens(){return this.mPunctuators}}}},{"../errors.js":15,"../trie.js":25,"./token.js":23,"./tokentype.js":24}],20:[function(require,module,exports){const{Precedence:Precedence}=require("./precedence.js"),{TokenType:TokenType}=require("./tokentype.js"),{Expression:Expression,AssignExpression:AssignExpression,CallExpression:CallExpression,NameExpression:NameExpression,NumberExpression:NumberExpression,OperatorExpression:OperatorExpression,PrefixExpression:PrefixExpression}=require("./expressions.js"),{tracker:tracker}=require("../errors.js");class InfixParselet{parse(parser,left,token){}getPrecedence(){}}class PrefixParselet{parse(parser,token){}getPrecedence(){}}module.exports={InfixParselet:InfixParselet,PrefixParselet:PrefixParselet,AssignParselet:class extends InfixParselet{parse(parser,left,token){const right=parser.parseExpression(Precedence.ASSIGNMENT-1);if(left instanceof NameExpression||left instanceof CallExpression)return new AssignExpression(left,right);tracker.error("lhs of assignment should be identifier or function name with arguments")}getPrecedence(){return Precedence.ASSIGNMENT}},BinaryOperatorParselet:class extends InfixParselet{constructor(precedence,mIsRight){super(),this.mPrecedence=precedence,this.mIsRight=mIsRight}parse(parser,left,token){const right=parser.parseExpression(this.mPrecedence-(this.mIsRight?1:0));return new OperatorExpression(left,token.mtype,right)}getPrecedence(){return this.mPrecedence}},CallParselet:class extends InfixParselet{constructor(){super()}parse(parser,left,token){const args=[];if(!parser.peek(TokenType.RIGHT_PAREN))for(;!tracker.hasError;){if(args.push(parser.parseExpression()),parser.peek(TokenType.RIGHT_PAREN)){parser.consume(TokenType.RIGHT_PAREN);break}parser.consume(TokenType.COMMA)}return new CallExpression(left,args)}getPrecedence(){return Precedence.CALL}},GroupParselet:class extends PrefixParselet{parse(parser,token){const expr=parser.parseExpression();return parser.consume(TokenType.RIGHT_PAREN),expr}},NameParselet:class extends PrefixParselet{constructor(){super()}parse(parser,token){return new NameExpression(token.text)}},NumberParselet:class extends PrefixParselet{constructor(){super()}parse(parser,token){const value=parseFloat(token.text);if(!isNaN(value))return new NumberExpression(value);tracker.error(`Invalid number literal ${value}`)}},PrefixOperatorParselet:class extends PrefixParselet{constructor(precedence){super(),this.mPrecedence=precedence}parse(parser,token){const right=parser.parseExpression(this.mPrecedence);return new PrefixExpression(token.mtype,right)}}}},{"../errors.js":15,"./expressions.js":18,"./precedence.js":22,"./tokentype.js":24}],21:[function(require,module,exports){const{tracker:tracker}=require("../errors.js"),{TokenType:TokenType}=require("./tokentype.js"),{Precedence:Precedence}=require("./precedence.js"),{Token:Token}=require("./token.js");module.exports={Parser:class{constructor(tokens){this.mTokens=tokens,this.mPrefixParselets={},this.mInfixParselets={},this.index=0}registerPrefix(tokenType,parselet){this.mPrefixParselets[tokenType]=parselet}registerInfix(tokenType,parselet){this.mInfixParselets[tokenType]=parselet}parseExpression(precedence=Precedence.LOWEST){let token=this.consume();if(tracker.hasError)return;if(!Object.keys(this.mPrefixParselets).includes(token.mtype.toString()))return void(token.mtype===TokenType.EOF?tracker.error("Unexpected EOF while parsing (1)"):tracker.error("Invalid syntax"));let left=this.mPrefixParselets[token.mtype].parse(this,token);if(!tracker.hasError){for(;precedence<this.getPrecedence();)if(token=this.consume(),Object.keys(this.mInfixParselets).includes(token.mtype.toString())&&(left=this.mInfixParselets[token.mtype].parse(this,left,token),tracker.hasError))return;return left}}consume(expected=null){const token=this.lookAhead(0);if(null===expected||token.mtype!==TokenType.EOF){if(null===expected||token.mtype===expected)return this.index++,token;tracker.error("Unexpected EOF while parsing")}else tracker.error("Unexpected EOF while parsing")}lookAhead(distance){return this.index+distance<this.mTokens.length?this.mTokens[this.index+distance]:new Token(TokenType.EOF,null)}peek(expected){return this.lookAhead(0).mtype===expected}getPrecedence(){const currentToken=this.lookAhead(0);return Object.keys(this.mInfixParselets).includes(currentToken.mtype.toString())?this.mInfixParselets[currentToken.mtype].getPrecedence():Precedence.LOWEST}}}},{"../errors.js":15,"./precedence.js":22,"./token.js":23,"./tokentype.js":24}],22:[function(require,module,exports){module.exports={Precedence:class{static LOWEST=0;static ASSIGNMENT=1;static SUM=2;static PRODUCT=3;static EXPONENT=4;static PREFIX=5;static CALL=6}}},{}],23:[function(require,module,exports){module.exports={Token:class{constructor(tokenType,text){this.mtype=tokenType,this.text=text}toString(){return`<${this.mtype}, ${this.text}>`}}}},{}],24:[function(require,module,exports){module.exports={TokenType:class{static LEFT_PAREN=1;static RIGHT_PAREN=2;static COMMA=3;static ASSIGN=4;static PLUS=5;static MINUS=6;static ASTERISK=7;static SLASH=8;static CARET=9;static COLON=10;static NAME=11;static NUMBER=12;static EOF=13;constructor(value){this.value=value}static toStr(tokenType){return["(",")",",","=","+","-","*","/","^",":","","",""][tokenType-1]}}}},{}],25:[function(require,module,exports){class Node{static nodeID=0;constructor(value){this.value=value,this.id=Node.nodeID,Node.nodeID++,this.next=null,this.child=null}setNext(next){this.next=next}setChild(child){this.child=child}hasNext(){return null!==this.next}toString(){return`Node(${this.value})`}}class LinkedList{constructor(valuesArray=null){if(this.head=null,this.size=0,null!==valuesArray)for(let value of valuesArray)this.push(value)}push(value){const newNode=new Node(value);if(null===this.head)this.head=newNode;else{let node=this.head;for(;node.hasNext();)node=node.next;node.setNext(newNode)}return this.size++,newNode}remove(value){if(null===this.head)return!1;if(this.head.value===value)return this.head=this.head.next,this.size--,!0;{let node=this.head;for(;node.hasNext();){if(node.next.value===value)return node.next=node.next.next,this.size--,!0;node=node.next}return!1}}search(value){let node=this.head;for(;null!==node;){if(node.value===value)return node;node=node.next}return null}toString(){if(null===this.head)return"LinkedList([])";{let result="[",node=this.head;for(;null!==node;)result+=node.toString()+", ",node=node.next;return result=result.slice(0,-2)+"]",result}}}class Trie{static TERMINATOR="<end>";constructor(keysArray=null){if(this.root=null,this.maxDepth=0,this.size=0,null!==keysArray)for(let key of keysArray)this.insertKey(key)}insertKey(key){null===this.root&&(this.root=new LinkedList),this.maxDepth=Math.max(this.maxDepth,key.length);let list=this.root;for(let i=0;i<key.length;i++){const character=key[i],node=list.search(character);if(null===node){const newNode=list.push(character);newNode.setChild(new LinkedList),list=newNode.child}else list=node.child;i===key.length-1&&null===list.search(Trie.TERMINATOR)&&(list.push(Trie.TERMINATOR),this.size++)}}containsKey(key){if(null===this.root)return!1;let list=this.root;for(let character of key){const node=list.search(character);if(null===node)return!1;list=node.child}return null!==list.search(Trie.TERMINATOR)}containsPrefix(prefix){if(null===this.root)return!1;let list=this.root;for(let character of prefix){const node=list.search(character);if(null===node)return!1;list=node.child}return!0}remove(key){if(null===this.root)return!1;let list=this.root;for(let character of key){const node=list.search(character);if(null===node)return!1;list=node.child}const removalResult=list.remove(Trie.TERMINATOR);return removalResult&&this.size--,removalResult}prefixSearch(prefix,maxResults=100){if(null===this.root||""===prefix)return[];let node,list=this.root;for(let character of prefix){if(node=list.search(character),null===node)return[];list=node.child}const results=[];null!==list.search(Trie.TERMINATOR)&&results.push(prefix);const queue=[{node:list.head,suffix:""}];let current;for(;results.length<maxResults&&queue.length>0;){current=queue.pop();let currentNode=current.node,currentSuffix=current.suffix;for(;null!==currentNode;){if(currentNode.value===Trie.TERMINATOR){currentNode=currentNode.next;continue}if(null!==currentNode.child.search(Trie.TERMINATOR)&&results.push(prefix+currentSuffix+currentNode.value),queue.unshift({node:currentNode.child.head,suffix:currentSuffix+currentNode.value}),currentNode=currentNode.next,results.length===maxResults)break}}return results}}module.exports={Node:Node,LinkedList:LinkedList,Trie:Trie}},{}]},{},[5]);